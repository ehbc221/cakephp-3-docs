

<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta content="Pour Commencer" lang="fr" name="title" />
<meta content="structure de dossier,noms de table,requête initiale,table base de données,structure organisationnel,rst,noms de fichier,conventions,mvc,page web,sit" lang="fr" name="keywords" />

    <title>Guide de Démarrage Rapide - 3.x</title>
    <link href="_static/favicon.png" type="image/png" rel="icon" />

    
    <link rel="stylesheet" href="_static/css/app.css" type="text/css" />
    
    <script type="text/javascript" src="_static/app.js"></script>

    <link rel="alternate" hreflang="en" href="../en/quickstart.html" /><link rel="alternate" hreflang="pt_BR" href="../pt/quickstart.html" /><link rel="alternate" hreflang="es" href="../es/quickstart.html" /><link rel="alternate" hreflang="ja" href="../ja/quickstart.html" /><link rel="alternate" hreflang="zh" href="../zh/quickstart.html" /><link rel="alternate" hreflang="tr" href="../tr/quickstart.html" /><link rel="alternate" hreflang="ru" href="../ru/quickstart.html" />

    <link rel="search" type="application/opensearchdescription+xml" title="Search within documentation CakePHP Cookbook 3.5" href="_static/opensearchdescription-book-3-x.xml">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="top" title="documentation CakePHP Cookbook 3.5" href="index.html" />
    <link rel="next" title="3.x Guide de Migration" href="appendices/3-x-migration-guide.html" />
    <link rel="prev" title="Structure du dossier de CakePHP" href="intro/cakephp-folder-structure.html" />

    <script type="text/javascript">
    window.lang = "fr";
    </script>
  </head>
  <body>

<div id="container">
    
    <header class="nav-down">
        <div class="container-fluid hidden-xs hidden-sm">
            <div class="row">
                <div class="col-sm-3 col-md-3">
                    <a class="logo-cake" href="https://cakephp.org">
                        <img src="_static/logo-cake.png" alt="CakePHP" />
                    </a>
                </div>

                <div class="col-sm-9 col-md-9">
                    <nav class="navbar-right">
                        <ul class="menu">
                            <li class="first">
                                <a href="#"><i class="fa fa-menu fa-chevron-down"></i>Documentation</a>
                                <ul class="submenu">
                                    
<li><a href="https://book.cakephp.org"><i class="fa fa-menu fa-chevron-right"></i>Book</a></li>
<li><a href="https://api.cakephp.org"><i class="fa fa-menu fa-chevron-right"></i>API</a></li>

<li><a href="https://cakephp.org/documentation/videos"><i class="fa fa-menu fa-chevron-right"></i>Videos</a></li>
<li><a href="https://cakephp.org/privacy"><i class="fa fa-menu fa-chevron-right"></i>Privacy Policy</a></li>
<li><a href="https://cakephp.org/pages/trademark"><i class="fa fa-menu fa-chevron-right"></i>Logos &amp; Trademarks</a></li>
                                </ul>
                            </li>

                            <li><a href="https://cakephp.org/business-solutions">Business Solutions</a></li>
                            <li><a href="https://cakephp.org/writers">Get Paid To Write</a></li>
                            <li><a href="https://cakephp.org/pages/team">Team</a></li>

                            <li>
                                <a href="#"><i class="fa fa-menu fa-chevron-down"></i>Community</a>
                                <div class="megamenu full">
                                    <div class="row">
                                        <div class="col-6 pl30">
                                            <ul class="megamenu-list">
                                                
<li class="menu-title"><i class="fa fa-menu-title fa-users"></i>Community</li>

<li><a href="https://cakephp.org/team"><i class="fa fa-menu fa-chevron-right"></i>Team</a></li>
<li><a href="https://github.com/cakephp/cakephp/issues"><i class="fa fa-menu fa-chevron-right"></i>Issues (Github)</a></li>
<li><a href="https://www.youtube.com/user/CakePHP"><i class="fa fa-menu fa-chevron-right"></i>YouTube Channel</a></li>
<li><a href="https://cakephp.org/get-involved"><i class="fa fa-menu fa-chevron-right"></i>Get Involved</a></li>

<li><a href="https://bakery.cakephp.org"><i class="fa fa-menu fa-chevron-right"></i>Bakery</a></li>
<li><a href="https://github.com/FriendsOfCake/awesome-cakephp"><i class="fa fa-menu fa-chevron-right"></i>Featured Resources</a></li>
<li><a href="https://cakephp.org/newsletter/signup"><i class="fa fa-menu fa-chevron-right"></i>Newsletter</a></li>
<li><a href="http://certification.cakephp.org"><i class="fa fa-menu fa-chevron-right"></i>Certification</a></li>
<li><a href="http://my.cakephp.org"><i class="fa fa-menu fa-chevron-right"></i>My CakePHP</a></li>
<li><a href="http://cakefest.org"><i class="fa fa-menu fa-chevron-right"></i>CakeFest</a></li>
<li><a href="https://www.facebook.com/groups/cake.community"><i class="fa fa-menu fa-chevron-right"></i>Facebook</a></li>
<li><a href="https://twitter.com/cakephp"><i class="fa fa-menu fa-chevron-right"></i>Twitter</a></li>
                                            </ul>
                                        </div>
                                        <div class="col-6 pl30">
                                            <ul class="megamenu-list">
                                                
<li class="menu-title"><i class="fa fa-menu-title fa-comments-o"></i>Help &amp; Support</li>

<li><a href="http://discourse.cakephp.org"><i class="fa fa-menu fa-chevron-right"></i>Forum</a></li>
<li><a href="https://stackoverflow.com/tags/cakephp"><i class="fa fa-menu fa-chevron-right"></i>Stack Overflow</a></li>
<li><a href="https://webchat.freenode.net/?channels=cakephp"><i class="fa fa-menu fa-chevron-right"></i>IRC</a></li>
<li><a href="https://cakesf.herokuapp.com/"><i class="fa fa-menu fa-chevron-right"></i>Slack</a></li>
<li><a href="https://www.cakedc.com/"><i class="fa fa-menu fa-chevron-right"></i>Paid Support</a></li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </li>
                        </ul>
                    </nav>
                </div>
            </div>
        </div>

        
        <div class="container-fluid hidden-md hidden-lg">
            <div class="row">
                <div class="col-sm-6 col-xs-6">
                    <a class="logo-cake" href="https://cakephp.org">
                        <img src="_static/logo-cake.png" alt="CakePHP" />
                    </a>
                </div>

                <div class="col-sm-6 col-xs-6">
                    <div class="navbar-right">
                        <button id="btn-menu" class="btn-menu" data-toggle="modal" data-target="#modal">
                            <i class="fa fa-bars toggle-modal"></i>
                        </button>
                    </div>
                    <div id="wrap">
                        <form class="search" action="search.html" method="get">
                            <input name="q" type="search" placeholder="What are you looking for?">
                            <input id="search_submit" value="Recherche" type="submit">
                        </form>
                    </div>
                </div>
            </div>
        </div>

        
        <section id="nav-cook" class="hidden-xs hidden-sm">
            <div class="container-fluid ">
                <div class="row ">
                    <div class="col-md-12 back-book">
                        <div class="col-md-5 text-center t-cook-nav p0 hidden-sm hidden-xs">
                            <h2>
                                <a href="contents.html">
                                    <span class="glyph_range icon-submenu icon-submenu-cook">B</span>
                                    CakePHP 3.5 Red Velvet <strong>Cookbook</strong>
                                </a>
                            </h2>
                        </div>

                        <div class="col-md-4 hidden-sm">
                            <form class="search" action="search.html" method="get">
                                <input type="hidden" name="check_keywords" value="yes" />
                                <input type="hidden" name="area" value="default" />

                                <div class="col-md-10 p0">
                                    <input class="form-control form-cook" autocomplete="off" type="search" name="q" size="18" placeholder='Cookbook Search' />
                                </div>
                                <div class="col-md-2 p0 search-cook">
                                    <button type="submit">
                                        <span class="glyph_range icon-submenu icon-submenu-cook">A</span>
                                    </button>
                                </div>
                            </form>
                        </div>

                        
                        <div class="col-md-3">
                            <div class="col-md-6 p0">
                                <div class="col-md-7 t-language p0">
                                    <h6>Language:</h6>
                                </div>
                                <div class="col-md-5 p0">
                                    <ul class="nav navbar-nav">
                                        <li class="dropdown">
                                            <a class="dropdown-toggle" data-hover="dropdown" data-toggle="dropdown"
                                                    role="button" aria-haspopup="true" aria-expanded="false" href="#">
                                                        fr
                                                        <i class="fa fa-menu-en fa-chevron-down"></i>
                                                    </a>
                                            <ul class="dropdown-menu">
                                            
                                                <li><a href="../en/quickstart.html">en</a></li>
                                            
                                                <li><a href="../pt/quickstart.html">pt</a></li>
                                            
                                                <li><a href="../es/quickstart.html">es</a></li>
                                            
                                                <li><a href="../ja/quickstart.html">ja</a></li>
                                            
                                                <li></li>
                                            
                                                <li><a href="../zh/quickstart.html">zh</a></li>
                                            
                                                <li><a href="../tr/quickstart.html">tr</a></li>
                                            
                                                <li><a href="../ru/quickstart.html">ru</a></li>
                                            
                                            </ul>
                                        </li>
                                    </ul>
                                </div>
                            </div>

                            <div class="col-md-6 p0">
                                <div class="col-md-7 t-language p0">
                                    <h6>Version:</h6>
                                </div>
                                <div class="col-md-5 p0">
                                    <ul class="nav navbar-nav">
                                        <li class="dropdown">
                                            <a href="#" class="dropdown-toggle" data-hover="dropdown" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">3.x <i class="fa fa-menu-en fa-chevron-down"></i></a>
                                            <ul class="dropdown-menu">
                                                <li><a href="https://book.cakephp.org/3.0/fr">3.x Book</a></li>
                                                <li><a href="https://book.cakephp.org/2.0/fr">2.x Book</a></li>
                                                <li><a href="https://book.cakephp.org/1.3/fr/">1.3 Book</a></li>
                                                <li><a href="https://book.cakephp.org/1.2/fr/">1.2 Book</a></li>
                                                <li><a href="https://book.cakephp.org/1.1/en">1.1 Book</a></li>
                                            </ul>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
            
        </section>
    </header>

    
    <section class="nav-btn visible-sm visible-xs">
        <div class="container">
            <div class="row">
                <div class="col-sm-6 col-xs-6 text-center">
                    <button id="btn-nav" class="btn btn-b btn-nav" data-toggle="modal" data-target="#modal"><strong>Nav</strong></button>
                </div>

                <div class="col-sm-6 col-xs-6 text-center">
                    <button id="btn-toc" class="btn btn-b btn-nav" data-toggle="modal" data-target="#modal"><strong>Table of Contents</strong></button>
                </div>
            </div>
        </div>
    </section>

    
    <div id="modal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="modal-header">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                    <h4 class="modal-title-cookbook" id="modal-header"></h4>
                </div>
                <div class="modal-body"></div>
            </div>
        </div>
    </div>

<div class="container page-container "><div id="improve-slideout">
        <i class="fa fa-pencil icon-improve"></i>
        <a href="https://github.com/cakephp/docs/edit/3.0/fr/quickstart.rst" target="_blank">
            <div id="improve-slideout-inner"><h6>Improve This Doc <i class="fa fa-github git-improve"></i></h6></div>
        </a>
    </div><a id="back-to-contents" href="#page-contents"><i class="fa fa-arrow-circle-up icon-improve" title="Back to Contents"></i></a>

    
    <div class="row">
        <div class="col-sm-12 col-md-9 col-md-push-3"><div class="page-contents col-sm-5">
                <h3>Page Contents</h3>
                <ul>
<li><a class="reference internal" href="#">Guide de Démarrage Rapide</a><ul>
<li><a class="reference internal" href="#tutoriel-de-bookmarker">Tutoriel de Bookmarker</a><ul>
<li><a class="reference internal" href="#recuperer-cakephp">Récupérer CakePHP</a></li>
<li><a class="reference internal" href="#verifions-notre-installation">Vérifions notre Installation</a></li>
<li><a class="reference internal" href="#creer-la-base-de-donnees">Créer la Base de Données</a></li>
<li><a class="reference internal" href="#configuration-de-base-de-donnees">Configuration de Base de Données</a></li>
<li><a class="reference internal" href="#generation-de-code-scaffold">Génération de Code Scaffold</a></li>
<li><a class="reference internal" href="#ajouter-un-hashage-de-mot-de-passe">Ajouter un Hashage de Mot de Passe</a></li>
<li><a class="reference internal" href="#recuperer-les-bookmarks-avec-un-tag-specifique">Récupérer les Bookmarks avec un Tag Spécifique</a><ul>
<li><a class="reference internal" href="#creer-la-methode-finder">Créer la Méthode Finder</a></li>
<li><a class="reference internal" href="#creer-la-vue">Créer la Vue</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#tutoriel-de-bookmarker-part-2">Tutoriel de Bookmarker Part 2</a><ul>
<li><a class="reference internal" href="#ajouter-la-connexion">Ajouter la Connexion</a></li>
<li><a class="reference internal" href="#ajouter-la-deconnexion">Ajouter la Déconnexion</a></li>
<li><a class="reference internal" href="#permettre-de-s-enregistrer">Permettre de s&#8217;Enregistrer</a></li>
<li><a class="reference internal" href="#restreindre-l-acces-aux-bookmarks">Restreindre l&#8217;Accès aux Bookmarks</a></li>
<li><a class="reference internal" href="#regler-la-vue-de-liste-et-les-formulaires">Régler la Vue de Liste et les Formulaires</a><ul>
<li><a class="reference internal" href="#vue-de-liste">Vue de Liste</a></li>
</ul>
</li>
<li><a class="reference internal" href="#ameliorer-l-experience-de-tag">Améliorer l&#8217;Experience de Tag</a><ul>
<li><a class="reference internal" href="#ajouter-un-champ-computed">Ajouter un Champ Computed</a></li>
<li><a class="reference internal" href="#mettre-a-jour-les-vues">Mettre à Jour les Vues</a></li>
<li><a class="reference internal" href="#persister-la-chaine-tag">Persister la Chaîne Tag</a></li>
</ul>
</li>
<li><a class="reference internal" href="#recapitulatif">Récapitulatif</a></li>
</ul>
</li>
</ul>
</li>
</ul>

            </div><div class="document-body">
            
  <div class="section" id="guide-de-demarrage-rapide">
<h1>Guide de Démarrage Rapide<a class="headerlink" href="#guide-de-demarrage-rapide" title="Lien permanent vers ce titre">¶</a></h1>
<p>Le meilleur moyen de tester et d&#8217;apprendre CakePHP est de s&#8217;assoir et de
construire une application simple de bookmarks.</p>
<div class="section" id="tutoriel-de-bookmarker">
<h2>Tutoriel de Bookmarker<a class="headerlink" href="#tutoriel-de-bookmarker" title="Lien permanent vers ce titre">¶</a></h2>
<p>Ce tutoriel va vous montrer la création d&#8217;une application simple
de bookmarking (bookmarker). Pour commencer, nous allons installer CakePHP,
créer notre base de données et utiliser les outils que CakePHP nous fournit pour
créer une application rapidement.</p>
<p>Voici ce dont vous allez avoir besoin:</p>
<ol class="arabic simple">
<li>Un serveur de base de données. Nous allons utiliser un serveur MySQL dans
ce tutoriel. Vous devrez en savoir assez sur SQL pour créer une base de
données: CakePHP prendra les rênes à partir de là. Puisque nous utilisons
MySQL, assurez-vous aussi d&#8217;avoir <code class="docutils literal"><span class="pre">pdo_mysql</span></code> activé dans PHP.</li>
<li>Des connaissances de base en PHP.</li>
</ol>
<p>Avant de commencer, vous devez vous assurer que votre version de PHP est à jour:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>php -v
</pre></div>
</div>
<p>Vous devez avoir installé au moins la version 5.6.0 (CLI) de PHP ou supérieure.
La version de PHP de votre serveur web doit aussi être 5.6.0 ou supérieure, et
doit être préférablement la même version que celle de votre interface en ligne
de commande (CLI).
Si vous souhaitez voir ce que donne l&#8217;application au final, regardez
<a class="reference external" href="https://github.com/cakephp/bookmarker-tutorial">cakephp/bookmarker</a>. C&#8217;est
parti !</p>
<div class="section" id="recuperer-cakephp">
<h3>Récupérer CakePHP<a class="headerlink" href="#recuperer-cakephp" title="Lien permanent vers ce titre">¶</a></h3>
<p>La façon la plus simple pour installer CakePHP est d&#8217;utiliser Composer. Composer
est un moyen simple d&#8217;installer CakePHP depuis votre terminal ou votre
prompteur de ligne de commandes. D&#8217;abord, vous aurez besoin de télécharger et
d&#8217;installer Composer si vous ne l&#8217;avez pas déjà fait. Si vous avez cURL
installé, c&#8217;est aussi facile que de lancer ce qui suit:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="nx">curl</span> <span class="o">-</span><span class="nx">s</span> <span class="nx">https</span><span class="o">://</span><span class="nx">getcomposer</span><span class="o">.</span><span class="nx">org</span><span class="o">/</span><span class="nx">installer</span> <span class="o">|</span> <span class="nx">php</span>
</pre></div>
</div>
<p>Ou alors vous pouvez télécharger <code class="docutils literal"><span class="pre">composer.phar</span></code> depuis le
<a class="reference external" href="https://getcomposer.org/download/">site de Composer</a>.</p>
<p>Ensuite tapez simplement la ligne suivante dans votre terminal à partir
du répertoire d&#8217;installation pour installer le squelette d&#8217;application
CakePHP dans le répertoire <strong>bookmarker</strong>:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="nx">php</span> <span class="nx">composer</span><span class="o">.</span><span class="nx">phar</span> <span class="nx">create</span><span class="o">-</span><span class="nx">project</span> <span class="o">--</span><span class="nx">prefer</span><span class="o">-</span><span class="nx">dist</span> <span class="nx">cakephp</span><span class="o">/</span><span class="nx">app</span> <span class="nx">bookmarker</span>
</pre></div>
</div>
<p>Si vous avez téléchargé et exécuté l&#8217;<a class="reference external" href="https://getcomposer.org/Composer-Setup.exe">installeur Windows de Composer</a>, tapez la ligne suivante dans
votre terminal à partir de votre répertoire d&#8217;installation. (par exemple
C:\wamp\www\dev\cakephp3):</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="nx">composer</span> <span class="nx">self</span><span class="o">-</span><span class="nx">update</span> <span class="o">&amp;&amp;</span> <span class="nx">composer</span> <span class="nx">create</span><span class="o">-</span><span class="nx">project</span> <span class="o">--</span><span class="nx">prefer</span><span class="o">-</span><span class="nx">dist</span> <span class="nx">cakephp</span><span class="o">/</span><span class="nx">app</span> <span class="nx">bookmarker</span>
</pre></div>
</div>
<p>L&#8217;avantage d&#8217;utiliser Composer est qu&#8217;il va automatiquement faire des tâches
de configuration importantes, comme de définir les bonnes permissions de
fichier et créer votre fichier <strong>config/app.php</strong> pour vous.</p>
<p>Il y a d&#8217;autres façons d&#8217;installer CakePHP. Si vous ne pouvez ou ne voulez pas
utiliser Composer, consultez la section <a class="reference internal" href="installation.html"><span class="doc">Installation</span></a>.</p>
<p>Peu importe la façon dont vous avez téléchargé et installé CakePHP, une fois
que votre configuration est faite, votre répertoire devrait ressembler à
ce qui suit:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="o">/</span><span class="nx">bookmarker</span>
    <span class="o">/</span><span class="nx">bin</span>
    <span class="o">/</span><span class="nx">config</span>
    <span class="o">/</span><span class="nx">logs</span>
    <span class="o">/</span><span class="nx">plugins</span>
    <span class="o">/</span><span class="nx">src</span>
    <span class="o">/</span><span class="nx">tests</span>
    <span class="o">/</span><span class="nx">tmp</span>
    <span class="o">/</span><span class="nx">vendor</span>
    <span class="o">/</span><span class="nx">webroot</span>
    <span class="o">.</span><span class="nx">editorconfig</span>
    <span class="o">.</span><span class="nx">gitignore</span>
    <span class="o">.</span><span class="nx">htaccess</span>
    <span class="o">.</span><span class="nx">travis</span><span class="o">.</span><span class="nx">yml</span>
    <span class="nx">composer</span><span class="o">.</span><span class="nx">json</span>
    <span class="nx">index</span><span class="o">.</span><span class="nx">php</span>
    <span class="nx">phpunit</span><span class="o">.</span><span class="nx">xml</span><span class="o">.</span><span class="nx">dist</span>
    <span class="nx">README</span><span class="o">.</span><span class="nx">md</span>
</pre></div>
</div>
<p>C&#8217;est le bon moment pour en apprendre un peu plus sur la façon dont la
structure du répertoire de CakePHP fonctionne. Consultez la section
<a class="reference internal" href="intro/cakephp-folder-structure.html"><span class="doc">Structure du dossier de CakePHP</span></a>.</p>
</div>
<div class="section" id="verifions-notre-installation">
<h3>Vérifions notre Installation<a class="headerlink" href="#verifions-notre-installation" title="Lien permanent vers ce titre">¶</a></h3>
<p>Nous pouvons rapidement vérifier que notre installation fonctionne, en
vérifiant la page d&#8217;accueil par défaut. Avant de faire ceci, vous devrez
démarrer le serveur de développement:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="nx">bin</span><span class="o">/</span><span class="nx">cake</span> <span class="nx">server</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Sur Windows, cette commande doit être <code class="docutils literal"><span class="pre">bin\cake</span> <span class="pre">server</span></code> (notez l&#8217;antislash).</p>
</div>
<p>Ceci va lancer le serveur web intégré de PHP sur le port 8765. Ouvrez
<strong>http://localhost:8765</strong> dans votre navigateur web pour voir la page d&#8217;accueil.
Tous les points devront être cochés sauf pour CakePHP qui n&#8217;est pas encore
capable de se connecter à votre base de données. Si ce n&#8217;est pas le cas, vous
devrez installer des extensions PHP supplémentaires ou définir des permissions
de répertoire.</p>
</div>
<div class="section" id="creer-la-base-de-donnees">
<h3>Créer la Base de Données<a class="headerlink" href="#creer-la-base-de-donnees" title="Lien permanent vers ce titre">¶</a></h3>
<p>Ensuite, configurons la base de données pour notre application de bookmarking.
Si vous ne l&#8217;avez pas déjà fait, créez une base de données vide que nous
allons utiliser dans ce tutoriel, avec un nom de votre choix, par exemple
<code class="docutils literal"><span class="pre">cake_bookmarks</span></code>. Vous pouvez exécuter le SQL suivant pour créer les
tables nécessaires:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="nx">CREATE</span> <span class="nx">TABLE</span> <span class="nx">users</span> <span class="p">(</span>
    <span class="nx">id</span> <span class="nx">INT</span> <span class="nx">AUTO_INCREMENT</span> <span class="nx">PRIMARY</span> <span class="nx">KEY</span><span class="p">,</span>
    <span class="nx">email</span> <span class="nx">VARCHAR</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="nx">password</span> <span class="nx">VARCHAR</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="nx">created</span> <span class="nx">DATETIME</span><span class="p">,</span>
    <span class="nx">modified</span> <span class="nx">DATETIME</span>
<span class="p">);</span>

<span class="nx">CREATE</span> <span class="nx">TABLE</span> <span class="nx">bookmarks</span> <span class="p">(</span>
    <span class="nx">id</span> <span class="nx">INT</span> <span class="nx">AUTO_INCREMENT</span> <span class="nx">PRIMARY</span> <span class="nx">KEY</span><span class="p">,</span>
    <span class="nx">user_id</span> <span class="nx">INT</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="nx">title</span> <span class="nx">VARCHAR</span><span class="p">(</span><span class="mi">50</span><span class="p">),</span>
    <span class="nx">description</span> <span class="nx">TEXT</span><span class="p">,</span>
    <span class="nx">url</span> <span class="nx">TEXT</span><span class="p">,</span>
    <span class="nx">created</span> <span class="nx">DATETIME</span><span class="p">,</span>
    <span class="nx">modified</span> <span class="nx">DATETIME</span><span class="p">,</span>
    <span class="nx">FOREIGN</span> <span class="nx">KEY</span> <span class="nx">user_key</span> <span class="p">(</span><span class="nx">user_id</span><span class="p">)</span> <span class="nx">REFERENCES</span> <span class="nx">users</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span>
<span class="p">);</span>

<span class="nx">CREATE</span> <span class="nx">TABLE</span> <span class="nx">tags</span> <span class="p">(</span>
    <span class="nx">id</span> <span class="nx">INT</span> <span class="nx">AUTO_INCREMENT</span> <span class="nx">PRIMARY</span> <span class="nx">KEY</span><span class="p">,</span>
    <span class="nx">title</span> <span class="nx">VARCHAR</span><span class="p">(</span><span class="mi">255</span><span class="p">),</span>
    <span class="nx">created</span> <span class="nx">DATETIME</span><span class="p">,</span>
    <span class="nx">modified</span> <span class="nx">DATETIME</span><span class="p">,</span>
    <span class="nx">UNIQUE</span> <span class="nx">KEY</span> <span class="p">(</span><span class="nx">title</span><span class="p">)</span>
<span class="p">);</span>

<span class="nx">CREATE</span> <span class="nx">TABLE</span> <span class="nx">bookmarks_tags</span> <span class="p">(</span>
    <span class="nx">bookmark_id</span> <span class="nx">INT</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="nx">tag_id</span> <span class="nx">INT</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="nx">PRIMARY</span> <span class="nx">KEY</span> <span class="p">(</span><span class="nx">bookmark_id</span><span class="p">,</span> <span class="nx">tag_id</span><span class="p">),</span>
    <span class="nx">FOREIGN</span> <span class="nx">KEY</span> <span class="nx">tag_key</span><span class="p">(</span><span class="nx">tag_id</span><span class="p">)</span> <span class="nx">REFERENCES</span> <span class="nx">tags</span><span class="p">(</span><span class="nx">id</span><span class="p">),</span>
    <span class="nx">FOREIGN</span> <span class="nx">KEY</span> <span class="nx">bookmark_key</span><span class="p">(</span><span class="nx">bookmark_id</span><span class="p">)</span> <span class="nx">REFERENCES</span> <span class="nx">bookmarks</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span>
<span class="p">);</span>
</pre></div>
</div>
<p>Vous avez peut-être remarqué que la table <code class="docutils literal"><span class="pre">bookmarks_tags</span></code> utilisait une
clé primaire composite. CakePHP accepte les clés primaires composites presque
partout, facilitant la construction des applications à tenant multiples.</p>
<p>La table et les noms de colonnes que nous avons utilisés n&#8217;étaient pas
arbitraires. En utilisant les
<a class="reference internal" href="intro/conventions.html"><span class="doc">conventions de nommage</span></a> de CakePHP, nous pouvons
mieux contrôler CakePHP et éviter d&#8217;avoir à configurer le framework. CakePHP est
assez flexible pour s&#8217;accommoder de tout schéma de base de données, mais
suivre les conventions va vous faire gagner du temps.</p>
</div>
<div class="section" id="configuration-de-base-de-donnees">
<h3>Configuration de Base de Données<a class="headerlink" href="#configuration-de-base-de-donnees" title="Lien permanent vers ce titre">¶</a></h3>
<p>Ensuite, indiquons à CakePHP où se trouve notre base de données et comment
s&#8217;y connecter.
Pour la plupart d&#8217;entre vous, ce sera la première et la dernière fois que vous
devrez configurer quelque chose.</p>
<p>La configuration est assez simple: remplacez juste les valeurs dans le
tableau <code class="docutils literal"><span class="pre">Datasources.default</span></code> dans le fichier <strong>config/app.php</strong> avec
ceux qui correspondent à votre configuration. Un exemple simple de tableau
de configuration pourrait ressembler à ce qui suit:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="k">return</span> <span class="p">[</span>
    <span class="c1">// Plus de configuration au-dessus.</span>
    <span class="s1">&#39;Datasources&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span>
        <span class="s1">&#39;default&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span>
            <span class="s1">&#39;className&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Cake\Database\Connection&#39;</span><span class="p">,</span>
            <span class="s1">&#39;driver&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Cake\Database\Driver\Mysql&#39;</span><span class="p">,</span>
            <span class="s1">&#39;persistent&#39;</span> <span class="o">=&gt;</span> <span class="k">false</span><span class="p">,</span>
            <span class="s1">&#39;host&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;localhost&#39;</span><span class="p">,</span>
            <span class="s1">&#39;username&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;cakephp&#39;</span><span class="p">,</span>
            <span class="s1">&#39;password&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;AngelF00dC4k3~&#39;</span><span class="p">,</span>
            <span class="s1">&#39;database&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;cake_bookmarks&#39;</span><span class="p">,</span>
            <span class="s1">&#39;encoding&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;utf8&#39;</span><span class="p">,</span>
            <span class="s1">&#39;timezone&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;UTC&#39;</span><span class="p">,</span>
            <span class="s1">&#39;cacheMetadata&#39;</span> <span class="o">=&gt;</span> <span class="k">true</span><span class="p">,</span>
        <span class="p">],</span>
    <span class="p">],</span>
    <span class="c1">// Plus de configuration en dessous.</span>
<span class="p">];</span>
</pre></div>
</div>
<p>Une fois que vous avez sauvegardé votre fichier <strong>config/app.php</strong>, vous
devriez voir la section &#8216;CakePHP est capable de se connecter à la base de
données&#8217; cochée.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Une copie du fichier de configuration par défaut de CakePHP se trouve dans
<strong>config/app.default.php</strong>.</p>
</div>
</div>
<div class="section" id="generation-de-code-scaffold">
<h3>Génération de Code Scaffold<a class="headerlink" href="#generation-de-code-scaffold" title="Lien permanent vers ce titre">¶</a></h3>
<p>Comme notre base de données suit les conventions de CakePHP, nous pouvons
utiliser l&#8217;application de
<a class="reference internal" href="bake/usage.html"><span class="doc">console bake</span></a> pour
générer rapidement une application basique. Dans votre terminal, lancez
les commandes suivantes:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="c1">// Sur Windows vous devez utiliser bin\cake à la place.</span>
<span class="nx">bin</span><span class="o">/</span><span class="nx">cake</span> <span class="nx">bake</span> <span class="nx">all</span> <span class="nx">users</span>
<span class="nx">bin</span><span class="o">/</span><span class="nx">cake</span> <span class="nx">bake</span> <span class="nx">all</span> <span class="nx">bookmarks</span>
<span class="nx">bin</span><span class="o">/</span><span class="nx">cake</span> <span class="nx">bake</span> <span class="nx">all</span> <span class="nx">tags</span>
</pre></div>
</div>
<p>Ceci va générer les controllers, models, views, leurs cas de tests
correspondants et les fixtures pour nos ressources users, bookmarks et tags.
Si vous avez stoppé votre serveur, relancez-le et allez sur
<strong>http://localhost:8765/bookmarks</strong>.</p>
<p>Vous devriez voir une application basique mais fonctionnelle fournissant
des accès aux données vers les tables de la base de données de votre
application. Une fois que vous avez la liste des bookmarks, ajoutez quelques
users, bookmarks, et tags.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Si vous avez une page Not Found (404), vérifiez que le module mod_rewrite
d&#8217;Apache est chargé.</p>
</div>
</div>
<div class="section" id="ajouter-un-hashage-de-mot-de-passe">
<h3>Ajouter un Hashage de Mot de Passe<a class="headerlink" href="#ajouter-un-hashage-de-mot-de-passe" title="Lien permanent vers ce titre">¶</a></h3>
<p>Quand vous avez créé vos users, (en visitant
<strong>http://localhost:8765/users</strong>) vous avez probablement remarqué que
les mots de passe sont stockés en clair. C&#8217;est très mauvais d&#8217;un point du vue
sécurité, donc réglons ceci.</p>
<p>C&#8217;est aussi un bon moment pour parler de la couche model dans CakePHP. Dans
CakePHP, nous séparons les méthodes qui agissent sur une collection d&#8217;objets, et
celles qui agissent sur un objet unique, dans des classes différentes. Les
méthodes qui agissent sur la collection des entities sont mises dans la classe
<code class="docutils literal"><span class="pre">Table</span></code>, alors que les fonctionnalités correspondant à un enregistrement
unique sont mises dans la classe <code class="docutils literal"><span class="pre">Entity</span></code>.</p>
<p>Par exemple, le hashage des mots de passe se fait pour un enregistrement
individuel, donc nous allons intégrer ce comportement sur l&#8217;objet entity.
Comme nous voulons hasher le mot de passe à chaque fois qu&#8217;il est défini nous
allons utiliser une méthode mutateur/setter. CakePHP va appeler les méthodes
setter basées sur les conventions à chaque fois qu&#8217;une propriété est définie
dans une de vos entities. Ajoutons un setter pour le mot de passe. Dans
<strong>src/Model/Entity/User.php</strong>, ajoutez ce qui suit:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="k">namespace</span> <span class="nx">App\Model\Entity</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">Cake\Auth\DefaultPasswordHasher</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Cake\ORM\Entity</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">User</span> <span class="k">extends</span> <span class="nx">Entity</span>
<span class="p">{</span>

    <span class="c1">// Code from bake.</span>

    <span class="k">protected</span> <span class="k">function</span> <span class="nf">_setPassword</span><span class="p">(</span><span class="nv">$value</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$hasher</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">DefaultPasswordHasher</span><span class="p">();</span>
        <span class="k">return</span> <span class="nv">$hasher</span><span class="o">-&gt;</span><span class="na">hash</span><span class="p">(</span><span class="nv">$value</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Maintenant mettez à jour un des users que vous avez créé précédemment, si vous
changez son mot de passe, vous devriez voir un mot de passe hashé à la place de
la valeur originale sur la liste ou les pages de vue. CakePHP hashe les mots de
passe avec
<a class="reference external" href="http://codahale.com/how-to-safely-store-a-password/">bcrypt</a> par défaut.
Vous pouvez aussi utiliser sha1 ou md5 si vous travaillez avec une base de
données existante.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Si le mot de passe n&#8217;est pas haché, assurez-vous que vous avez suivi le même cas pour le mot de passe membre de la classe tout en nommant la fonction mutateur/setter</p>
</div>
</div>
<div class="section" id="recuperer-les-bookmarks-avec-un-tag-specifique">
<h3>Récupérer les Bookmarks avec un Tag Spécifique<a class="headerlink" href="#recuperer-les-bookmarks-avec-un-tag-specifique" title="Lien permanent vers ce titre">¶</a></h3>
<p>Maintenant que vous avez stocké les mots de passe de façon sécurisé, nous
pouvons construire quelques fonctionnalités intéressantes dans notre
application. Une fois que vous avez une collection de bookmarks, il peut
être pratique de pouvoir les chercher par tag. Ensuite nous allons intégrer une
route, une action de controller, et une méthode finder pour chercher les
bookmarks par tag.</p>
<p>Idéalement, nous aurions une URL qui ressemble à
<strong>http://localhost:8765/bookmarks/tagged/funny/cat/gifs</strong> Cela nous aide à
trouver tous les bookmarks qui ont les tags &#8216;funny&#8217;, &#8216;cat&#8217; ou &#8216;gifs&#8217;. Avant de
pouvoir intégrer ceci, nous allons ajouter une nouvelle route. Votre fichier
<strong>config/routes.php</strong> doit ressembler à ceci:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="nx">php</span>
<span class="k">use</span> <span class="nx">Cake\Routing\Route\DashedRoute</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Cake\Routing\Router</span><span class="p">;</span>

<span class="nx">Router</span><span class="o">::</span><span class="na">defaultRouteClass</span><span class="p">(</span><span class="nx">DashedRoute</span><span class="o">::</span><span class="na">class</span><span class="p">);</span>

<span class="c1">// Nouvelle route ajoutée pour notre action &quot;tagged&quot;.</span>
<span class="c1">// Le caractère `*` en fin de chaîne indique à CakePHP que cette action a</span>
<span class="c1">// des paramètres passés</span>
<span class="nx">Router</span><span class="o">::</span><span class="na">scope</span><span class="p">(</span>
    <span class="s1">&#39;/bookmarks&#39;</span><span class="p">,</span>
    <span class="p">[</span><span class="s1">&#39;controller&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Bookmarks&#39;</span><span class="p">],</span>
    <span class="k">function</span> <span class="p">(</span><span class="nv">$routes</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$routes</span><span class="o">-&gt;</span><span class="na">connect</span><span class="p">(</span><span class="s1">&#39;/tagged/*&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;action&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;tags&#39;</span><span class="p">]);</span>
    <span class="p">}</span>
<span class="p">);</span>

<span class="nx">Router</span><span class="o">::</span><span class="na">scope</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="k">function</span> <span class="p">(</span><span class="nv">$routes</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Connecte la page d&#39;accueil par défaut et les routes /pages/*.</span>
    <span class="nv">$routes</span><span class="o">-&gt;</span><span class="na">connect</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="p">[</span>
        <span class="s1">&#39;controller&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Pages&#39;</span><span class="p">,</span>
        <span class="s1">&#39;action&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;display&#39;</span><span class="p">,</span> <span class="s1">&#39;home&#39;</span>
    <span class="p">]);</span>
    <span class="nv">$routes</span><span class="o">-&gt;</span><span class="na">connect</span><span class="p">(</span><span class="s1">&#39;/pages/*&#39;</span><span class="p">,</span> <span class="p">[</span>
        <span class="s1">&#39;controller&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Pages&#39;</span><span class="p">,</span>
        <span class="s1">&#39;action&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;display&#39;</span>
    <span class="p">]);</span>

    <span class="c1">// Connecte les routes basées sur les conventions par défaut.</span>
    <span class="nv">$routes</span><span class="o">-&gt;</span><span class="na">fallbacks</span><span class="p">();</span>
<span class="p">});</span>
</pre></div>
</div>
<p>Ce qui est au-dessus définit une nouvelle &#8216;route&#8217; qui connecte le chemin
<strong>/bookmarks/tagged/*</strong>, vers <code class="docutils literal"><span class="pre">BookmarksController::tags()</span></code>. En définissant
les routes, vous pouvez isoler la définition de vos URLs, de la façon dont elles
sont intégrées. Si nous visitions <strong>http://localhost:8765/bookmarks/tagged</strong>,
nous verrions une page d&#8217;erreur de CakePHP. Intégrons maintenant la méthode
manquante. Dans <strong>src/Controller/BookmarksController.php</strong>, ajoutez ce qui
suit:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="k">public</span> <span class="k">function</span> <span class="nf">tags</span><span class="p">()</span>
<span class="p">{</span>
    <span class="c1">// La clé &#39;pass&#39; est fournie par CakePHP et contient tous les segments</span>
    <span class="c1">// d&#39;URL de la &quot;request&quot; (instance de \Cake\Network\Request)</span>
    <span class="nv">$tags</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">request</span><span class="o">-&gt;</span><span class="na">getParam</span><span class="p">(</span><span class="s1">&#39;pass&#39;</span><span class="p">);</span>

    <span class="c1">// On utilise l&#39;objet &quot;Bookmarks&quot; (une instance de</span>
    <span class="c1">// \App\Model\Table\BookmarksTable) pour récupérer les bookmarks avec</span>
    <span class="c1">// ces tags</span>
    <span class="nv">$bookmarks</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">Bookmarks</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">(</span><span class="s1">&#39;tagged&#39;</span><span class="p">,</span> <span class="p">[</span>
        <span class="s1">&#39;tags&#39;</span> <span class="o">=&gt;</span> <span class="nv">$tags</span>
    <span class="p">]);</span>

    <span class="c1">// Passe les variables au template de vue (view).</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">set</span><span class="p">([</span>
        <span class="s1">&#39;bookmarks&#39;</span> <span class="o">=&gt;</span> <span class="nv">$bookmarks</span><span class="p">,</span>
        <span class="s1">&#39;tags&#39;</span> <span class="o">=&gt;</span> <span class="nv">$tags</span>
    <span class="p">]);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Pour accéder aux autres parties des données de la &#8220;request&#8221;, référez-vous à la
section <a class="reference internal" href="controllers/request-response.html#cake-request"><span class="std std-ref">ServerRequest</span></a>.</p>
<div class="section" id="creer-la-methode-finder">
<h4>Créer la Méthode Finder<a class="headerlink" href="#creer-la-methode-finder" title="Lien permanent vers ce titre">¶</a></h4>
<p>Dans CakePHP, nous aimons garder les actions de notre controller légères, et
mettre la plupart de la logique de notre application dans les models. Si vous
visitez l&#8217;URL <strong>/bookmarks/tagged</strong> maintenant, vous verrez une erreur comme
quoi la méthode <code class="docutils literal"><span class="pre">findTagged()</span></code> n&#8217;a pas été encore intégrée, donc faisons-le.
Dans <strong>src/Model/Table/BookmarksTable.php</strong> ajoutez ce qui suit:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="c1">// L&#39;argument $query est une instance de \Cake\ORM\Query.</span>
<span class="c1">// Le tableau $options contiendra les tags que nous avons passé à find(&#39;tagged&#39;)</span>
<span class="c1">// dans l&#39;action de notre Controller</span>
<span class="k">public</span> <span class="k">function</span> <span class="nf">findTagged</span><span class="p">(</span><span class="nx">Query</span> <span class="nv">$query</span><span class="p">,</span> <span class="k">array</span> <span class="nv">$options</span><span class="p">)</span>
<span class="p">{</span>
    <span class="nv">$bookmarks</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">()</span>
        <span class="o">-&gt;</span><span class="na">select</span><span class="p">([</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;url&#39;</span><span class="p">,</span> <span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="s1">&#39;description&#39;</span><span class="p">]);</span>

    <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$options</span><span class="p">[</span><span class="s1">&#39;tags&#39;</span><span class="p">]))</span> <span class="p">{</span>
        <span class="nv">$bookmarks</span>
            <span class="o">-&gt;</span><span class="na">leftJoinWith</span><span class="p">(</span><span class="s1">&#39;Tags&#39;</span><span class="p">)</span>
            <span class="o">-&gt;</span><span class="na">where</span><span class="p">([</span><span class="s1">&#39;Tags.title IS&#39;</span> <span class="o">=&gt;</span> <span class="k">null</span><span class="p">]);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nv">$bookmarks</span>
            <span class="o">-&gt;</span><span class="na">innerJoinWith</span><span class="p">(</span><span class="s1">&#39;Tags&#39;</span><span class="p">)</span>
            <span class="o">-&gt;</span><span class="na">where</span><span class="p">([</span><span class="s1">&#39;Tags.title IN &#39;</span> <span class="o">=&gt;</span> <span class="nv">$options</span><span class="p">[</span><span class="s1">&#39;tags&#39;</span><span class="p">]]);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nv">$bookmarks</span><span class="o">-&gt;</span><span class="na">group</span><span class="p">([</span><span class="s1">&#39;Bookmarks.id&#39;</span><span class="p">]);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Nous intégrons juste <a class="reference internal" href="orm/retrieving-data-and-resultsets.html#custom-find-methods"><span class="std std-ref">des finders personnalisés</span></a>.
C&#8217;est un concept très puissant dans CakePHP qui vous permet de faire un package
réutilisable de vos requêtes. Les finders attendent toujours un objet
<a class="reference internal" href="orm/query-builder.html"><span class="doc">Query Builder</span></a> et un tableau d&#8217;options en paramètre. Les finders
peuvent manipuler les requêtes et ajouter n&#8217;importe quels conditions ou
critères. Une fois qu&#8217;ils ont terminé, les finders doivent retourner l&#8217;objet
Query modifié. Dans notre finder nous avons amené les méthodes
<code class="docutils literal"><span class="pre">innerJoinWith()</span></code>, <code class="docutils literal"><span class="pre">where()</span></code> et <code class="docutils literal"><span class="pre">group()</span></code> qui nous permet de trouver les
bookmarks distinct qui ont un tag correspondante.  Lorsque aucune tag n&#8217;est
fournie, nous utilisons un <code class="docutils literal"><span class="pre">leftJoinWith()</span></code> et modifions la condition
&#8216;where&#8217;, en trouvant des bookmarks sans tags.</p>
</div>
<div class="section" id="creer-la-vue">
<h4>Créer la Vue<a class="headerlink" href="#creer-la-vue" title="Lien permanent vers ce titre">¶</a></h4>
<p>Maintenant si vous vous rendez à l&#8217;url <strong>/bookmarks/tagged</strong>, CakePHP va
afficher une erreur vous disant que vous n&#8217;avez pas de fichier de vue.
Construisons donc le fichier de vue pour notre action <code class="docutils literal"><span class="pre">tags()</span></code>. Dans
<strong>src/Template/Bookmarks/tags.ctp</strong> mettez le contenu suivant:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="nx">h1</span><span class="o">&gt;</span>
    <span class="nx">Bookmarks</span> <span class="nx">tagged</span> <span class="nx">with</span>
    <span class="o">&lt;?=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">Text</span><span class="o">-&gt;</span><span class="na">toList</span><span class="p">(</span><span class="nx">h</span><span class="p">(</span><span class="nv">$tags</span><span class="p">))</span> <span class="cp">?&gt;</span><span class="x"></span>
<span class="x">&lt;/h1&gt;</span>

<span class="x">&lt;section&gt;</span>
<span class="cp">&lt;?php</span> <span class="k">foreach</span> <span class="p">(</span><span class="nv">$bookmarks</span> <span class="k">as</span> <span class="nv">$bookmark</span><span class="p">)</span><span class="o">:</span> <span class="cp">?&gt;</span><span class="x"></span>
<span class="x">    &lt;article&gt;</span>
<span class="x">        &lt;!-- Utilise le HtmlHelper pour créer un lien --&gt;</span>
<span class="x">        &lt;h4&gt;</span><span class="cp">&lt;?</span><span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">Html</span><span class="o">-&gt;</span><span class="na">link</span><span class="p">(</span><span class="nv">$bookmark</span><span class="o">-&gt;</span><span class="na">title</span><span class="p">,</span> <span class="nv">$bookmark</span><span class="o">-&gt;</span><span class="na">url</span><span class="p">)</span> <span class="cp">?&gt;</span><span class="x">&lt;/h4&gt;</span>
<span class="x">        &lt;small&gt;</span><span class="cp">&lt;?</span><span class="o">=</span> <span class="nx">h</span><span class="p">(</span><span class="nv">$bookmark</span><span class="o">-&gt;</span><span class="na">url</span><span class="p">)</span> <span class="cp">?&gt;</span><span class="x">&lt;/small&gt;</span>

<span class="x">        &lt;!-- Utilise le TextHelper pour formater le texte --&gt;</span>
<span class="x">        </span><span class="cp">&lt;?</span><span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">Text</span><span class="o">-&gt;</span><span class="na">autoParagraph</span><span class="p">(</span><span class="nx">h</span><span class="p">(</span><span class="nv">$bookmark</span><span class="o">-&gt;</span><span class="na">description</span><span class="p">))</span> <span class="cp">?&gt;</span><span class="x"></span>
<span class="x">    &lt;/article&gt;</span>
<span class="cp">&lt;?php</span> <span class="k">endforeach</span><span class="p">;</span> <span class="cp">?&gt;</span><span class="x"></span>
<span class="x">&lt;/section&gt;</span>
</pre></div>
</div>
<p>Dans le code ci-dessus, nous utilisons le <a class="reference internal" href="views/helpers/html.html"><span class="doc">Helper HTML</span></a>
et le <a class="reference internal" href="views/helpers/text.html"><span class="doc">Helper Text</span></a> pour aider à la génération
du contenu de notre vue. Nous utilisons également la fonction <a class="reference internal" href="core-libraries/global-constants-and-functions.html#h" title="h"><code class="xref php php-func docutils literal"><span class="pre">h</span></code></a>
pour encoder la sortie en HTML. Vous devez vous rappeler de toujours utiliser
<code class="docutils literal"><span class="pre">h()</span></code> lorsque vous affichez des données provenant des utilisateurs pour éviter
les problèmes d&#8217;injection HTML.</p>
<p>Le fichier <strong>tags.ctp</strong> que nous venons de créer suit la convention de nommage
de CakePHP pour un ficher de template de vue. La convention d&#8217;avoir le nom
de template en minuscule et en underscore du nom de l&#8217;action du controller.</p>
<p>Vous avez peut-être remarqué que nous pouvions utiliser les variables
<code class="docutils literal"><span class="pre">$tags</span></code> et <code class="docutils literal"><span class="pre">$bookmarks</span></code> dans notre vue. Quand nous utilisons la méthode
<code class="docutils literal"><span class="pre">set()</span></code> dans notre controller, nous définissons les variables spécifiques à
envoyer à la vue. La vue va rendre disponible toutes les variables passées
dans les templates en variables locales.</p>
<p>Vous devriez maintenant pouvoir visiter l&#8217;URL <strong>/bookmarks/tagged/funny</strong> et
voir tous les bookmarks taggés avec &#8216;funny&#8217;.</p>
<p>Ainsi nous avons créé une application basique pour gérer des bookmarks, des
tags et des users.
Cependant, tout le monde peut voir tous les tags de tout le monde. Dans le
prochain chapitre, nous allons intégrer une authentification et restreindre
la visibilité des bookmarks à ceux qui appartiennent à l&#8217;utilisateur courant.</p>
<p>Maintenant continuons avec
<a class="reference internal" href="tutorials-and-examples/bookmarks/part-two.html"><span class="doc">Tutoriel de Bookmarker Part 2</span></a>
pour construire votre application ou <a class="reference internal" href="topics.html"><span class="doc">plongez dans la documentation</span></a> pour en apprendre plus sur ce que CakePHP peut faire pour vous.</p>
</div>
</div>
</div>
<div class="section" id="tutoriel-de-bookmarker-part-2">
<h2>Tutoriel de Bookmarker Part 2<a class="headerlink" href="#tutoriel-de-bookmarker-part-2" title="Lien permanent vers ce titre">¶</a></h2>
<p>Après avoir fini <a class="reference internal" href="tutorials-and-examples/bookmarks/intro.html"><span class="doc">la première partie de ce tutoriel</span></a> vous devriez avoir une application
basique de bookmarking. Dans ce chapitre, nous ajouterons l&#8217;authentification
et nous allons restreindre les bookmarks pour que chaque utilisateur puisse
voir/modifier seulement ceux qui lui appartiennent.</p>
<div class="section" id="ajouter-la-connexion">
<h3>Ajouter la Connexion<a class="headerlink" href="#ajouter-la-connexion" title="Lien permanent vers ce titre">¶</a></h3>
<p>Dans CakePHP, l&#8217;authentification est gérée par les
<a class="reference internal" href="controllers/components.html"><span class="doc">Components (Composants)</span></a>. Les components peuvent être imaginés comme des
façons de créer des parties réutilisables de code du controller pour une
fonctionnalité spécifique ou un concept. Les components peuvent aussi se lancer
dans le cycle de vie de l&#8217;event du controller et interagir avec votre
application de cette façon. Pour commencer, nous ajouterons <a class="reference internal" href="controllers/components/authentication.html"><span class="doc">AuthComponent</span></a> à notre application. Nous voulons
que chaque méthode nécessite l&#8217;authentification, donc nous allons ajouter
AuthComponent dans notre AppController:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="c1">// Dans src/Controller/AppController.php</span>
<span class="k">namespace</span> <span class="nx">App\Controller</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">Cake\Controller\Controller</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">AppController</span> <span class="k">extends</span> <span class="nx">Controller</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">initialize</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">loadComponent</span><span class="p">(</span><span class="s1">&#39;Flash&#39;</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">loadComponent</span><span class="p">(</span><span class="s1">&#39;Auth&#39;</span><span class="p">,</span> <span class="p">[</span>
            <span class="s1">&#39;authenticate&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span>
                <span class="s1">&#39;Form&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span>
                    <span class="s1">&#39;fields&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span>
                        <span class="s1">&#39;username&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;email&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;password&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;password&#39;</span>
                    <span class="p">]</span>
                <span class="p">]</span>
            <span class="p">],</span>
            <span class="s1">&#39;loginAction&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span>
                <span class="s1">&#39;controller&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Users&#39;</span><span class="p">,</span>
                <span class="s1">&#39;action&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;login&#39;</span>
            <span class="p">],</span>
            <span class="c1">// Si l&#39;utilisateur arrive sur une page non-autorisée, on le</span>
            <span class="c1">// redirige sur la page précédente.</span>
            <span class="s1">&#39;unauthorizedRedirect&#39;</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">referer</span><span class="p">()</span>
        <span class="p">]);</span>

        <span class="c1">// Autorise l&#39;action display pour que notre controller de pages</span>
        <span class="c1">// continue de fonctionner.</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">Auth</span><span class="o">-&gt;</span><span class="na">allow</span><span class="p">([</span><span class="s1">&#39;display&#39;</span><span class="p">]);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Nous avons seulement indiqué à CakePHP que nous souhaitions charger les
components <code class="docutils literal"><span class="pre">Flash</span></code> et <code class="docutils literal"><span class="pre">Auth</span></code>. En plus, nous avons personnalisé la
configuration de AuthComponent, puisque notre table users utilise <code class="docutils literal"><span class="pre">email</span></code>
comme username. Maintenant, si vous tapez n&#8217;importe quelle URL, vous serez
renvoyé vers <strong>/users/login</strong>, qui vous montrera une page d&#8217;erreur puisque
nous n&#8217;avons pas encore écrit ce code. Créons donc l&#8217;action login:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="c1">// Dans src/Controller/UsersController.php</span>

<span class="k">public</span> <span class="k">function</span> <span class="nf">login</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">request</span><span class="o">-&gt;</span><span class="na">is</span><span class="p">(</span><span class="s1">&#39;post&#39;</span><span class="p">))</span> <span class="p">{</span>
        <span class="nv">$user</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">Auth</span><span class="o">-&gt;</span><span class="na">identify</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$user</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">Auth</span><span class="o">-&gt;</span><span class="na">setUser</span><span class="p">(</span><span class="nv">$user</span><span class="p">);</span>
            <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">redirect</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">Auth</span><span class="o">-&gt;</span><span class="na">redirectUrl</span><span class="p">());</span>
        <span class="p">}</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">Flash</span><span class="o">-&gt;</span><span class="na">error</span><span class="p">(</span><span class="s1">&#39;Votre username ou mot de passe est incorrect.&#39;</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Et dans <strong>src/Template/Users/login.ctp</strong>, ajoutez ce qui suit:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="nx">h1</span><span class="o">&gt;</span><span class="nx">Connexion</span><span class="o">&lt;/</span><span class="nx">h1</span><span class="o">&gt;</span>
<span class="o">&lt;?=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">Form</span><span class="o">-&gt;</span><span class="na">create</span><span class="p">()</span> <span class="cp">?&gt;</span><span class="x"></span>
<span class="cp">&lt;?</span><span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">Form</span><span class="o">-&gt;</span><span class="na">control</span><span class="p">(</span><span class="s1">&#39;email&#39;</span><span class="p">)</span> <span class="cp">?&gt;</span><span class="x"></span>
<span class="cp">&lt;?</span><span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">Form</span><span class="o">-&gt;</span><span class="na">control</span><span class="p">(</span><span class="s1">&#39;password&#39;</span><span class="p">)</span> <span class="cp">?&gt;</span><span class="x"></span>
<span class="cp">&lt;?</span><span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">Form</span><span class="o">-&gt;</span><span class="na">button</span><span class="p">(</span><span class="s1">&#39;Login&#39;</span><span class="p">)</span> <span class="cp">?&gt;</span><span class="x"></span>
<span class="cp">&lt;?</span><span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">Form</span><span class="o">-&gt;</span><span class="na">end</span><span class="p">()</span> <span class="cp">?&gt;</span><span class="x"></span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">La méthode <code class="docutils literal"><span class="pre">control()</span></code> est disponible depuis 3.4. Si vous utilisez une
version précédente, utilisez la méthode <code class="docutils literal"><span class="pre">input()</span></code>.</p>
</div>
<p>Maintenant que nous avons un formulaire simple de connexion, nous devrions
pouvoir nous connecter avec un de nos utilisateurs qui a un mot de passe
hashé.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Si aucun de vos utilisateurs n&#8217;a de mot de passe hashé, commentez la ligne
<code class="docutils literal"><span class="pre">loadComponent('Auth')</span></code>. Puis allez modifier l&#8217;utilisateur, créez-
lui un nouveau mot de passe.</p>
</div>
</div>
<div class="section" id="ajouter-la-deconnexion">
<h3>Ajouter la Déconnexion<a class="headerlink" href="#ajouter-la-deconnexion" title="Lien permanent vers ce titre">¶</a></h3>
<p>Maintenant que les personnes peuvent se connecter, vous voudrez aussi
probablement fournir un moyen de se déconnecter. Encore une fois, dans
<code class="docutils literal"><span class="pre">UsersController</span></code>, ajoutez le code suivant:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="k">public</span> <span class="k">function</span> <span class="nf">initialize</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">parent</span><span class="o">::</span><span class="na">initialize</span><span class="p">();</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">Auth</span><span class="o">-&gt;</span><span class="na">allow</span><span class="p">([</span><span class="s1">&#39;logout&#39;</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">function</span> <span class="nf">logout</span><span class="p">()</span>
<span class="p">{</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">Flash</span><span class="o">-&gt;</span><span class="na">success</span><span class="p">(</span><span class="s1">&#39;Vous êtes maintenant déconnecté.&#39;</span><span class="p">);</span>
    <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">redirect</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">Auth</span><span class="o">-&gt;</span><span class="na">logout</span><span class="p">());</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Ce code autorise l&#8217;action <code class="docutils literal"><span class="pre">logout</span></code> en tant qu&#8217;action publique,
et implémente la méthode logout. Vous pouvez maintenant visiter la page
<code class="docutils literal"><span class="pre">/users/logout</span></code> pour vous déconnecter. Vous devriez alors être renvoyé vers
la page de connexion.</p>
</div>
<div class="section" id="permettre-de-s-enregistrer">
<h3>Permettre de s&#8217;Enregistrer<a class="headerlink" href="#permettre-de-s-enregistrer" title="Lien permanent vers ce titre">¶</a></h3>
<p>Si vous n&#8217;êtes pas connecté et que vous essayez de visiter <strong>/users/add</strong> vous
serez renvoyés vers la page de connexion. Nous devrions régler cela puisque nous
voulons que les utilisateurs s&#8217;inscrivent à notre application. Dans
<code class="docutils literal"><span class="pre">UsersController</span></code>, ajoutez ce qui suit:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="k">public</span> <span class="k">function</span> <span class="nf">initialize</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">parent</span><span class="o">::</span><span class="na">initialize</span><span class="p">();</span>
    <span class="c1">// Ajoute l&#39;action &#39;add&#39; à la liste des actions autorisées.</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">Auth</span><span class="o">-&gt;</span><span class="na">allow</span><span class="p">([</span><span class="s1">&#39;logout&#39;</span><span class="p">,</span> <span class="s1">&#39;add&#39;</span><span class="p">]);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Ce qui est au-dessus indique à <code class="docutils literal"><span class="pre">AuthComponent</span></code> que l&#8217;action <code class="docutils literal"><span class="pre">add()</span></code> <em>ne</em>
nécessite <em>pas</em> d&#8217;authentification ou d&#8217;autorisation. Vous pouvez prendre le
temps de nettoyer <strong>Users/add.ctp</strong> et de retirer les liens, ou continuez vers
la prochaine section. Nous ne ferons pas de fichier d&#8217;édition (edit) ou de vue
d&#8217;un utilisateur (view), ni de liste d&#8217;utilisateurs (index) dans ce tutoriel
donc ils ne fonctionneront pas puisque <code class="docutils literal"><span class="pre">AuthComponent</span></code> va vous refuser
l&#8217;accès pour ces actions de controller.</p>
</div>
<div class="section" id="restreindre-l-acces-aux-bookmarks">
<h3>Restreindre l&#8217;Accès aux Bookmarks<a class="headerlink" href="#restreindre-l-acces-aux-bookmarks" title="Lien permanent vers ce titre">¶</a></h3>
<p>Maintenant que les utilisateurs peuvent se connecter, nous voulons limiter
les bookmarks qu&#8217;ils peuvent voir à ceux qu&#8217;ils ont créés. Nous allons le faire
en utilisant un adaptateur &#8216;authorization&#8217;. Puisque nos besoins sont
assez simples, nous pouvons écrire quelques lignes de code simple dans notre
<code class="docutils literal"><span class="pre">BookmarksController</span></code>. Mais avant de le faire, nous voulons dire à
AuthComponent comment notre application va autoriser les actions. Dans notre
<code class="docutils literal"><span class="pre">AppController</span></code>, ajoutez ce qui suit:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="k">public</span> <span class="k">function</span> <span class="nf">isAuthorized</span><span class="p">(</span><span class="nv">$user</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Ajoutez aussi ce qui suit dans la configuration de <code class="docutils literal"><span class="pre">Auth</span></code> dans
<code class="docutils literal"><span class="pre">AppController</span></code>:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="s1">&#39;authorize&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Controller&#39;</span><span class="p">,</span>
</pre></div>
</div>
<p>Votre méthode <code class="docutils literal"><span class="pre">initialize()</span></code> doit maintenant ressembler à ceci:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="k">public</span> <span class="k">function</span> <span class="nf">initialize</span><span class="p">()</span>
<span class="p">{</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">loadComponent</span><span class="p">(</span><span class="s1">&#39;Flash&#39;</span><span class="p">);</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">loadComponent</span><span class="p">(</span><span class="s1">&#39;Auth&#39;</span><span class="p">,</span> <span class="p">[</span>
        <span class="s1">&#39;authorize&#39;</span><span class="o">=&gt;</span> <span class="s1">&#39;Controller&#39;</span><span class="p">,</span><span class="c1">//added this line</span>
        <span class="s1">&#39;authenticate&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span>
            <span class="s1">&#39;Form&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span>
                <span class="s1">&#39;fields&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span>
                    <span class="s1">&#39;username&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;email&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;password&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;password&#39;</span>
                <span class="p">]</span>
            <span class="p">]</span>
        <span class="p">],</span>
        <span class="s1">&#39;loginAction&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span>
            <span class="s1">&#39;controller&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Users&#39;</span><span class="p">,</span>
            <span class="s1">&#39;action&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;login&#39;</span>
        <span class="p">],</span>
        <span class="s1">&#39;unauthorizedRedirect&#39;</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">referer</span><span class="p">()</span>
    <span class="p">]);</span>

    <span class="c1">// Allow the display action so our pages controller</span>
    <span class="c1">// continues to work.</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">Auth</span><span class="o">-&gt;</span><span class="na">allow</span><span class="p">([</span><span class="s1">&#39;display&#39;</span><span class="p">]);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Nous allons par défaut refuser l&#8217;accès, et permettre un accès incrémental où
cela est utile. D&#8217;abord, nous allons ajouter la logique d&#8217;autorisation pour
les bookmarks. Dans notre <code class="docutils literal"><span class="pre">BookmarksController</span></code>, ajoutez ce qui suit:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="k">public</span> <span class="k">function</span> <span class="nf">isAuthorized</span><span class="p">(</span><span class="nv">$user</span><span class="p">)</span>
<span class="p">{</span>
    <span class="nv">$action</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">request</span><span class="o">-&gt;</span><span class="na">params</span><span class="p">[</span><span class="s1">&#39;action&#39;</span><span class="p">];</span>

    <span class="c1">// Add et index sont toujours permises.</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">in_array</span><span class="p">(</span><span class="nv">$action</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;index&#39;</span><span class="p">,</span> <span class="s1">&#39;add&#39;</span><span class="p">,</span> <span class="s1">&#39;tags&#39;</span><span class="p">]))</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="c1">// Tout autre action nécessite un id.</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">request</span><span class="o">-&gt;</span><span class="na">getParam</span><span class="p">(</span><span class="s1">&#39;pass.0&#39;</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// Vérifie que le bookmark appartient à l&#39;utilisateur courant.</span>
    <span class="nv">$id</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">request</span><span class="o">-&gt;</span><span class="na">getParam</span><span class="p">(</span><span class="s1">&#39;pass.0&#39;</span><span class="p">);</span>
    <span class="nv">$bookmark</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">Bookmarks</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="nv">$id</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$bookmark</span><span class="o">-&gt;</span><span class="na">user_id</span> <span class="o">==</span> <span class="nv">$user</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">])</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="k">parent</span><span class="o">::</span><span class="na">isAuthorized</span><span class="p">(</span><span class="nv">$user</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Maintenant, si vous essayez de voir, de modifier ou de supprimer un bookmark qui
ne vous appartient pas, vous devriez être redirigé vers la page d&#8217;où vous venez.
Si aucun message ne s&#8217;affiche, ajoutez la ligne suivante dans votre layout:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="c1">// Dans src/Template/Layout/default.ctp</span>
<span class="o">&lt;?=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">Flash</span><span class="o">-&gt;</span><span class="na">render</span><span class="p">()</span> <span class="cp">?&gt;</span><span class="x"></span>
</pre></div>
</div>
<p>Vous devriez maintenant voir les messages d&#8217;erreur d&#8217;autorisation.</p>
</div>
<div class="section" id="regler-la-vue-de-liste-et-les-formulaires">
<h3>Régler la Vue de Liste et les Formulaires<a class="headerlink" href="#regler-la-vue-de-liste-et-les-formulaires" title="Lien permanent vers ce titre">¶</a></h3>
<p>Alors que view et delete fonctionnent, edit, add et index ont quelques
problèmes:</p>
<ol class="arabic simple">
<li>Lors de l&#8217;ajout d&#8217;un bookmark, vous pouvez choisir l&#8217;utilisateur.</li>
<li>Lors de l&#8217;édition d&#8217;un bookmark vous pouvez choisir l&#8217;utilisateur.</li>
<li>La page de liste montre les bookmarks des autres utilisateurs.</li>
</ol>
<p>Attaquons nous d&#8217;abord à add. Pour commencer, retirez <code class="docutils literal"><span class="pre">control('user_id')</span></code> de
<strong>src/Template/Bookmarks/add.ctp</strong>. Une fois retiré, nous allons aussi mettre à
jour l&#8217;action <code class="docutils literal"><span class="pre">add()</span></code> dans <strong>src/Controller/BookmarksController.php</strong> pour
ressembler à ceci:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="k">public</span> <span class="k">function</span> <span class="nf">add</span><span class="p">()</span>
<span class="p">{</span>
    <span class="nv">$bookmark</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">Bookmarks</span><span class="o">-&gt;</span><span class="na">newEntity</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">request</span><span class="o">-&gt;</span><span class="na">is</span><span class="p">(</span><span class="s1">&#39;post&#39;</span><span class="p">))</span> <span class="p">{</span>
        <span class="nv">$bookmark</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">Bookmarks</span><span class="o">-&gt;</span><span class="na">patchEntity</span><span class="p">(</span><span class="nv">$bookmark</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">request</span><span class="o">-&gt;</span><span class="na">getData</span><span class="p">());</span>
        <span class="nv">$bookmark</span><span class="o">-&gt;</span><span class="na">user_id</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">Auth</span><span class="o">-&gt;</span><span class="na">user</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">Bookmarks</span><span class="o">-&gt;</span><span class="na">save</span><span class="p">(</span><span class="nv">$bookmark</span><span class="p">))</span> <span class="p">{</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">Flash</span><span class="o">-&gt;</span><span class="na">success</span><span class="p">(</span><span class="s1">&#39;Le bookmark a été sauvegardé.&#39;</span><span class="p">);</span>
            <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">redirect</span><span class="p">([</span><span class="s1">&#39;action&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;index&#39;</span><span class="p">]);</span>
        <span class="p">}</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">Flash</span><span class="o">-&gt;</span><span class="na">error</span><span class="p">(</span><span class="s1">&#39;Le bookmark ne peut être sauvegardé. Merci de réessayer.&#39;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nv">$tags</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">Bookmarks</span><span class="o">-&gt;</span><span class="na">Tags</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">(</span><span class="s1">&#39;list&#39;</span><span class="p">);</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">set</span><span class="p">(</span><span class="nb">compact</span><span class="p">(</span><span class="s1">&#39;bookmark&#39;</span><span class="p">,</span> <span class="s1">&#39;tags&#39;</span><span class="p">));</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">set</span><span class="p">(</span><span class="s1">&#39;_serialize&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;bookmark&#39;</span><span class="p">]);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>En définissant la propriété entity avec les données de session, nous retirons
la possibilité que l&#8217;utilisateur puisse modifier l&#8217;auteur d&#8217;un bookmark.
Nous ferons la même chose pour le formulaire et l&#8217;action edit. Votre action
<code class="docutils literal"><span class="pre">edit()</span></code> dans <strong>src/Controller/BookmarksController.php</strong> devrait ressembler à
ceci:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="k">public</span> <span class="k">function</span> <span class="nf">edit</span><span class="p">(</span><span class="nv">$id</span> <span class="o">=</span> <span class="k">null</span><span class="p">)</span>
<span class="p">{</span>
    <span class="nv">$bookmark</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">Bookmarks</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="nv">$id</span><span class="p">,</span> <span class="p">[</span>
        <span class="s1">&#39;contain&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">&#39;Tags&#39;</span><span class="p">]</span>
    <span class="p">]);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">request</span><span class="o">-&gt;</span><span class="na">is</span><span class="p">([</span><span class="s1">&#39;patch&#39;</span><span class="p">,</span> <span class="s1">&#39;post&#39;</span><span class="p">,</span> <span class="s1">&#39;put&#39;</span><span class="p">]))</span> <span class="p">{</span>
        <span class="nv">$bookmark</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">Bookmarks</span><span class="o">-&gt;</span><span class="na">patchEntity</span><span class="p">(</span><span class="nv">$bookmark</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">request</span><span class="o">-&gt;</span><span class="na">getData</span><span class="p">());</span>
        <span class="nv">$bookmark</span><span class="o">-&gt;</span><span class="na">user_id</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">Auth</span><span class="o">-&gt;</span><span class="na">user</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">Bookmarks</span><span class="o">-&gt;</span><span class="na">save</span><span class="p">(</span><span class="nv">$bookmark</span><span class="p">))</span> <span class="p">{</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">Flash</span><span class="o">-&gt;</span><span class="na">success</span><span class="p">(</span><span class="s1">&#39;Le bookmark a été sauvegardé.&#39;</span><span class="p">);</span>
            <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">redirect</span><span class="p">([</span><span class="s1">&#39;action&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;index&#39;</span><span class="p">]);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">Flash</span><span class="o">-&gt;</span><span class="na">error</span><span class="p">(</span><span class="s1">&#39;Le bookmark ne peut être sauvegardé. Merci de réessayer.&#39;</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="nv">$tags</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">Bookmarks</span><span class="o">-&gt;</span><span class="na">Tags</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">(</span><span class="s1">&#39;list&#39;</span><span class="p">);</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">set</span><span class="p">(</span><span class="nb">compact</span><span class="p">(</span><span class="s1">&#39;bookmark&#39;</span><span class="p">,</span> <span class="s1">&#39;tags&#39;</span><span class="p">));</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">set</span><span class="p">(</span><span class="s1">&#39;_serialize&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;bookmark&#39;</span><span class="p">]);</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="section" id="vue-de-liste">
<h4>Vue de Liste<a class="headerlink" href="#vue-de-liste" title="Lien permanent vers ce titre">¶</a></h4>
<p>Maintenant nous devons afficher les bookmarks pour l&#8217;utilisateur actuellement
connecté. Nous pouvons le faire en mettant à jour l&#8217;appel à <code class="docutils literal"><span class="pre">paginate()</span></code>.
Faites en sorte que votre action <code class="docutils literal"><span class="pre">index()</span></code> dans
<strong>src/Controller/BookmarksController.php</strong> ressemble à ceci:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="k">public</span> <span class="k">function</span> <span class="nf">index</span><span class="p">()</span>
<span class="p">{</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">paginate</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;conditions&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span>
            <span class="s1">&#39;Bookmarks.user_id&#39;</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">Auth</span><span class="o">-&gt;</span><span class="na">user</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">),</span>
        <span class="p">]</span>
    <span class="p">];</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">set</span><span class="p">(</span><span class="s1">&#39;bookmarks&#39;</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">paginate</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">Bookmarks</span><span class="p">));</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">set</span><span class="p">(</span><span class="s1">&#39;_serialize&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;bookmarks&#39;</span><span class="p">]);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Nous devrions aussi mettre à jour l&#8217;action <code class="docutils literal"><span class="pre">tags()</span></code> et la méthode finder
liée, mais nous vous laisserons ceci en exercice que vous pouvez faire
vous-même.</p>
</div>
</div>
<div class="section" id="ameliorer-l-experience-de-tag">
<h3>Améliorer l&#8217;Experience de Tag<a class="headerlink" href="#ameliorer-l-experience-de-tag" title="Lien permanent vers ce titre">¶</a></h3>
<p>Actuellement, ajouter des nouveaux tags est un processus difficile, puisque
<code class="docutils literal"><span class="pre">TagsController</span></code> interdit tous les accès. Plutôt que de permettre l&#8217;accès,
nous pouvons améliorer l&#8217;UI de sélection de tag en utilisant un champ de texte
séparé par des virgules. Cela donnera une meilleure expérience à nos
utilisateurs, et utilisera quelques unes des super fonctionnalités de l&#8217;ORM.</p>
<div class="section" id="ajouter-un-champ-computed">
<h4>Ajouter un Champ Computed<a class="headerlink" href="#ajouter-un-champ-computed" title="Lien permanent vers ce titre">¶</a></h4>
<p>Comme nous voulons un accès simple vers les tags formatés pour une entity, nous
pouvons ajouter un champ virtuel/calculé à l&#8217;entity. Dans
<strong>src/Model/Entity/Bookmark.php</strong> ajoutez ce qui suit:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="k">use</span> <span class="nx">Cake\Collection\Collection</span><span class="p">;</span>

<span class="k">protected</span> <span class="k">function</span> <span class="nf">_getTagString</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_properties</span><span class="p">[</span><span class="s1">&#39;tag_string&#39;</span><span class="p">]))</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_properties</span><span class="p">[</span><span class="s1">&#39;tag_string&#39;</span><span class="p">];</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">tags</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nv">$tags</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Collection</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">tags</span><span class="p">);</span>
    <span class="nv">$str</span> <span class="o">=</span> <span class="nv">$tags</span><span class="o">-&gt;</span><span class="na">reduce</span><span class="p">(</span><span class="k">function</span> <span class="p">(</span><span class="nv">$string</span><span class="p">,</span> <span class="nv">$tag</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$string</span> <span class="o">.</span> <span class="nv">$tag</span><span class="o">-&gt;</span><span class="na">title</span> <span class="o">.</span> <span class="s1">&#39;, &#39;</span><span class="p">;</span>
    <span class="p">},</span> <span class="s1">&#39;&#39;</span><span class="p">);</span>
    <span class="k">return</span> <span class="nb">trim</span><span class="p">(</span><span class="nv">$str</span><span class="p">,</span> <span class="s1">&#39;, &#39;</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Cela nous laissera l&#8217;accès à la propriété calculée <code class="docutils literal"><span class="pre">$bookmark-&gt;tag_string</span></code>.
Nous utiliserons cette propriété dans controls plus tard. Rappelez-vous
d&#8217;ajouter la propriété <code class="docutils literal"><span class="pre">tag_string</span></code> dans la liste <code class="docutils literal"><span class="pre">_accessible</span></code> de votre
entity, puisque nous voulons la &#8216;sauvegarder&#8217; plus tard.</p>
<p>Dans le fichier <strong>src/Model/Entity/Bookmark.php</strong>, ajoutez <code class="docutils literal"><span class="pre">tag_string</span></code> à
la propriété <code class="docutils literal"><span class="pre">_accessible</span></code> comme ceci:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="k">protected</span> <span class="nv">$_accessible</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;user_id&#39;</span> <span class="o">=&gt;</span> <span class="k">true</span><span class="p">,</span>
    <span class="s1">&#39;title&#39;</span> <span class="o">=&gt;</span> <span class="k">true</span><span class="p">,</span>
    <span class="s1">&#39;description&#39;</span> <span class="o">=&gt;</span> <span class="k">true</span><span class="p">,</span>
    <span class="s1">&#39;url&#39;</span> <span class="o">=&gt;</span> <span class="k">true</span><span class="p">,</span>
    <span class="s1">&#39;user&#39;</span> <span class="o">=&gt;</span> <span class="k">true</span><span class="p">,</span>
    <span class="s1">&#39;tags&#39;</span> <span class="o">=&gt;</span> <span class="k">true</span><span class="p">,</span>
    <span class="s1">&#39;tag_string&#39;</span> <span class="o">=&gt;</span> <span class="k">true</span><span class="p">,</span>
<span class="p">];</span>
</pre></div>
</div>
</div>
<div class="section" id="mettre-a-jour-les-vues">
<h4>Mettre à Jour les Vues<a class="headerlink" href="#mettre-a-jour-les-vues" title="Lien permanent vers ce titre">¶</a></h4>
<p>Avec l&#8217;entity mise à jour, nous pouvons ajouter un nouveau <em>control</em> pour nos tags.
Dans <strong>src/Template/Bookmarks/add.ctp</strong> et <strong>src/Template/Bookmarks/edit.ctp</strong>,
remplacez l&#8217;input <code class="docutils literal"><span class="pre">tags._ids</span></code> existant avec ce qui suit:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="k">echo</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">Form</span><span class="o">-&gt;</span><span class="na">control</span><span class="p">(</span><span class="s1">&#39;tag_string&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;type&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;text&#39;</span><span class="p">]);</span>
</pre></div>
</div>
</div>
<div class="section" id="persister-la-chaine-tag">
<h4>Persister la Chaîne Tag<a class="headerlink" href="#persister-la-chaine-tag" title="Lien permanent vers ce titre">¶</a></h4>
<p>Maintenant que nous pouvons voir les tags existants en chaîne, nous voudrions
aussi sauvegarder les données. Comme nous marquons les <code class="docutils literal"><span class="pre">tag_string</span></code>
accessibles, l&#8217;ORM va copier ces données à partir de la requête dans notre
entity. Nous pouvons utiliser une méthode hook <code class="docutils literal"><span class="pre">beforeSave()</span></code> pour parser la
chaîne de tag et trouver/construire les entities liées. Ajoutez ce qui suit dans
<strong>src/Model/Table/BookmarksTable.php</strong>:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="k">public</span> <span class="k">function</span> <span class="nf">beforeSave</span><span class="p">(</span><span class="nv">$event</span><span class="p">,</span> <span class="nv">$entity</span><span class="p">,</span> <span class="nv">$options</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$entity</span><span class="o">-&gt;</span><span class="na">tag_string</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$entity</span><span class="o">-&gt;</span><span class="na">tags</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_buildTags</span><span class="p">(</span><span class="nv">$entity</span><span class="o">-&gt;</span><span class="na">tag_string</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">protected</span> <span class="k">function</span> <span class="nf">_buildTags</span><span class="p">(</span><span class="nv">$tagString</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// Trim tags</span>
    <span class="nv">$newTags</span> <span class="o">=</span> <span class="nb">array_map</span><span class="p">(</span><span class="s1">&#39;trim&#39;</span><span class="p">,</span> <span class="nb">explode</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="nv">$tagString</span><span class="p">));</span>
    <span class="c1">// Retire tous les tags vides</span>
    <span class="nv">$newTags</span> <span class="o">=</span> <span class="nb">array_filter</span><span class="p">(</span><span class="nv">$newTags</span><span class="p">);</span>
    <span class="c1">// Réduit les tags dupliqués</span>
    <span class="nv">$newTags</span> <span class="o">=</span> <span class="nb">array_unique</span><span class="p">(</span><span class="nv">$newTags</span><span class="p">);</span>

    <span class="nv">$out</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="nv">$query</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">Tags</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">()</span>
        <span class="o">-&gt;</span><span class="na">where</span><span class="p">([</span><span class="s1">&#39;Tags.title IN&#39;</span> <span class="o">=&gt;</span> <span class="nv">$newTags</span><span class="p">]);</span>

    <span class="c1">// Retire les tags existants de la liste des tags nouveaux.</span>
    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$query</span><span class="o">-&gt;</span><span class="na">extract</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="nv">$existing</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$index</span> <span class="o">=</span> <span class="nb">array_search</span><span class="p">(</span><span class="nv">$existing</span><span class="p">,</span> <span class="nv">$newTags</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$index</span> <span class="o">!==</span> <span class="k">false</span><span class="p">)</span> <span class="p">{</span>
            <span class="nb">unset</span><span class="p">(</span><span class="nv">$newTags</span><span class="p">[</span><span class="nv">$index</span><span class="p">]);</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="c1">// Ajoute les tags existants.</span>
    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$query</span> <span class="k">as</span> <span class="nv">$tag</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$out</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$tag</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="c1">// Ajoute les nouveaux tags.</span>
    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$newTags</span> <span class="k">as</span> <span class="nv">$tag</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$out</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">Tags</span><span class="o">-&gt;</span><span class="na">newEntity</span><span class="p">([</span><span class="s1">&#39;title&#39;</span> <span class="o">=&gt;</span> <span class="nv">$tag</span><span class="p">]);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nv">$out</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Alors que ce code est un peu plus compliqué que ce que nous avons déjà fait,
il permet de montrer la puissance de l&#8217;ORM de CakePHP. Vous pouvez facilement
manipuler les résultats de requête en utilisant les méthodes des
<a class="reference internal" href="core-libraries/collections.html"><span class="doc">Collections</span></a>, et gérer les scenarios où vous créez les
entities à la volée avec facilité.</p>
</div>
</div>
<div class="section" id="recapitulatif">
<h3>Récapitulatif<a class="headerlink" href="#recapitulatif" title="Lien permanent vers ce titre">¶</a></h3>
<p>Nous avons élargi notre application de bookmarking pour gérer les scenarios de
contrôle d&#8217;authentification et d&#8217;autorisation/d&#8217;accès basique. Nous avons aussi
ajouté quelques améliorations UX en tirant parti du FormHelper et des capacités
de l&#8217;ORM.</p>
<p>Merci d&#8217;avoir pris le temps d&#8217;explorer CakePHP. Ensuite, vous pouvez finir le
tutoriel du <a class="reference internal" href="tutorials-and-examples/blog/blog.html"><span class="doc">Tutoriel d&#8217;un Blog</span></a>, en apprendre plus sur
l&#8217;<a class="reference internal" href="orm.html"><span class="doc">ORM</span></a> ou vous pouvez lire attentivement <a class="reference internal" href="topics.html"><span class="doc">Utiliser CakePHP</span></a>.</p>
</div>
</div>
</div>


            </div>
        </div>

        
        <div class="col-md-3 col-md-pull-9 hidden-xs hidden-sm" lang="fr">
            <aside class="sidebar">
                <div class="mb30 row">
<div id="sidebar-navigation" class="hidden-xs">
	<p class="caption"><span class="caption-text">Préface</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="intro.html">CakePHP en un Coup d&#8217;Oeil</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Guide de Démarrage Rapide</a></li>
<li class="toctree-l1"><a class="reference internal" href="appendices/3-x-migration-guide.html">3.x Guide de Migration</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorials-and-examples.html">Tutoriels et exemples</a></li>
<li class="toctree-l1"><a class="reference internal" href="contributing.html">Contribuer</a></li>
</ul>
<p class="caption"><span class="caption-text">Pour Commencer</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="development/configuration.html">Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="development/routing.html">Routing</a></li>
<li class="toctree-l1"><a class="reference internal" href="controllers/request-response.html">Les Objets Request &amp; Response</a></li>
<li class="toctree-l1"><a class="reference internal" href="controllers/middleware.html">Middleware</a></li>
<li class="toctree-l1"><a class="reference internal" href="controllers.html">Controllers (Contrôleurs)</a></li>
<li class="toctree-l1"><a class="reference internal" href="views.html">Views (Vues)</a></li>
<li class="toctree-l1"><a class="reference internal" href="orm.html">Accès Base de Données &amp; ORM</a></li>
</ul>
<p class="caption"><span class="caption-text">Généralités</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="controllers/components/authentication.html">Authentification</a></li>
<li class="toctree-l1"><a class="reference internal" href="bake.html">Console Bake</a></li>
<li class="toctree-l1"><a class="reference internal" href="core-libraries/caching.html">La mise en cache</a></li>
<li class="toctree-l1"><a class="reference internal" href="console-and-shells.html">Outils de Console, Shells, &amp; Tasks</a></li>
<li class="toctree-l1"><a class="reference internal" href="development/debugging.html">Debugger</a></li>
<li class="toctree-l1"><a class="reference internal" href="deployment.html">Déploiement</a></li>
<li class="toctree-l1"><a class="reference internal" href="core-libraries/email.html">Email</a></li>
<li class="toctree-l1"><a class="reference internal" href="development/errors.html">Gestion des Erreurs &amp; Exceptions</a></li>
<li class="toctree-l1"><a class="reference internal" href="core-libraries/events.html">Événements système</a></li>
<li class="toctree-l1"><a class="reference internal" href="core-libraries/internationalization-and-localization.html">Internationalisation &amp; Localisation</a></li>
<li class="toctree-l1"><a class="reference internal" href="core-libraries/logging.html">Journalisation (logging)</a></li>
<li class="toctree-l1"><a class="reference internal" href="core-libraries/form.html">Formulaires Sans Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="controllers/components/pagination.html">Pagination</a></li>
<li class="toctree-l1"><a class="reference internal" href="plugins.html">Plugins</a></li>
<li class="toctree-l1"><a class="reference internal" href="development/rest.html">REST</a></li>
<li class="toctree-l1"><a class="reference internal" href="security.html">Sécurité</a></li>
<li class="toctree-l1"><a class="reference internal" href="development/sessions.html">Sessions</a></li>
<li class="toctree-l1"><a class="reference internal" href="development/testing.html">Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="core-libraries/validation.html">Validation</a></li>
</ul>
<p class="caption"><span class="caption-text">Utilitaires</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="core-libraries/app.html">Classe App</a></li>
<li class="toctree-l1"><a class="reference internal" href="core-libraries/collections.html">Collections</a></li>
<li class="toctree-l1"><a class="reference internal" href="core-libraries/file-folder.html">Folder &amp; File</a></li>
<li class="toctree-l1"><a class="reference internal" href="core-libraries/hash.html">Hash</a></li>
<li class="toctree-l1"><a class="reference internal" href="core-libraries/httpclient.html">Client Http</a></li>
<li class="toctree-l1"><a class="reference internal" href="core-libraries/inflector.html">Inflector</a></li>
<li class="toctree-l1"><a class="reference internal" href="core-libraries/number.html">Number</a></li>
<li class="toctree-l1"><a class="reference internal" href="core-libraries/registry-objects.html">Objets Registry</a></li>
<li class="toctree-l1"><a class="reference internal" href="core-libraries/text.html">Text</a></li>
<li class="toctree-l1"><a class="reference internal" href="core-libraries/time.html">Date &amp; Time</a></li>
<li class="toctree-l1"><a class="reference internal" href="core-libraries/xml.html">Xml</a></li>
</ul>
<p class="caption"><span class="caption-text">Divers</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="core-libraries/global-constants-and-functions.html">Globales &amp; Fonctions</a></li>
<li class="toctree-l1"><a class="reference internal" href="chronos.html">Chronos</a></li>
<li class="toctree-l1"><a class="reference internal" href="debug-kit.html">Debug Kit</a></li>
<li class="toctree-l1"><a class="reference internal" href="migrations.html">Migrations</a></li>
<li class="toctree-l1"><a class="reference internal" href="elasticsearch.html">ElasticSearch</a></li>
<li class="toctree-l1"><a class="reference internal" href="upgrade-tool.html">Outil d&#8217;Upgrade</a></li>
<li class="toctree-l1"><a class="reference internal" href="appendices.html">Annexes</a></li>
</ul>

</div>

                </div>
            </aside>
            <aside class="sidebar">
                <div class="mb30 row">
                </div>
            </aside>
        </div>
    </div>
</div>

<section id="socials" class="back-3">
    <div class="container-fluid">
        <div class="row">
            <div class="col-xs-12 col-sm-12 col-md-5  social text-center">
                <div class="col-sm-3 col-xs-3">
                    <div id="fb-root"></div>
                        <script>(function(d, s, id) {
                          var js, fjs = d.getElementsByTagName(s)[0];
                          if (d.getElementById(id)) return;
                          js = d.createElement(s); js.id = id;
                          js.src = "//connect.facebook.net/en_US/sdk.js#xfbml=1&version=v2.5";
                          fjs.parentNode.insertBefore(js, fjs);
                        }(document, 'script', 'facebook-jssdk'));
                        </script>
                        <div id="fb-root-face" class="fb-like" data-href="https://www.facebook.com/CakePHP/" data-layout="button_count" data-action="like" data-show-faces="true" data-share="false"></div>
                </div>

                <div class="col-sm-3 col-xs-3">
                    <iframe src="https://ghbtns.com/github-btn.html?user=cakephp&amp;repo=cakephp&amp;type=star&amp;count=true&amp;size=small" frameborder="0" scrolling="0" width="120px" height="30px"></iframe>
                </div>

                <div class="col-sm-3 col-xs-3">
                    <iframe src="https://ghbtns.com/github-btn.html?user=cakephp&amp;repo=cakephp&amp;type=fork&amp;count=true&amp;size=small" frameborder="0" scrolling="0" width="120px" height="30px"></iframe>
                </div>

                <div class="col-sm-3 col-xs-3">
                    <a href="https://twitter.com/CakePHP" class="twitter-follow-button" data-show-count="false" data-show-screen-name="false">Follow @CakePHP</a>
                    <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
                </div>
            </div>

            <div class="col-xs-12 col-sm-12 col-md-7 social-footer text-center ">
                <a href="https://twitter.com/cakephp" data-toggle="tooltip" title="Twitter"><i class="fa icon-social fa-twitter"></i>
                <a href="https://www.facebook.com/groups/cake.community" data-toggle="tooltip" title="Facebook"><i class="fa icon-social fa-facebook"></i></a>
                <a href="https://goo.gl/mSC0s" data-toggle="tooltip" title="Google Plus"><i class="fa icon-social  fa-google-plus"></i></a>
                <a href="https://www.youtube.com/user/CakePHP" data-toggle="tooltip" title="Youtube"><i class="fa icon-social fa-youtube-play"></i></a>
                <a href="https://github.com/cakephp" data-toggle="tooltip" title="Github"><i class="fa icon-social fa-git"></i></a>
                <a href="https://cakesf.herokuapp.com/" target="_blank" title="Slack" data-toggle="tooltip"><i class="fa fa-slack icon-social"></i></a>
                <a href="https://stackoverflow.com/tags/cakephp" data-toggle="tooltip" title="Stack Overflow"><i class="fa icon-social fa-stack-overflow"></i></a>
                <a href="https://webchat.freenode.net/?channels=cakephp" data-toggle="tooltip" title="IRC" class="icon-irc">#IRC</a>
            </div>
        </div>
    </div>
</section>

<footer id="footer" class="footer-wrapper">
    <div class="container">

        <div class="row col-p30">
            <div class="col-sm-12 col-md-3">
                <div class="footer-widget t-footer">
                    <div class="col-md-12">
                        <a href="https://www.openhub.net/p/cakephp">
                            <img src="_static/open-hub.png">
                        </a>
                        <div class="mt10">
                            <a href="https://www.rackspace.com/">
                                <img src="_static/rackspace.png">
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-sm-12 col-md-9">
                <div class="col-md-3 col-sm-6 business-solution">
                    <ul class="footer-menu">
                        <li class="menu-title">
    <a href="https://cakephp.org/business-solutions"><i class="fa fa-menu-title fa-briefcase"></i>Business Solutions</a>
</li>
<li class="menu-title mt30">
    <a href="https://cakephp.org/showcase"><i class="fa fa-menu-title fa-desktop"></i>Showcase</a>
</li>
                    </ul>
                </div>

                <div class="col-md-3 col-sm-6">
                    <ul class="footer-menu">
                        
<li class="menu-title">
	<i class="fa fa-menu-title fa-book"></i>Documentation
</li>

<li><a href="https://book.cakephp.org"><i class="fa fa-menu fa-chevron-right"></i>Book</a></li>
<li><a href="https://api.cakephp.org"><i class="fa fa-menu fa-chevron-right"></i>API</a></li>

<li><a href="https://cakephp.org/documentation/videos"><i class="fa fa-menu fa-chevron-right"></i>Videos</a></li>
<li><a href="https://cakephp.org/privacy"><i class="fa fa-menu fa-chevron-right"></i>Privacy Policy</a></li>
<li><a href="https://cakephp.org/pages/trademark"><i class="fa fa-menu fa-chevron-right"></i>Logos &amp; Trademarks</a></li>
                    </ul>
                </div>

                <div class="col-md-3 col-sm-6">
                    <ul class="footer-menu">
                        
<li class="menu-title"><i class="fa fa-menu-title fa-users"></i>Community</li>

<li><a href="https://cakephp.org/team"><i class="fa fa-menu fa-chevron-right"></i>Team</a></li>
<li><a href="https://github.com/cakephp/cakephp/issues"><i class="fa fa-menu fa-chevron-right"></i>Issues (Github)</a></li>
<li><a href="https://www.youtube.com/user/CakePHP"><i class="fa fa-menu fa-chevron-right"></i>YouTube Channel</a></li>
<li><a href="https://cakephp.org/get-involved"><i class="fa fa-menu fa-chevron-right"></i>Get Involved</a></li>

<li><a href="https://bakery.cakephp.org"><i class="fa fa-menu fa-chevron-right"></i>Bakery</a></li>
<li><a href="https://github.com/FriendsOfCake/awesome-cakephp"><i class="fa fa-menu fa-chevron-right"></i>Featured Resources</a></li>
<li><a href="https://cakephp.org/newsletter/signup"><i class="fa fa-menu fa-chevron-right"></i>Newsletter</a></li>
<li><a href="http://certification.cakephp.org"><i class="fa fa-menu fa-chevron-right"></i>Certification</a></li>
<li><a href="http://my.cakephp.org"><i class="fa fa-menu fa-chevron-right"></i>My CakePHP</a></li>
<li><a href="http://cakefest.org"><i class="fa fa-menu fa-chevron-right"></i>CakeFest</a></li>
<li><a href="https://www.facebook.com/groups/cake.community"><i class="fa fa-menu fa-chevron-right"></i>Facebook</a></li>
<li><a href="https://twitter.com/cakephp"><i class="fa fa-menu fa-chevron-right"></i>Twitter</a></li>
                    </ul>
                </div>

                <div class="col-md-3 col-sm-6">
                    <ul class="footer-menu">
                        
<li class="menu-title"><i class="fa fa-menu-title fa-comments-o"></i>Help &amp; Support</li>

<li><a href="http://discourse.cakephp.org"><i class="fa fa-menu fa-chevron-right"></i>Forum</a></li>
<li><a href="https://stackoverflow.com/tags/cakephp"><i class="fa fa-menu fa-chevron-right"></i>Stack Overflow</a></li>
<li><a href="https://webchat.freenode.net/?channels=cakephp"><i class="fa fa-menu fa-chevron-right"></i>IRC</a></li>
<li><a href="https://cakesf.herokuapp.com/"><i class="fa fa-menu fa-chevron-right"></i>Slack</a></li>
<li><a href="https://www.cakedc.com/"><i class="fa fa-menu fa-chevron-right"></i>Paid Support</a></li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-12 text-center mt30">
                <p class="copyright">
                            &copy; Copyright 2017, Cake Software Foundation, Inc.
                        Mis à jour le août 30, 2017.
                        Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.4.5.
                </p>
            </div>
        </div>
    </div>
</footer>

<div id="inline-search-results"></div>


</div>

<script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-743287-3']);
    _gaq.push(['_trackPageview']);
    (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
</script>
  </body>
</html>