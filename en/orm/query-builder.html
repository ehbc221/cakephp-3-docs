

<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Query Builder - 3.x</title>
    <link href="../_static/favicon.png" type="image/png" rel="icon" />

    
    <link rel="stylesheet" href="../_static/css/app.css" type="text/css" />
    
    <script type="text/javascript" src="../_static/app.js"></script>

    <link rel="alternate" hreflang="pt_BR" href="../../pt/orm/query-builder.html" /><link rel="alternate" hreflang="es" href="../../es/orm/query-builder.html" /><link rel="alternate" hreflang="ja" href="../../ja/orm/query-builder.html" /><link rel="alternate" hreflang="fr" href="../../fr/orm/query-builder.html" /><link rel="alternate" hreflang="zh" href="../../zh/orm/query-builder.html" /><link rel="alternate" hreflang="tr" href="../../tr/orm/query-builder.html" /><link rel="alternate" hreflang="ru" href="../../ru/orm/query-builder.html" />

    <link rel="search" type="application/opensearchdescription+xml" title="Search within CakePHP Cookbook 3.5 documentation" href="../_static/opensearchdescription-book-3-x.xml">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="top" title="CakePHP Cookbook 3.5 documentation" href="../index.html" />
    <link rel="up" title="Database Access &amp; ORM" href="../orm.html" />
    <link rel="next" title="Table Objects" href="table-objects.html" />
    <link rel="prev" title="Database Basics" href="database-basics.html" />

    <script type="text/javascript">
    window.lang = "en";
    </script>
  </head>
  <body>

<div id="container">
    
    <header class="nav-down">
        <div class="container-fluid hidden-xs hidden-sm">
            <div class="row">
                <div class="col-sm-3 col-md-3">
                    <a class="logo-cake" href="https://cakephp.org">
                        <img src="../_static/logo-cake.png" alt="CakePHP" />
                    </a>
                </div>

                <div class="col-sm-9 col-md-9">
                    <nav class="navbar-right">
                        <ul class="menu">
                            <li class="first">
                                <a href="#"><i class="fa fa-menu fa-chevron-down"></i>Documentation</a>
                                <ul class="submenu">
                                    
<li><a href="https://book.cakephp.org"><i class="fa fa-menu fa-chevron-right"></i>Book</a></li>
<li><a href="https://api.cakephp.org"><i class="fa fa-menu fa-chevron-right"></i>API</a></li>

<li><a href="https://cakephp.org/documentation/videos"><i class="fa fa-menu fa-chevron-right"></i>Videos</a></li>
<li><a href="https://cakephp.org/privacy"><i class="fa fa-menu fa-chevron-right"></i>Privacy Policy</a></li>
<li><a href="https://cakephp.org/pages/trademark"><i class="fa fa-menu fa-chevron-right"></i>Logos &amp; Trademarks</a></li>
                                </ul>
                            </li>

                            <li><a href="https://cakephp.org/business-solutions">Business Solutions</a></li>
                            <li><a href="https://cakephp.org/writers">Get Paid To Write</a></li>
                            <li><a href="https://cakephp.org/pages/team">Team</a></li>

                            <li>
                                <a href="#"><i class="fa fa-menu fa-chevron-down"></i>Community</a>
                                <div class="megamenu full">
                                    <div class="row">
                                        <div class="col-6 pl30">
                                            <ul class="megamenu-list">
                                                
<li class="menu-title"><i class="fa fa-menu-title fa-users"></i>Community</li>

<li><a href="https://cakephp.org/team"><i class="fa fa-menu fa-chevron-right"></i>Team</a></li>
<li><a href="https://github.com/cakephp/cakephp/issues"><i class="fa fa-menu fa-chevron-right"></i>Issues (Github)</a></li>
<li><a href="https://www.youtube.com/user/CakePHP"><i class="fa fa-menu fa-chevron-right"></i>YouTube Channel</a></li>
<li><a href="https://cakephp.org/get-involved"><i class="fa fa-menu fa-chevron-right"></i>Get Involved</a></li>

<li><a href="https://bakery.cakephp.org"><i class="fa fa-menu fa-chevron-right"></i>Bakery</a></li>
<li><a href="https://github.com/FriendsOfCake/awesome-cakephp"><i class="fa fa-menu fa-chevron-right"></i>Featured Resources</a></li>
<li><a href="https://cakephp.org/newsletter/signup"><i class="fa fa-menu fa-chevron-right"></i>Newsletter</a></li>
<li><a href="http://certification.cakephp.org"><i class="fa fa-menu fa-chevron-right"></i>Certification</a></li>
<li><a href="http://my.cakephp.org"><i class="fa fa-menu fa-chevron-right"></i>My CakePHP</a></li>
<li><a href="http://cakefest.org"><i class="fa fa-menu fa-chevron-right"></i>CakeFest</a></li>
<li><a href="https://www.facebook.com/groups/cake.community"><i class="fa fa-menu fa-chevron-right"></i>Facebook</a></li>
<li><a href="https://twitter.com/cakephp"><i class="fa fa-menu fa-chevron-right"></i>Twitter</a></li>
                                            </ul>
                                        </div>
                                        <div class="col-6 pl30">
                                            <ul class="megamenu-list">
                                                
<li class="menu-title"><i class="fa fa-menu-title fa-comments-o"></i>Help &amp; Support</li>

<li><a href="http://discourse.cakephp.org"><i class="fa fa-menu fa-chevron-right"></i>Forum</a></li>
<li><a href="https://stackoverflow.com/tags/cakephp"><i class="fa fa-menu fa-chevron-right"></i>Stack Overflow</a></li>
<li><a href="https://webchat.freenode.net/?channels=cakephp"><i class="fa fa-menu fa-chevron-right"></i>IRC</a></li>
<li><a href="https://cakesf.herokuapp.com/"><i class="fa fa-menu fa-chevron-right"></i>Slack</a></li>
<li><a href="https://www.cakedc.com/"><i class="fa fa-menu fa-chevron-right"></i>Paid Support</a></li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </li>
                        </ul>
                    </nav>
                </div>
            </div>
        </div>

        
        <div class="container-fluid hidden-md hidden-lg">
            <div class="row">
                <div class="col-sm-6 col-xs-6">
                    <a class="logo-cake" href="https://cakephp.org">
                        <img src="../_static/logo-cake.png" alt="CakePHP" />
                    </a>
                </div>

                <div class="col-sm-6 col-xs-6">
                    <div class="navbar-right">
                        <button id="btn-menu" class="btn-menu" data-toggle="modal" data-target="#modal">
                            <i class="fa fa-bars toggle-modal"></i>
                        </button>
                    </div>
                    <div id="wrap">
                        <form class="search" action="../search.html" method="get">
                            <input name="q" type="search" placeholder="What are you looking for?">
                            <input id="search_submit" value="Search" type="submit">
                        </form>
                    </div>
                </div>
            </div>
        </div>

        
        <section id="nav-cook" class="hidden-xs hidden-sm">
            <div class="container-fluid ">
                <div class="row ">
                    <div class="col-md-12 back-book">
                        <div class="col-md-5 text-center t-cook-nav p0 hidden-sm hidden-xs">
                            <h2>
                                <a href="../contents.html">
                                    <span class="glyph_range icon-submenu icon-submenu-cook">B</span>
                                    CakePHP 3.5 Red Velvet <strong>Cookbook</strong>
                                </a>
                            </h2>
                        </div>

                        <div class="col-md-4 hidden-sm">
                            <form class="search" action="../search.html" method="get">
                                <input type="hidden" name="check_keywords" value="yes" />
                                <input type="hidden" name="area" value="default" />

                                <div class="col-md-10 p0">
                                    <input class="form-control form-cook" autocomplete="off" type="search" name="q" size="18" placeholder='Cookbook Search' />
                                </div>
                                <div class="col-md-2 p0 search-cook">
                                    <button type="submit">
                                        <span class="glyph_range icon-submenu icon-submenu-cook">A</span>
                                    </button>
                                </div>
                            </form>
                        </div>

                        
                        <div class="col-md-3">
                            <div class="col-md-6 p0">
                                <div class="col-md-7 t-language p0">
                                    <h6>Language:</h6>
                                </div>
                                <div class="col-md-5 p0">
                                    <ul class="nav navbar-nav">
                                        <li class="dropdown">
                                            <a class="dropdown-toggle" data-hover="dropdown" data-toggle="dropdown"
                                                    role="button" aria-haspopup="true" aria-expanded="false" href="#">
                                                        en
                                                        <i class="fa fa-menu-en fa-chevron-down"></i>
                                                    </a>
                                            <ul class="dropdown-menu">
                                            
                                                <li></li>
                                            
                                                <li><a href="../../pt/orm/query-builder.html">pt</a></li>
                                            
                                                <li><a href="../../es/orm/query-builder.html">es</a></li>
                                            
                                                <li><a href="../../ja/orm/query-builder.html">ja</a></li>
                                            
                                                <li><a href="../../fr/orm/query-builder.html">fr</a></li>
                                            
                                                <li><a href="../../zh/orm/query-builder.html">zh</a></li>
                                            
                                                <li><a href="../../tr/orm/query-builder.html">tr</a></li>
                                            
                                                <li><a href="../../ru/orm/query-builder.html">ru</a></li>
                                            
                                            </ul>
                                        </li>
                                    </ul>
                                </div>
                            </div>

                            <div class="col-md-6 p0">
                                <div class="col-md-7 t-language p0">
                                    <h6>Version:</h6>
                                </div>
                                <div class="col-md-5 p0">
                                    <ul class="nav navbar-nav">
                                        <li class="dropdown">
                                            <a href="#" class="dropdown-toggle" data-hover="dropdown" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">3.x <i class="fa fa-menu-en fa-chevron-down"></i></a>
                                            <ul class="dropdown-menu">
                                                <li><a href="https://book.cakephp.org/3.0/en">3.x Book</a></li>
                                                <li><a href="https://book.cakephp.org/2.0/en">2.x Book</a></li>
                                                <li><a href="https://book.cakephp.org/1.3/en/">1.3 Book</a></li>
                                                <li><a href="https://book.cakephp.org/1.2/en/">1.2 Book</a></li>
                                                <li><a href="https://book.cakephp.org/1.1/en">1.1 Book</a></li>
                                            </ul>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
            
        </section>
    </header>

    
    <section class="nav-btn visible-sm visible-xs">
        <div class="container">
            <div class="row">
                <div class="col-sm-6 col-xs-6 text-center">
                    <button id="btn-nav" class="btn btn-b btn-nav" data-toggle="modal" data-target="#modal"><strong>Nav</strong></button>
                </div>

                <div class="col-sm-6 col-xs-6 text-center">
                    <button id="btn-toc" class="btn btn-b btn-nav" data-toggle="modal" data-target="#modal"><strong>Table of Contents</strong></button>
                </div>
            </div>
        </div>
    </section>

    
    <div id="modal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="modal-header">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                    <h4 class="modal-title-cookbook" id="modal-header"></h4>
                </div>
                <div class="modal-body"></div>
            </div>
        </div>
    </div>

<div class="container page-container "><div id="improve-slideout">
        <i class="fa fa-pencil icon-improve"></i>
        <a href="https://github.com/cakephp/docs/edit/3.0/en/orm/query-builder.rst" target="_blank">
            <div id="improve-slideout-inner"><h6>Improve This Doc <i class="fa fa-github git-improve"></i></h6></div>
        </a>
    </div><a id="back-to-contents" href="#page-contents"><i class="fa fa-arrow-circle-up icon-improve" title="Back to Contents"></i></a>

    
    <div class="row">
        <div class="col-sm-12 col-md-9 col-md-push-3"><div class="page-contents col-sm-5">
                <h3>Page Contents</h3>
                <ul>
<li><a class="reference internal" href="#">Query Builder</a><ul>
<li><a class="reference internal" href="#the-query-object">The Query Object</a><ul>
<li><a class="reference internal" href="#selecting-rows-from-a-table">Selecting Rows From A Table</a></li>
<li><a class="reference internal" href="#selecting-a-single-row-from-a-table">Selecting A Single Row From A Table</a></li>
<li><a class="reference internal" href="#getting-a-list-of-values-from-a-column">Getting A List Of Values From A Column</a></li>
<li><a class="reference internal" href="#queries-are-collection-objects">Queries Are Collection Objects</a></li>
<li><a class="reference internal" href="#how-are-queries-lazily-evaluated">How Are Queries Lazily Evaluated</a></li>
</ul>
</li>
<li><a class="reference internal" href="#selecting-data">Selecting Data</a><ul>
<li><a class="reference internal" href="#selecting-all-fields-from-a-table">Selecting All Fields From a Table</a></li>
<li><a class="reference internal" href="#using-sql-functions">Using SQL Functions</a></li>
<li><a class="reference internal" href="#aggregates-group-and-having">Aggregates - Group and Having</a></li>
<li><a class="reference internal" href="#case-statements">Case statements</a></li>
<li><a class="reference internal" href="#getting-arrays-instead-of-entities">Getting Arrays Instead of Entities</a></li>
<li><a class="reference internal" href="#adding-calculated-fields">Adding Calculated Fields</a></li>
</ul>
</li>
<li><a class="reference internal" href="#advanced-conditions">Advanced Conditions</a><ul>
<li><a class="reference internal" href="#automatically-creating-in-clauses">Automatically Creating IN Clauses</a></li>
<li><a class="reference internal" href="#automatic-is-null-creation">Automatic IS NULL Creation</a></li>
<li><a class="reference internal" href="#automatic-is-not-null-creation">Automatic IS NOT NULL Creation</a></li>
<li><a class="reference internal" href="#raw-expressions">Raw Expressions</a></li>
</ul>
</li>
<li><a class="reference internal" href="#getting-results">Getting Results</a><ul>
<li><a class="reference internal" href="#returning-the-total-count-of-records">Returning the Total Count of Records</a></li>
<li><a class="reference internal" href="#caching-loaded-results">Caching Loaded Results</a></li>
</ul>
</li>
<li><a class="reference internal" href="#loading-associations">Loading Associations</a><ul>
<li><a class="reference internal" href="#passing-conditions-to-contain">Passing Conditions to Contain</a></li>
<li><a class="reference internal" href="#sorting-contained-associations">Sorting Contained Associations</a></li>
<li><a class="reference internal" href="#filtering-by-associated-data">Filtering by Associated Data</a></li>
<li><a class="reference internal" href="#using-innerjoinwith">Using innerJoinWith</a></li>
<li><a class="reference internal" href="#using-notmatching">Using notMatching</a></li>
<li><a class="reference internal" href="#using-leftjoinwith">Using leftJoinWith</a></li>
<li><a class="reference internal" href="#adding-joins">Adding Joins</a></li>
</ul>
</li>
<li><a class="reference internal" href="#inserting-data">Inserting Data</a></li>
<li><a class="reference internal" href="#updating-data">Updating Data</a></li>
<li><a class="reference internal" href="#deleting-data">Deleting Data</a></li>
<li><a class="reference internal" href="#sql-injection-prevention">SQL Injection Prevention</a><ul>
<li><a class="reference internal" href="#binding-values">Binding values</a></li>
</ul>
</li>
<li><a class="reference internal" href="#more-complex-queries">More Complex Queries</a><ul>
<li><a class="reference internal" href="#unions">Unions</a></li>
<li><a class="reference internal" href="#subqueries">Subqueries</a></li>
<li><a class="reference internal" href="#adding-locking-statements">Adding Locking Statements</a></li>
<li><a class="reference internal" href="#executing-complex-queries">Executing Complex Queries</a></li>
</ul>
</li>
</ul>
</li>
</ul>

            </div><div class="document-body">
            
  <div class="section" id="namespace-Cake\ORM">
<span id="query-builder"></span><h1>Query Builder<a class="headerlink" href="#namespace-Cake\ORM" title="Permalink to this headline">¶</a></h1>
<dl class="class">
<dt id="Cake\ORM\Query">
<em class="property">class </em><code class="descclassname">Cake\ORM\</code><code class="descname">Query</code><a class="headerlink" href="#Cake\ORM\Query" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<p>The ORM&#8217;s query builder provides a simple to use fluent interface for creating
and running queries. By composing queries together, you can create advanced
queries using unions and subqueries with ease.</p>
<p>Underneath the covers, the query builder uses PDO prepared statements which
protect against SQL injection attacks.</p>
<div class="section" id="the-query-object">
<h2>The Query Object<a class="headerlink" href="#the-query-object" title="Permalink to this headline">¶</a></h2>
<p>The easiest way to create a <code class="docutils literal"><span class="pre">Query</span></code> object is to use <code class="docutils literal"><span class="pre">find()</span></code> from a
<code class="docutils literal"><span class="pre">Table</span></code> object. This method will return an incomplete query ready to be
modified. You can also use a table&#8217;s connection object to access the lower level
Query builder that does not include ORM features, if necessary. See the
<a class="reference internal" href="database-basics.html#database-queries"><span class="std std-ref">Executing Queries</span></a> section for more information:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="k">use</span> <span class="nx">Cake\ORM\TableRegistry</span><span class="p">;</span>
<span class="nv">$articles</span> <span class="o">=</span> <span class="nx">TableRegistry</span><span class="o">::</span><span class="na">get</span><span class="p">(</span><span class="s1">&#39;Articles&#39;</span><span class="p">);</span>

<span class="c1">// Start a new query.</span>
<span class="nv">$query</span> <span class="o">=</span> <span class="nv">$articles</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">();</span>
</pre></div>
</div>
<p>When inside a controller, you can use the automatic table variable that is
created using the conventions system:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="c1">// Inside ArticlesController.php</span>

<span class="nv">$query</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">Articles</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">();</span>
</pre></div>
</div>
<div class="section" id="selecting-rows-from-a-table">
<h3>Selecting Rows From A Table<a class="headerlink" href="#selecting-rows-from-a-table" title="Permalink to this headline">¶</a></h3>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="k">use</span> <span class="nx">Cake\ORM\TableRegistry</span><span class="p">;</span>

<span class="nv">$query</span> <span class="o">=</span> <span class="nx">TableRegistry</span><span class="o">::</span><span class="na">get</span><span class="p">(</span><span class="s1">&#39;Articles&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">();</span>

<span class="k">foreach</span> <span class="p">(</span><span class="nv">$query</span> <span class="k">as</span> <span class="nv">$article</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">debug</span><span class="p">(</span><span class="nv">$article</span><span class="o">-&gt;</span><span class="na">title</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>For the remaining examples, assume that <code class="docutils literal"><span class="pre">$articles</span></code> is a
<a class="reference internal" href="retrieving-data-and-resultsets.html#Cake\ORM\Table" title="Cake\ORM\Table"><code class="xref php php-class docutils literal"><span class="pre">ORM\Table</span></code></a>. When inside controllers, you can use
<code class="docutils literal"><span class="pre">$this-&gt;Articles</span></code> instead of <code class="docutils literal"><span class="pre">$articles</span></code>.</p>
<p>Almost every method in a <code class="docutils literal"><span class="pre">Query</span></code> object will return the same query, this means
that <code class="docutils literal"><span class="pre">Query</span></code> objects are lazy, and will not be executed unless you tell them
to:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="nv">$query</span><span class="o">-&gt;</span><span class="na">where</span><span class="p">([</span><span class="s1">&#39;id&#39;</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">]);</span> <span class="c1">// Return the same query object</span>
<span class="nv">$query</span><span class="o">-&gt;</span><span class="na">order</span><span class="p">([</span><span class="s1">&#39;title&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;DESC&#39;</span><span class="p">]);</span> <span class="c1">// Still same object, no SQL executed</span>
</pre></div>
</div>
<p>You can of course chain the methods you call on Query objects:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="nv">$query</span> <span class="o">=</span> <span class="nv">$articles</span>
    <span class="o">-&gt;</span><span class="na">find</span><span class="p">()</span>
    <span class="o">-&gt;</span><span class="na">select</span><span class="p">([</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">])</span>
    <span class="o">-&gt;</span><span class="na">where</span><span class="p">([</span><span class="s1">&#39;id !=&#39;</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">])</span>
    <span class="o">-&gt;</span><span class="na">order</span><span class="p">([</span><span class="s1">&#39;created&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;DESC&#39;</span><span class="p">]);</span>

<span class="k">foreach</span> <span class="p">(</span><span class="nv">$query</span> <span class="k">as</span> <span class="nv">$article</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">debug</span><span class="p">(</span><span class="nv">$article</span><span class="o">-&gt;</span><span class="na">created</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>If you try to call <code class="docutils literal"><span class="pre">debug()</span></code> on a Query object, you will see its internal
state and the SQL that will be executed in the database:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="nx">debug</span><span class="p">(</span><span class="nv">$articles</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">where</span><span class="p">([</span><span class="s1">&#39;id&#39;</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">]));</span>

<span class="c1">// Outputs</span>
<span class="c1">// ...</span>
<span class="c1">// &#39;sql&#39; =&gt; &#39;SELECT * FROM articles where id = ?&#39;</span>
<span class="c1">// ...</span>
</pre></div>
</div>
<p>You can execute a query directly without having to use <code class="docutils literal"><span class="pre">foreach</span></code> on it.
The easiest way is to either call the <code class="docutils literal"><span class="pre">all()</span></code> or <code class="docutils literal"><span class="pre">toArray()</span></code> methods:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="nv">$resultsIteratorObject</span> <span class="o">=</span> <span class="nv">$articles</span>
    <span class="o">-&gt;</span><span class="na">find</span><span class="p">()</span>
    <span class="o">-&gt;</span><span class="na">where</span><span class="p">([</span><span class="s1">&#39;id &gt;&#39;</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">])</span>
    <span class="o">-&gt;</span><span class="na">all</span><span class="p">();</span>

<span class="k">foreach</span> <span class="p">(</span><span class="nv">$resultsIteratorObject</span> <span class="k">as</span> <span class="nv">$article</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">debug</span><span class="p">(</span><span class="nv">$article</span><span class="o">-&gt;</span><span class="na">id</span><span class="p">);</span>
<span class="p">}</span>

<span class="nv">$resultsArray</span> <span class="o">=</span> <span class="nv">$articles</span>
    <span class="o">-&gt;</span><span class="na">find</span><span class="p">()</span>
    <span class="o">-&gt;</span><span class="na">where</span><span class="p">([</span><span class="s1">&#39;id &gt;&#39;</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">])</span>
    <span class="o">-&gt;</span><span class="na">toArray</span><span class="p">();</span>

<span class="k">foreach</span> <span class="p">(</span><span class="nv">$resultsArray</span> <span class="k">as</span> <span class="nv">$article</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">debug</span><span class="p">(</span><span class="nv">$article</span><span class="o">-&gt;</span><span class="na">id</span><span class="p">);</span>
<span class="p">}</span>

<span class="nx">debug</span><span class="p">(</span><span class="nv">$resultsArray</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="na">title</span><span class="p">);</span>
</pre></div>
</div>
<p>In the above example, <code class="docutils literal"><span class="pre">$resultsIteratorObject</span></code> will be an instance of
<code class="docutils literal"><span class="pre">Cake\ORM\ResultSet</span></code>, an object you can iterate and apply several extracting
and traversing methods on.</p>
<p>Often, there is no need to call <code class="docutils literal"><span class="pre">all()</span></code>, you can simply iterate the
Query object to get its results. Query objects can also be used directly as the
result object; trying to iterate the query, calling <code class="docutils literal"><span class="pre">toArray()</span></code> or some of the
methods inherited from <a class="reference internal" href="../core-libraries/collections.html"><span class="doc">Collection</span></a>, will
result in the query being executed and results returned to you.</p>
</div>
<div class="section" id="selecting-a-single-row-from-a-table">
<h3>Selecting A Single Row From A Table<a class="headerlink" href="#selecting-a-single-row-from-a-table" title="Permalink to this headline">¶</a></h3>
<p>You can use the <code class="docutils literal"><span class="pre">first()</span></code> method to get the first result in the query:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="nv">$article</span> <span class="o">=</span> <span class="nv">$articles</span>
    <span class="o">-&gt;</span><span class="na">find</span><span class="p">()</span>
    <span class="o">-&gt;</span><span class="na">where</span><span class="p">([</span><span class="s1">&#39;id&#39;</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">])</span>
    <span class="o">-&gt;</span><span class="na">first</span><span class="p">();</span>

<span class="nx">debug</span><span class="p">(</span><span class="nv">$article</span><span class="o">-&gt;</span><span class="na">title</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="section" id="getting-a-list-of-values-from-a-column">
<h3>Getting A List Of Values From A Column<a class="headerlink" href="#getting-a-list-of-values-from-a-column" title="Permalink to this headline">¶</a></h3>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="c1">// Use the extract() method from the collections library</span>
<span class="c1">// This executes the query as well</span>
<span class="nv">$allTitles</span> <span class="o">=</span> <span class="nv">$articles</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">extract</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">);</span>

<span class="k">foreach</span> <span class="p">(</span><span class="nv">$allTitles</span> <span class="k">as</span> <span class="nv">$title</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">echo</span> <span class="nv">$title</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>You can also get a key-value list out of a query result:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="nv">$list</span> <span class="o">=</span> <span class="nv">$articles</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">(</span><span class="s1">&#39;list&#39;</span><span class="p">);</span>

<span class="k">foreach</span> <span class="p">(</span><span class="nv">$list</span> <span class="k">as</span> <span class="nv">$id</span> <span class="o">=&gt;</span> <span class="nv">$title</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">echo</span> <span class="s2">&quot;</span><span class="si">$id</span><span class="s2"> : </span><span class="si">$title</span><span class="s2">&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>For more information on how to customize the fields used for populating the list
refer to <a class="reference internal" href="retrieving-data-and-resultsets.html#table-find-list"><span class="std std-ref">Finding Key/Value Pairs</span></a> section.</p>
</div>
<div class="section" id="queries-are-collection-objects">
<h3>Queries Are Collection Objects<a class="headerlink" href="#queries-are-collection-objects" title="Permalink to this headline">¶</a></h3>
<p>Once you get familiar with the Query object methods, it is strongly encouraged
that you visit the <a class="reference internal" href="../core-libraries/collections.html"><span class="doc">Collection</span></a> section to
improve your skills in efficiently traversing the data. In short, it is
important to remember that anything you can call on a Collection object, you
can also do in a Query object:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="c1">// Use the combine() method from the collections library</span>
<span class="c1">// This is equivalent to find(&#39;list&#39;)</span>
<span class="nv">$keyValueList</span> <span class="o">=</span> <span class="nv">$articles</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">combine</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;title&#39;</span><span class="p">);</span>

<span class="c1">// An advanced example</span>
<span class="nv">$results</span> <span class="o">=</span> <span class="nv">$articles</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">()</span>
    <span class="o">-&gt;</span><span class="na">where</span><span class="p">([</span><span class="s1">&#39;id &gt;&#39;</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">])</span>
    <span class="o">-&gt;</span><span class="na">order</span><span class="p">([</span><span class="s1">&#39;title&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;DESC&#39;</span><span class="p">])</span>
    <span class="o">-&gt;</span><span class="na">map</span><span class="p">(</span><span class="k">function</span> <span class="p">(</span><span class="nv">$row</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// map() is a collection method, it executes the query</span>
        <span class="nv">$row</span><span class="o">-&gt;</span><span class="na">trimmedTitle</span> <span class="o">=</span> <span class="nb">trim</span><span class="p">(</span><span class="nv">$row</span><span class="o">-&gt;</span><span class="na">title</span><span class="p">);</span>
        <span class="k">return</span> <span class="nv">$row</span><span class="p">;</span>
    <span class="p">})</span>
    <span class="o">-&gt;</span><span class="na">combine</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;trimmedTitle&#39;</span><span class="p">)</span> <span class="c1">// combine() is another collection method</span>
    <span class="o">-&gt;</span><span class="na">toArray</span><span class="p">();</span> <span class="c1">// Also a collections library method</span>

<span class="k">foreach</span> <span class="p">(</span><span class="nv">$results</span> <span class="k">as</span> <span class="nv">$id</span> <span class="o">=&gt;</span> <span class="nv">$trimmedTitle</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">echo</span> <span class="s2">&quot;</span><span class="si">$id</span><span class="s2"> : </span><span class="si">$trimmedTitle</span><span class="s2">&quot;</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="how-are-queries-lazily-evaluated">
<h3>How Are Queries Lazily Evaluated<a class="headerlink" href="#how-are-queries-lazily-evaluated" title="Permalink to this headline">¶</a></h3>
<p>Query objects are lazily evaluated. This means a query is not executed until one
of the following things occur:</p>
<ul class="simple">
<li>The query is iterated with <code class="docutils literal"><span class="pre">foreach()</span></code>.</li>
<li>The query&#8217;s <code class="docutils literal"><span class="pre">execute()</span></code> method is called. This will return the underlying
statement object, and is to be used with insert/update/delete queries.</li>
<li>The query&#8217;s <code class="docutils literal"><span class="pre">first()</span></code> method is called. This will return the first result in the set
built by <code class="docutils literal"><span class="pre">SELECT</span></code> (it adds <code class="docutils literal"><span class="pre">LIMIT</span> <span class="pre">1</span></code> to the query).</li>
<li>The query&#8217;s <code class="docutils literal"><span class="pre">all()</span></code> method is called. This will return the result set and
can only be used with <code class="docutils literal"><span class="pre">SELECT</span></code> statements.</li>
<li>The query&#8217;s <code class="docutils literal"><span class="pre">toArray()</span></code> method is called.</li>
</ul>
<p>Until one of these conditions are met, the query can be modified without additional
SQL being sent to the database. It also means that if a Query hasn&#8217;t been
evaluated, no SQL is ever sent to the database. Once executed, modifying and
re-evaluating a query will result in additional SQL being run.</p>
<p>If you want to take a look at what SQL CakePHP is generating, you can turn
database <a class="reference internal" href="database-basics.html#database-query-logging"><span class="std std-ref">query logging</span></a> on.</p>
<p>The following sections will show you everything there is to know about using and
combining the Query object methods to construct SQL statements and extract data.</p>
</div>
</div>
<div class="section" id="selecting-data">
<h2>Selecting Data<a class="headerlink" href="#selecting-data" title="Permalink to this headline">¶</a></h2>
<p>Most web applications make heavy use of <code class="docutils literal"><span class="pre">SELECT</span></code> queries. CakePHP makes
building them a snap. To limit the fields fetched, you can use the <code class="docutils literal"><span class="pre">select()</span></code>
method:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="nv">$query</span> <span class="o">=</span> <span class="nv">$articles</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">();</span>
<span class="nv">$query</span><span class="o">-&gt;</span><span class="na">select</span><span class="p">([</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="s1">&#39;body&#39;</span><span class="p">]);</span>
<span class="k">foreach</span> <span class="p">(</span><span class="nv">$query</span> <span class="k">as</span> <span class="nv">$row</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">debug</span><span class="p">(</span><span class="nv">$row</span><span class="o">-&gt;</span><span class="na">title</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>You can set aliases for fields by providing fields as an associative array:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="c1">// Results in SELECT id AS pk, title AS aliased_title, body ...</span>
<span class="nv">$query</span> <span class="o">=</span> <span class="nv">$articles</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">();</span>
<span class="nv">$query</span><span class="o">-&gt;</span><span class="na">select</span><span class="p">([</span><span class="s1">&#39;pk&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;aliased_title&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="s1">&#39;body&#39;</span><span class="p">]);</span>
</pre></div>
</div>
<p>To select distinct fields, you can use the <code class="docutils literal"><span class="pre">distinct()</span></code> method:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="c1">// Results in SELECT DISTINCT country FROM ...</span>
<span class="nv">$query</span> <span class="o">=</span> <span class="nv">$articles</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">();</span>
<span class="nv">$query</span><span class="o">-&gt;</span><span class="na">select</span><span class="p">([</span><span class="s1">&#39;country&#39;</span><span class="p">])</span>
    <span class="o">-&gt;</span><span class="na">distinct</span><span class="p">([</span><span class="s1">&#39;country&#39;</span><span class="p">]);</span>
</pre></div>
</div>
<p>To set some basic conditions you can use the <code class="docutils literal"><span class="pre">where()</span></code> method:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="c1">// Conditions are combined with AND</span>
<span class="nv">$query</span> <span class="o">=</span> <span class="nv">$articles</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">();</span>
<span class="nv">$query</span><span class="o">-&gt;</span><span class="na">where</span><span class="p">([</span><span class="s1">&#39;title&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;First Post&#39;</span><span class="p">,</span> <span class="s1">&#39;published&#39;</span> <span class="o">=&gt;</span> <span class="k">true</span><span class="p">]);</span>

<span class="c1">// You can call where() multiple times</span>
<span class="nv">$query</span> <span class="o">=</span> <span class="nv">$articles</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">();</span>
<span class="nv">$query</span><span class="o">-&gt;</span><span class="na">where</span><span class="p">([</span><span class="s1">&#39;title&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;First Post&#39;</span><span class="p">])</span>
    <span class="o">-&gt;</span><span class="na">where</span><span class="p">([</span><span class="s1">&#39;published&#39;</span> <span class="o">=&gt;</span> <span class="k">true</span><span class="p">]);</span>
</pre></div>
</div>
<p>See the <a class="reference internal" href="#advanced-query-conditions"><span class="std std-ref">Advanced Conditions</span></a> section to find out how to construct
more complex <code class="docutils literal"><span class="pre">WHERE</span></code> conditions. To apply ordering, you can use the <code class="docutils literal"><span class="pre">order</span></code>
method:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="nv">$query</span> <span class="o">=</span> <span class="nv">$articles</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">()</span>
    <span class="o">-&gt;</span><span class="na">order</span><span class="p">([</span><span class="s1">&#39;title&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;ASC&#39;</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;ASC&#39;</span><span class="p">]);</span>
</pre></div>
</div>
<p>When calling <code class="docutils literal"><span class="pre">order()</span></code> multiple times on a query, multiple clauses will be appended.
However, when using finders you may sometimes need to overwrite the <code class="docutils literal"><span class="pre">ORDER</span> <span class="pre">BY</span></code>.
Set the second parameter of <code class="docutils literal"><span class="pre">order()</span></code> (as well as <code class="docutils literal"><span class="pre">orderAsc()</span></code> or <code class="docutils literal"><span class="pre">orderDesc()</span></code>) to
<code class="docutils literal"><span class="pre">Query::OVERWRITE</span></code> or to <code class="docutils literal"><span class="pre">true</span></code>:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="nv">$query</span> <span class="o">=</span> <span class="nv">$articles</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">()</span>
    <span class="o">-&gt;</span><span class="na">order</span><span class="p">([</span><span class="s1">&#39;title&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;ASC&#39;</span><span class="p">]);</span>
<span class="c1">// Later, overwrite the ORDER BY clause instead of appending to it.</span>
<span class="nv">$query</span> <span class="o">=</span> <span class="nv">$articles</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">()</span>
    <span class="o">-&gt;</span><span class="na">order</span><span class="p">([</span><span class="s1">&#39;created&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;DESC&#39;</span><span class="p">],</span> <span class="nx">Query</span><span class="o">::</span><span class="na">OVERWRITE</span><span class="p">);</span>
</pre></div>
</div>
<div class="versionadded">
<p><span class="versionmodified">New in version 3.0.12: </span>In addition to <code class="docutils literal"><span class="pre">order</span></code>, the <code class="docutils literal"><span class="pre">orderAsc</span></code> and <code class="docutils literal"><span class="pre">orderDesc</span></code> methods can be
used when you need to sort on complex expressions:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="nv">$query</span> <span class="o">=</span> <span class="nv">$articles</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">();</span>
<span class="nv">$concat</span> <span class="o">=</span> <span class="nv">$query</span><span class="o">-&gt;</span><span class="na">func</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">concat</span><span class="p">([</span>
    <span class="s1">&#39;title&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;identifier&#39;</span><span class="p">,</span>
    <span class="s1">&#39;synopsis&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;identifier&#39;</span>
<span class="p">]);</span>
<span class="nv">$query</span><span class="o">-&gt;</span><span class="na">orderAsc</span><span class="p">(</span><span class="nv">$concat</span><span class="p">);</span>
</pre></div>
</div>
</div>
<p>To limit the number of rows or set the row offset you can use the <code class="docutils literal"><span class="pre">limit()</span></code>
and <code class="docutils literal"><span class="pre">page()</span></code> methods:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="c1">// Fetch rows 50 to 100</span>
<span class="nv">$query</span> <span class="o">=</span> <span class="nv">$articles</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">()</span>
    <span class="o">-&gt;</span><span class="na">limit</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span>
    <span class="o">-&gt;</span><span class="na">page</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
</pre></div>
</div>
<p>As you can see from the examples above, all the methods that modify the query
provide a fluent interface, allowing you to build a query through chained method
calls.</p>
<div class="section" id="selecting-all-fields-from-a-table">
<h3>Selecting All Fields From a Table<a class="headerlink" href="#selecting-all-fields-from-a-table" title="Permalink to this headline">¶</a></h3>
<p>By default a query will select all fields from a table, the exception is when you
call the <code class="docutils literal"><span class="pre">select()</span></code> function yourself and pass certain fields:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="c1">// Only select id and title from the articles table</span>
<span class="nv">$articles</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">select</span><span class="p">([</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;title&#39;</span><span class="p">]);</span>
</pre></div>
</div>
<p>If you wish to still select all fields from a table after having called
<code class="docutils literal"><span class="pre">select($fields)</span></code>, you can pass the table instance to <code class="docutils literal"><span class="pre">select()</span></code> for this
purpose:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="c1">// Only all fields from the articles table including</span>
<span class="c1">// a calculated slug field.</span>
<span class="nv">$query</span> <span class="o">=</span> <span class="nv">$articlesTable</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">();</span>
<span class="nv">$query</span>
    <span class="o">-&gt;</span><span class="na">select</span><span class="p">([</span><span class="s1">&#39;slug&#39;</span> <span class="o">=&gt;</span> <span class="nv">$query</span><span class="o">-&gt;</span><span class="na">func</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">concat</span><span class="p">([</span><span class="s1">&#39;title&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;identifier&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;identifier&#39;</span><span class="p">])])</span>
    <span class="o">-&gt;</span><span class="na">select</span><span class="p">(</span><span class="nv">$articlesTable</span><span class="p">);</span> <span class="c1">// Select all fields from articles</span>
</pre></div>
</div>
<div class="versionadded">
<p><span class="versionmodified">New in version 3.1: </span>Passing a table object to select() was added in 3.1.</p>
</div>
</div>
<div class="section" id="using-sql-functions">
<span id="id1"></span><h3>Using SQL Functions<a class="headerlink" href="#using-sql-functions" title="Permalink to this headline">¶</a></h3>
<p>CakePHP&#8217;s ORM offers abstraction for some commonly used SQL functions. Using the
abstraction allows the ORM to select the platform specific implementation of the
function you want. For example, <code class="docutils literal"><span class="pre">concat</span></code> is implemented differently in MySQL,
PostgreSQL and SQL Server. Using the abstraction allows your code to be
portable:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="c1">// Results in SELECT COUNT(*) count FROM ...</span>
<span class="nv">$query</span> <span class="o">=</span> <span class="nv">$articles</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">();</span>
<span class="nv">$query</span><span class="o">-&gt;</span><span class="na">select</span><span class="p">([</span><span class="s1">&#39;count&#39;</span> <span class="o">=&gt;</span> <span class="nv">$query</span><span class="o">-&gt;</span><span class="na">func</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">count</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">)]);</span>
</pre></div>
</div>
<p>A number of commonly used functions can be created with the <code class="docutils literal"><span class="pre">func()</span></code> method:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">sum()</span></code> Calculate a sum. The arguments will be treated as literal values.</li>
<li><code class="docutils literal"><span class="pre">avg()</span></code> Calculate an average. The arguments will be treated as literal
values.</li>
<li><code class="docutils literal"><span class="pre">min()</span></code> Calculate the min of a column. The arguments will be treated as
literal values.</li>
<li><code class="docutils literal"><span class="pre">max()</span></code> Calculate the max of a column. The arguments will be treated as
literal values.</li>
<li><code class="docutils literal"><span class="pre">count()</span></code> Calculate the count. The arguments will be treated as literal
values.</li>
<li><code class="docutils literal"><span class="pre">concat()</span></code> Concatenate two values together. The arguments are treated as
bound parameters unless marked as literal.</li>
<li><code class="docutils literal"><span class="pre">coalesce()</span></code> Coalesce values. The arguments are treated as bound parameters
unless marked as literal.</li>
<li><code class="docutils literal"><span class="pre">dateDiff()</span></code> Get the difference between two dates/times. The arguments are
treated as bound parameters unless marked as literal.</li>
<li><code class="docutils literal"><span class="pre">now()</span></code> Take either &#8216;time&#8217; or &#8216;date&#8217; as an argument allowing you to get
either the current time, or current date.</li>
<li><code class="docutils literal"><span class="pre">extract()</span></code> Returns the specified date part from the SQL expression.</li>
<li><code class="docutils literal"><span class="pre">dateAdd()</span></code> Add the time unit to the date expression.</li>
<li><code class="docutils literal"><span class="pre">dayOfWeek()</span></code> Returns a FunctionExpression representing a call to SQL
WEEKDAY function.</li>
</ul>
<div class="versionadded">
<p><span class="versionmodified">New in version 3.1: </span><code class="docutils literal"><span class="pre">extract()</span></code>, <code class="docutils literal"><span class="pre">dateAdd()</span></code> and <code class="docutils literal"><span class="pre">dayOfWeek()</span></code> methods have been added.</p>
</div>
<p>When providing arguments for SQL functions, there are two kinds of parameters
you can use, literal arguments and bound parameters. Identifier/Literal parameters allow
you to reference columns or other SQL literals. Bound parameters can be used to
safely add user data to SQL functions. For example:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="nv">$query</span> <span class="o">=</span> <span class="nv">$articles</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">innerJoinWith</span><span class="p">(</span><span class="s1">&#39;Categories&#39;</span><span class="p">);</span>
<span class="nv">$concat</span> <span class="o">=</span> <span class="nv">$query</span><span class="o">-&gt;</span><span class="na">func</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">concat</span><span class="p">([</span>
    <span class="s1">&#39;Articles.title&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;identifier&#39;</span><span class="p">,</span>
    <span class="s1">&#39; - CAT: &#39;</span><span class="p">,</span>
    <span class="s1">&#39;Categories.name&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;identifier&#39;</span><span class="p">,</span>
    <span class="s1">&#39; - Age: &#39;</span><span class="p">,</span>
    <span class="s1">&#39;(DATEDIFF(NOW(), Articles.created))&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;literal&#39;</span><span class="p">,</span>
<span class="p">]);</span>
<span class="nv">$query</span><span class="o">-&gt;</span><span class="na">select</span><span class="p">([</span><span class="s1">&#39;link_title&#39;</span> <span class="o">=&gt;</span> <span class="nv">$concat</span><span class="p">]);</span>
</pre></div>
</div>
<p>By making arguments with a value of <code class="docutils literal"><span class="pre">literal</span></code>, the ORM will know that
the key should be treated as a literal SQL value. By making arguments with
a value of <code class="docutils literal"><span class="pre">identifier</span></code>, the ORM will know that the key should be treated
as a field identifier. The above would generate the following SQL on MySQL:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="nx">SELECT</span> <span class="nx">CONCAT</span><span class="p">(</span><span class="nx">Articles</span><span class="o">.</span><span class="nx">title</span><span class="p">,</span> <span class="o">:</span><span class="nx">c0</span><span class="p">,</span> <span class="nx">Categories</span><span class="o">.</span><span class="nx">name</span><span class="p">,</span> <span class="o">:</span><span class="nx">c1</span><span class="p">,</span> <span class="p">(</span><span class="nx">DATEDIFF</span><span class="p">(</span><span class="nx">NOW</span><span class="p">(),</span> <span class="nx">Articles</span><span class="o">.</span><span class="nx">created</span><span class="p">)))</span> <span class="nx">FROM</span> <span class="nx">articles</span><span class="p">;</span>
</pre></div>
</div>
<p>The <code class="docutils literal"><span class="pre">:c0</span></code> value will have the <code class="docutils literal"><span class="pre">'</span> <span class="pre">-</span> <span class="pre">CAT:'</span></code> text bound when the query is
executed.</p>
<p>In addition to the above functions, the <code class="docutils literal"><span class="pre">func()</span></code> method can be used to create
any generic SQL function such as <code class="docutils literal"><span class="pre">year</span></code>, <code class="docutils literal"><span class="pre">date_format</span></code>, <code class="docutils literal"><span class="pre">convert</span></code>, etc.
For example:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="nv">$query</span> <span class="o">=</span> <span class="nv">$articles</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">();</span>
<span class="nv">$year</span> <span class="o">=</span> <span class="nv">$query</span><span class="o">-&gt;</span><span class="na">func</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">year</span><span class="p">([</span>
    <span class="s1">&#39;created&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;identifier&#39;</span>
<span class="p">]);</span>
<span class="nv">$time</span> <span class="o">=</span> <span class="nv">$query</span><span class="o">-&gt;</span><span class="na">func</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">date_format</span><span class="p">([</span>
    <span class="s1">&#39;created&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;identifier&#39;</span><span class="p">,</span>
    <span class="s2">&quot;&#39;%H:%i&#39;&quot;</span> <span class="o">=&gt;</span> <span class="s1">&#39;literal&#39;</span>
<span class="p">]);</span>
<span class="nv">$query</span><span class="o">-&gt;</span><span class="na">select</span><span class="p">([</span>
    <span class="s1">&#39;yearCreated&#39;</span> <span class="o">=&gt;</span> <span class="nv">$year</span><span class="p">,</span>
    <span class="s1">&#39;timeCreated&#39;</span> <span class="o">=&gt;</span> <span class="nv">$time</span>
<span class="p">]);</span>
</pre></div>
</div>
<p>Would result in:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="nx">SELECT</span> <span class="nx">YEAR</span><span class="p">(</span><span class="nx">created</span><span class="p">)</span> <span class="k">as</span> <span class="nx">yearCreated</span><span class="p">,</span> <span class="nx">DATE_FORMAT</span><span class="p">(</span><span class="nx">created</span><span class="p">,</span> <span class="s1">&#39;%H:%i&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="nx">timeCreated</span> <span class="nx">FROM</span> <span class="nx">articles</span><span class="p">;</span>
</pre></div>
</div>
<p>You should remember to use the function builder whenever you need to put
untrusted data into SQL functions or stored procedures:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="c1">// Use a stored procedure</span>
<span class="nv">$query</span> <span class="o">=</span> <span class="nv">$articles</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">();</span>
<span class="nv">$lev</span> <span class="o">=</span> <span class="nv">$query</span><span class="o">-&gt;</span><span class="na">func</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">levenshtein</span><span class="p">([</span><span class="nv">$search</span><span class="p">,</span> <span class="s1">&#39;LOWER(title)&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;literal&#39;</span><span class="p">]);</span>
<span class="nv">$query</span><span class="o">-&gt;</span><span class="na">where</span><span class="p">(</span><span class="k">function</span> <span class="p">(</span><span class="nv">$exp</span><span class="p">)</span> <span class="k">use</span> <span class="p">(</span><span class="nv">$lev</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nv">$exp</span><span class="o">-&gt;</span><span class="na">between</span><span class="p">(</span><span class="nv">$lev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nv">$tolerance</span><span class="p">);</span>
<span class="p">});</span>

<span class="c1">// Generated SQL would be</span>
<span class="nx">WHERE</span> <span class="nb">levenshtein</span><span class="p">(</span><span class="o">:</span><span class="nx">c0</span><span class="p">,</span> <span class="nx">lower</span><span class="p">(</span><span class="nx">street</span><span class="p">))</span> <span class="nx">BETWEEN</span> <span class="o">:</span><span class="nx">c1</span> <span class="k">AND</span> <span class="o">:</span><span class="nx">c2</span>
</pre></div>
</div>
</div>
<div class="section" id="aggregates-group-and-having">
<h3>Aggregates - Group and Having<a class="headerlink" href="#aggregates-group-and-having" title="Permalink to this headline">¶</a></h3>
<p>When using aggregate functions like <code class="docutils literal"><span class="pre">count</span></code> and <code class="docutils literal"><span class="pre">sum</span></code> you may want to use
<code class="docutils literal"><span class="pre">group</span> <span class="pre">by</span></code> and <code class="docutils literal"><span class="pre">having</span></code> clauses:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="nv">$query</span> <span class="o">=</span> <span class="nv">$articles</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">();</span>
<span class="nv">$query</span><span class="o">-&gt;</span><span class="na">select</span><span class="p">([</span>
    <span class="s1">&#39;count&#39;</span> <span class="o">=&gt;</span> <span class="nv">$query</span><span class="o">-&gt;</span><span class="na">func</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">count</span><span class="p">(</span><span class="s1">&#39;view_count&#39;</span><span class="p">),</span>
    <span class="s1">&#39;published_date&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;DATE(created)&#39;</span>
<span class="p">])</span>
<span class="o">-&gt;</span><span class="na">group</span><span class="p">(</span><span class="s1">&#39;published_date&#39;</span><span class="p">)</span>
<span class="o">-&gt;</span><span class="na">having</span><span class="p">([</span><span class="s1">&#39;count &gt;&#39;</span> <span class="o">=&gt;</span> <span class="mi">3</span><span class="p">]);</span>
</pre></div>
</div>
</div>
<div class="section" id="case-statements">
<h3>Case statements<a class="headerlink" href="#case-statements" title="Permalink to this headline">¶</a></h3>
<p>The ORM also offers the SQL <code class="docutils literal"><span class="pre">case</span></code> expression. The <code class="docutils literal"><span class="pre">case</span></code> expression allows
for implementing <code class="docutils literal"><span class="pre">if</span> <span class="pre">...</span> <span class="pre">then</span> <span class="pre">...</span> <span class="pre">else</span></code> logic inside your SQL. This can be useful
for reporting on data where you need to conditionally sum or count data, or where you
need to specific data based on a condition.</p>
<p>If we wished to know how many published articles are in our database, we could use the following SQL:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="nx">SELECT</span>
<span class="nx">COUNT</span><span class="p">(</span><span class="k">CASE</span> <span class="nx">WHEN</span> <span class="nx">published</span> <span class="o">=</span> <span class="s1">&#39;Y&#39;</span> <span class="nx">THEN</span> <span class="mi">1</span> <span class="nx">END</span><span class="p">)</span> <span class="k">AS</span> <span class="nx">number_published</span><span class="p">,</span>
<span class="nx">COUNT</span><span class="p">(</span><span class="k">CASE</span> <span class="nx">WHEN</span> <span class="nx">published</span> <span class="o">=</span> <span class="s1">&#39;N&#39;</span> <span class="nx">THEN</span> <span class="mi">1</span> <span class="nx">END</span><span class="p">)</span> <span class="k">AS</span> <span class="nx">number_unpublished</span>
<span class="nx">FROM</span> <span class="nx">articles</span>
</pre></div>
</div>
<p>To do this with the query builder, we&#8217;d use the following code:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="nv">$query</span> <span class="o">=</span> <span class="nv">$articles</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">();</span>
<span class="nv">$publishedCase</span> <span class="o">=</span> <span class="nv">$query</span><span class="o">-&gt;</span><span class="na">newExpr</span><span class="p">()</span>
    <span class="o">-&gt;</span><span class="na">addCase</span><span class="p">(</span>
        <span class="nv">$query</span><span class="o">-&gt;</span><span class="na">newExpr</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">add</span><span class="p">([</span><span class="s1">&#39;published&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Y&#39;</span><span class="p">]),</span>
        <span class="mi">1</span><span class="p">,</span>
        <span class="s1">&#39;integer&#39;</span>
    <span class="p">);</span>
<span class="nv">$unpublishedCase</span> <span class="o">=</span> <span class="nv">$query</span><span class="o">-&gt;</span><span class="na">newExpr</span><span class="p">()</span>
    <span class="o">-&gt;</span><span class="na">addCase</span><span class="p">(</span>
        <span class="nv">$query</span><span class="o">-&gt;</span><span class="na">newExpr</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">add</span><span class="p">([</span><span class="s1">&#39;published&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;N&#39;</span><span class="p">]),</span>
        <span class="mi">1</span><span class="p">,</span>
        <span class="s1">&#39;integer&#39;</span>
    <span class="p">);</span>

<span class="nv">$query</span><span class="o">-&gt;</span><span class="na">select</span><span class="p">([</span>
    <span class="s1">&#39;number_published&#39;</span> <span class="o">=&gt;</span> <span class="nv">$query</span><span class="o">-&gt;</span><span class="na">func</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">count</span><span class="p">(</span><span class="nv">$publishedCase</span><span class="p">),</span>
    <span class="s1">&#39;number_unpublished&#39;</span> <span class="o">=&gt;</span> <span class="nv">$query</span><span class="o">-&gt;</span><span class="na">func</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">count</span><span class="p">(</span><span class="nv">$unpublishedCase</span><span class="p">)</span>
<span class="p">]);</span>
</pre></div>
</div>
<p>The <code class="docutils literal"><span class="pre">addCase</span></code> function can also chain together multiple statements to create
<code class="docutils literal"><span class="pre">if</span> <span class="pre">..</span> <span class="pre">then</span> <span class="pre">..</span> <span class="pre">[elseif</span> <span class="pre">..</span> <span class="pre">then</span> <span class="pre">..</span> <span class="pre">]</span> <span class="pre">[</span> <span class="pre">..</span> <span class="pre">else</span> <span class="pre">]</span></code> logic inside your SQL.</p>
<p>If we wanted to classify cities into SMALL, MEDIUM, or LARGE based on population
size, we could do the following:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="nv">$query</span> <span class="o">=</span> <span class="nv">$cities</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">()</span>
    <span class="o">-&gt;</span><span class="na">where</span><span class="p">(</span><span class="k">function</span> <span class="p">(</span><span class="nv">$exp</span><span class="p">,</span> <span class="nv">$q</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$exp</span><span class="o">-&gt;</span><span class="na">addCase</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="nv">$q</span><span class="o">-&gt;</span><span class="na">newExpr</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">lt</span><span class="p">(</span><span class="s1">&#39;population&#39;</span><span class="p">,</span> <span class="mi">100000</span><span class="p">),</span>
                <span class="nv">$q</span><span class="o">-&gt;</span><span class="na">newExpr</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">between</span><span class="p">(</span><span class="s1">&#39;population&#39;</span><span class="p">,</span> <span class="mi">100000</span><span class="p">,</span> <span class="mi">999000</span><span class="p">),</span>
                <span class="nv">$q</span><span class="o">-&gt;</span><span class="na">newExpr</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">gte</span><span class="p">(</span><span class="s1">&#39;population&#39;</span><span class="p">,</span> <span class="mi">999001</span><span class="p">),</span>
            <span class="p">],</span>
            <span class="p">[</span><span class="s1">&#39;SMALL&#39;</span><span class="p">,</span>  <span class="s1">&#39;MEDIUM&#39;</span><span class="p">,</span> <span class="s1">&#39;LARGE&#39;</span><span class="p">],</span> <span class="c1"># values matching conditions</span>
            <span class="p">[</span><span class="s1">&#39;string&#39;</span><span class="p">,</span> <span class="s1">&#39;string&#39;</span><span class="p">,</span> <span class="s1">&#39;string&#39;</span><span class="p">]</span> <span class="c1"># type of each value</span>
        <span class="p">);</span>
    <span class="p">});</span>
<span class="c1"># WHERE CASE</span>
<span class="c1">#   WHEN population &lt; 100000 THEN &#39;SMALL&#39;</span>
<span class="c1">#   WHEN population BETWEEN 100000 AND 999000 THEN &#39;MEDIUM&#39;</span>
<span class="c1">#   WHEN population &gt;= 999001 THEN &#39;LARGE&#39;</span>
<span class="c1">#   END</span>
</pre></div>
</div>
<p>Any time there are fewer case conditions than values, <code class="docutils literal"><span class="pre">addCase</span></code> will
automatically produce an <code class="docutils literal"><span class="pre">if</span> <span class="pre">..</span> <span class="pre">then</span> <span class="pre">..</span> <span class="pre">else</span></code> statement:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="nv">$query</span> <span class="o">=</span> <span class="nv">$cities</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">()</span>
    <span class="o">-&gt;</span><span class="na">where</span><span class="p">(</span><span class="k">function</span> <span class="p">(</span><span class="nv">$exp</span><span class="p">,</span> <span class="nv">$q</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$exp</span><span class="o">-&gt;</span><span class="na">addCase</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="nv">$q</span><span class="o">-&gt;</span><span class="na">newExpr</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">eq</span><span class="p">(</span><span class="s1">&#39;population&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
            <span class="p">],</span>
            <span class="p">[</span><span class="s1">&#39;DESERTED&#39;</span><span class="p">,</span> <span class="s1">&#39;INHABITED&#39;</span><span class="p">],</span> <span class="c1"># values matching conditions</span>
            <span class="p">[</span><span class="s1">&#39;string&#39;</span><span class="p">,</span> <span class="s1">&#39;string&#39;</span><span class="p">]</span> <span class="c1"># type of each value</span>
        <span class="p">);</span>
    <span class="p">});</span>
<span class="c1"># WHERE CASE</span>
<span class="c1">#   WHEN population = 0 THEN &#39;DESERTED&#39; ELSE &#39;INHABITED&#39; END</span>
</pre></div>
</div>
</div>
<div class="section" id="getting-arrays-instead-of-entities">
<h3>Getting Arrays Instead of Entities<a class="headerlink" href="#getting-arrays-instead-of-entities" title="Permalink to this headline">¶</a></h3>
<p>While ORMs and object result sets are powerful, creating entities is sometimes
unnecessary. For example, when accessing aggregated data, building an Entity may
not make sense. The process of converting the database results to entities is
called hydration. If you wish to disable this process you can do this:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="nv">$query</span> <span class="o">=</span> <span class="nv">$articles</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">();</span>
<span class="nv">$query</span><span class="o">-&gt;</span><span class="na">hydrate</span><span class="p">(</span><span class="k">false</span><span class="p">);</span> <span class="c1">// Results as arrays intead of entities</span>
<span class="nv">$result</span> <span class="o">=</span> <span class="nv">$query</span><span class="o">-&gt;</span><span class="na">toList</span><span class="p">();</span> <span class="c1">// Execute the query and return the array</span>
</pre></div>
</div>
<p>After executing those lines, your result should look similar to this:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="p">[</span>
    <span class="p">[</span><span class="s1">&#39;id&#39;</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;title&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;First Article&#39;</span><span class="p">,</span> <span class="s1">&#39;body&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Article 1 body&#39;</span> <span class="o">...</span><span class="p">],</span>
    <span class="p">[</span><span class="s1">&#39;id&#39;</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;title&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Second Article&#39;</span><span class="p">,</span> <span class="s1">&#39;body&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Article 2 body&#39;</span> <span class="o">...</span><span class="p">],</span>
    <span class="o">...</span>
<span class="p">]</span>
</pre></div>
</div>
</div>
<div class="section" id="adding-calculated-fields">
<span id="format-results"></span><h3>Adding Calculated Fields<a class="headerlink" href="#adding-calculated-fields" title="Permalink to this headline">¶</a></h3>
<p>After your queries, you may need to do some post-processing. If you need to add
a few calculated fields or derived data, you can use the <code class="docutils literal"><span class="pre">formatResults()</span></code>
method. This is a lightweight way to map over the result sets. If you need more
control over the process, or want to reduce results you should use
the <a class="reference internal" href="retrieving-data-and-resultsets.html#map-reduce"><span class="std std-ref">Map/Reduce</span></a> feature instead. If you were querying a list
of people, you could calculate their age with a result formatter:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="c1">// Assuming we have built the fields, conditions and containments.</span>
<span class="nv">$query</span><span class="o">-&gt;</span><span class="na">formatResults</span><span class="p">(</span><span class="k">function</span> <span class="p">(</span><span class="nx">\Cake\Collection\CollectionInterface</span> <span class="nv">$results</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nv">$results</span><span class="o">-&gt;</span><span class="na">map</span><span class="p">(</span><span class="k">function</span> <span class="p">(</span><span class="nv">$row</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$row</span><span class="p">[</span><span class="s1">&#39;age&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$row</span><span class="p">[</span><span class="s1">&#39;birth_date&#39;</span><span class="p">]</span><span class="o">-&gt;</span><span class="na">diff</span><span class="p">(</span><span class="k">new</span> <span class="nx">\DateTime</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">y</span><span class="p">;</span>
        <span class="k">return</span> <span class="nv">$row</span><span class="p">;</span>
    <span class="p">});</span>
<span class="p">});</span>
</pre></div>
</div>
<p>As you can see in the example above, formatting callbacks will get a
<code class="docutils literal"><span class="pre">ResultSetDecorator</span></code> as their first argument. The second argument will be
the Query instance the formatter was attached to. The <code class="docutils literal"><span class="pre">$results</span></code> argument can
be traversed and modified as necessary.</p>
<p>Result formatters are required to return an iterator object, which will be used
as the return value for the query. Formatter functions are applied after all the
Map/Reduce routines have been executed. Result formatters can be applied from
within contained associations as well. CakePHP will ensure that your formatters
are properly scoped. For example, doing the following would work as you may
expect:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="c1">// In a method in the Articles table</span>
<span class="nv">$query</span><span class="o">-&gt;</span><span class="na">contain</span><span class="p">([</span><span class="s1">&#39;Authors&#39;</span> <span class="o">=&gt;</span> <span class="k">function</span> <span class="p">(</span><span class="nv">$q</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nv">$q</span><span class="o">-&gt;</span><span class="na">formatResults</span><span class="p">(</span><span class="k">function</span> <span class="p">(</span><span class="nx">\Cake\Collection\CollectionInterface</span> <span class="nv">$authors</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$authors</span><span class="o">-&gt;</span><span class="na">map</span><span class="p">(</span><span class="k">function</span> <span class="p">(</span><span class="nv">$author</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$author</span><span class="p">[</span><span class="s1">&#39;age&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$author</span><span class="p">[</span><span class="s1">&#39;birth_date&#39;</span><span class="p">]</span><span class="o">-&gt;</span><span class="na">diff</span><span class="p">(</span><span class="k">new</span> <span class="nx">\DateTime</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">y</span><span class="p">;</span>
            <span class="k">return</span> <span class="nv">$author</span><span class="p">;</span>
        <span class="p">});</span>
    <span class="p">});</span>
<span class="p">}]);</span>

<span class="c1">// Get results</span>
<span class="nv">$results</span> <span class="o">=</span> <span class="nv">$query</span><span class="o">-&gt;</span><span class="na">all</span><span class="p">();</span>

<span class="c1">// Outputs 29</span>
<span class="k">echo</span> <span class="nv">$results</span><span class="o">-&gt;</span><span class="na">first</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">author</span><span class="o">-&gt;</span><span class="na">age</span><span class="p">;</span>
</pre></div>
</div>
<p>As seen above, the formatters attached to associated query builders are scoped
to operate only on the data in the association. CakePHP will ensure that
computed values are inserted into the correct entity.</p>
</div>
</div>
<div class="section" id="advanced-conditions">
<span id="advanced-query-conditions"></span><h2>Advanced Conditions<a class="headerlink" href="#advanced-conditions" title="Permalink to this headline">¶</a></h2>
<p>The query builder makes it simple to build complex <code class="docutils literal"><span class="pre">where</span></code> clauses.
Grouped conditions can be expressed by providing combining <code class="docutils literal"><span class="pre">where()</span></code>,
<code class="docutils literal"><span class="pre">andWhere()</span></code> and <code class="docutils literal"><span class="pre">orWhere()</span></code>. The <code class="docutils literal"><span class="pre">where()</span></code> method works similar to the
conditions arrays in previous versions of CakePHP:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="nv">$query</span> <span class="o">=</span> <span class="nv">$articles</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">()</span>
    <span class="o">-&gt;</span><span class="na">where</span><span class="p">([</span>
        <span class="s1">&#39;author_id&#39;</span> <span class="o">=&gt;</span> <span class="mi">3</span><span class="p">,</span>
        <span class="s1">&#39;OR&#39;</span> <span class="o">=&gt;</span> <span class="p">[[</span><span class="s1">&#39;view_count&#39;</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;view_count&#39;</span> <span class="o">=&gt;</span> <span class="mi">3</span><span class="p">]],</span>
    <span class="p">]);</span>
</pre></div>
</div>
<p>The above would generate SQL like:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="nx">SELECT</span> <span class="o">*</span> <span class="nx">FROM</span> <span class="nx">articles</span> <span class="nx">WHERE</span> <span class="nx">author_id</span> <span class="o">=</span> <span class="mi">3</span> <span class="k">AND</span> <span class="p">(</span><span class="nx">view_count</span> <span class="o">=</span> <span class="mi">2</span> <span class="k">OR</span> <span class="nx">view_count</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
<p>If you&#8217;d prefer to avoid deeply nested arrays, you can use the <code class="docutils literal"><span class="pre">orWhere()</span></code> and
<code class="docutils literal"><span class="pre">andWhere()</span></code> methods to build your queries. Each method sets the combining
operator used between the current and previous condition. For example:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="nv">$query</span> <span class="o">=</span> <span class="nv">$articles</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">()</span>
    <span class="o">-&gt;</span><span class="na">where</span><span class="p">([</span><span class="s1">&#39;author_id&#39;</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">])</span>
    <span class="o">-&gt;</span><span class="na">orWhere</span><span class="p">([</span><span class="s1">&#39;author_id&#39;</span> <span class="o">=&gt;</span> <span class="mi">3</span><span class="p">]);</span>
</pre></div>
</div>
<p>The above will output SQL similar to:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="nx">SELECT</span> <span class="o">*</span> <span class="nx">FROM</span> <span class="nx">articles</span> <span class="nx">WHERE</span> <span class="p">(</span><span class="nx">author_id</span> <span class="o">=</span> <span class="mi">2</span> <span class="k">OR</span> <span class="nx">author_id</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
<p>By combining <code class="docutils literal"><span class="pre">orWhere()</span></code> and <code class="docutils literal"><span class="pre">andWhere()</span></code>, you can express complex
conditions that use a mixture of operators:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="nv">$query</span> <span class="o">=</span> <span class="nv">$articles</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">()</span>
    <span class="o">-&gt;</span><span class="na">where</span><span class="p">([</span><span class="s1">&#39;author_id&#39;</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">])</span>
    <span class="o">-&gt;</span><span class="na">orWhere</span><span class="p">([</span><span class="s1">&#39;author_id&#39;</span> <span class="o">=&gt;</span> <span class="mi">3</span><span class="p">])</span>
    <span class="o">-&gt;</span><span class="na">andWhere</span><span class="p">([</span>
        <span class="s1">&#39;published&#39;</span> <span class="o">=&gt;</span> <span class="k">true</span><span class="p">,</span>
        <span class="s1">&#39;view_count &gt;&#39;</span> <span class="o">=&gt;</span> <span class="mi">10</span>
    <span class="p">])</span>
    <span class="o">-&gt;</span><span class="na">orWhere</span><span class="p">([</span><span class="s1">&#39;promoted&#39;</span> <span class="o">=&gt;</span> <span class="k">true</span><span class="p">]);</span>
</pre></div>
</div>
<p>The above generates SQL similar to:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="nx">SELECT</span> <span class="o">*</span>
<span class="nx">FROM</span> <span class="nx">articles</span>
<span class="nx">WHERE</span> <span class="p">(</span>
    <span class="p">(</span>
        <span class="p">(</span><span class="nx">author_id</span> <span class="o">=</span> <span class="mi">2</span> <span class="k">OR</span> <span class="nx">author_id</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span>
        <span class="k">AND</span>
        <span class="p">(</span><span class="nx">published</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">AND</span> <span class="nx">view_count</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="k">OR</span> <span class="nx">promoted</span> <span class="o">=</span> <span class="mi">1</span>
<span class="p">)</span>
</pre></div>
</div>
<p>By using functions as the parameters to <code class="docutils literal"><span class="pre">orWhere()</span></code> and <code class="docutils literal"><span class="pre">andWhere()</span></code>,
you can compose conditions together with the expression objects:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="nv">$query</span> <span class="o">=</span> <span class="nv">$articles</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">()</span>
    <span class="o">-&gt;</span><span class="na">where</span><span class="p">([</span><span class="s1">&#39;title LIKE&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;%First%&#39;</span><span class="p">])</span>
    <span class="o">-&gt;</span><span class="na">andWhere</span><span class="p">(</span><span class="k">function</span> <span class="p">(</span><span class="nv">$exp</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$exp</span><span class="o">-&gt;</span><span class="na">or_</span><span class="p">([</span>
            <span class="s1">&#39;author_id&#39;</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">&#39;is_highlighted&#39;</span> <span class="o">=&gt;</span> <span class="k">true</span>
        <span class="p">]);</span>
    <span class="p">});</span>
</pre></div>
</div>
<p>The above would create SQL like:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="nx">SELECT</span> <span class="o">*</span>
<span class="nx">FROM</span> <span class="nx">articles</span>
<span class="nx">WHERE</span> <span class="p">(</span>
    <span class="nx">title</span> <span class="nx">LIKE</span> <span class="s1">&#39;%First%&#39;</span>
    <span class="k">AND</span>
    <span class="p">(</span><span class="nx">author_id</span> <span class="o">=</span> <span class="mi">2</span> <span class="k">OR</span> <span class="nx">is_highlighted</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
<p>The expression object that is passed into <code class="docutils literal"><span class="pre">where()</span></code> functions has two kinds of
methods. The first type of methods are <strong>combinators</strong>. The <code class="docutils literal"><span class="pre">and_()</span></code> and
<code class="docutils literal"><span class="pre">or_()</span></code> methods create new expression objects that change <strong>how</strong> conditions
are combined. The second type of methods are <strong>conditions</strong>. Conditions are
added into an expression where they are combined with the current combinator.</p>
<p>For example, calling <code class="docutils literal"><span class="pre">$exp-&gt;and_(...)</span></code> will create a new <code class="docutils literal"><span class="pre">Expression</span></code> object
that combines all conditions it contains with <code class="docutils literal"><span class="pre">AND</span></code>. While <code class="docutils literal"><span class="pre">$exp-&gt;or_()</span></code>
will create a new <code class="docutils literal"><span class="pre">Expression</span></code> object that combines all conditions added to it
with <code class="docutils literal"><span class="pre">OR</span></code>. An example of adding conditions with an <code class="docutils literal"><span class="pre">Expression</span></code> object would
be:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="nv">$query</span> <span class="o">=</span> <span class="nv">$articles</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">()</span>
    <span class="o">-&gt;</span><span class="na">where</span><span class="p">(</span><span class="k">function</span> <span class="p">(</span><span class="nv">$exp</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$exp</span>
            <span class="o">-&gt;</span><span class="na">eq</span><span class="p">(</span><span class="s1">&#39;author_id&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="o">-&gt;</span><span class="na">eq</span><span class="p">(</span><span class="s1">&#39;published&#39;</span><span class="p">,</span> <span class="k">true</span><span class="p">)</span>
            <span class="o">-&gt;</span><span class="na">notEq</span><span class="p">(</span><span class="s1">&#39;spam&#39;</span><span class="p">,</span> <span class="k">true</span><span class="p">)</span>
            <span class="o">-&gt;</span><span class="na">gt</span><span class="p">(</span><span class="s1">&#39;view_count&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
    <span class="p">});</span>
</pre></div>
</div>
<p>Since we started off using <code class="docutils literal"><span class="pre">where()</span></code>, we don&#8217;t need to call <code class="docutils literal"><span class="pre">and_()</span></code>, as
that happens implicitly. Much like how we would not need to call <code class="docutils literal"><span class="pre">or_()</span></code>, had
we started our query with <code class="docutils literal"><span class="pre">orWhere()</span></code>. The above shows a few new condition
methods being combined with <code class="docutils literal"><span class="pre">AND</span></code>. The resulting SQL would look like:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="nx">SELECT</span> <span class="o">*</span>
<span class="nx">FROM</span> <span class="nx">articles</span>
<span class="nx">WHERE</span> <span class="p">(</span>
<span class="nx">author_id</span> <span class="o">=</span> <span class="mi">2</span>
<span class="k">AND</span> <span class="nx">published</span> <span class="o">=</span> <span class="mi">1</span>
<span class="k">AND</span> <span class="nx">spam</span> <span class="o">!=</span> <span class="mi">1</span>
<span class="k">AND</span> <span class="nx">view_count</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
<p>However, if we wanted to use both <code class="docutils literal"><span class="pre">AND</span></code> &amp; <code class="docutils literal"><span class="pre">OR</span></code> conditions we could do the
following:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="nv">$query</span> <span class="o">=</span> <span class="nv">$articles</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">()</span>
    <span class="o">-&gt;</span><span class="na">where</span><span class="p">(</span><span class="k">function</span> <span class="p">(</span><span class="nv">$exp</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$orConditions</span> <span class="o">=</span> <span class="nv">$exp</span><span class="o">-&gt;</span><span class="na">or_</span><span class="p">([</span><span class="s1">&#39;author_id&#39;</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">])</span>
            <span class="o">-&gt;</span><span class="na">eq</span><span class="p">(</span><span class="s1">&#39;author_id&#39;</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
        <span class="k">return</span> <span class="nv">$exp</span>
            <span class="o">-&gt;</span><span class="na">add</span><span class="p">(</span><span class="nv">$orConditions</span><span class="p">)</span>
            <span class="o">-&gt;</span><span class="na">eq</span><span class="p">(</span><span class="s1">&#39;published&#39;</span><span class="p">,</span> <span class="k">true</span><span class="p">)</span>
            <span class="o">-&gt;</span><span class="na">gte</span><span class="p">(</span><span class="s1">&#39;view_count&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
    <span class="p">});</span>
</pre></div>
</div>
<p>Which would generate the SQL similar to:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="nx">SELECT</span> <span class="o">*</span>
<span class="nx">FROM</span> <span class="nx">articles</span>
<span class="nx">WHERE</span> <span class="p">(</span>
<span class="p">(</span><span class="nx">author_id</span> <span class="o">=</span> <span class="mi">2</span> <span class="k">OR</span> <span class="nx">author_id</span> <span class="o">=</span> <span class="mi">5</span><span class="p">)</span>
<span class="k">AND</span> <span class="nx">published</span> <span class="o">=</span> <span class="mi">1</span>
<span class="k">AND</span> <span class="nx">view_count</span> <span class="o">&gt;=</span> <span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
<p>The <code class="docutils literal"><span class="pre">or_()</span></code> and <code class="docutils literal"><span class="pre">and_()</span></code> methods also allow you to use functions as their
parameters. This is often easier to read than method chaining:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="nv">$query</span> <span class="o">=</span> <span class="nv">$articles</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">()</span>
    <span class="o">-&gt;</span><span class="na">where</span><span class="p">(</span><span class="k">function</span> <span class="p">(</span><span class="nv">$exp</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$orConditions</span> <span class="o">=</span> <span class="nv">$exp</span><span class="o">-&gt;</span><span class="na">or_</span><span class="p">(</span><span class="k">function</span> <span class="p">(</span><span class="nv">$or</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nv">$or</span><span class="o">-&gt;</span><span class="na">eq</span><span class="p">(</span><span class="s1">&#39;author_id&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                <span class="o">-&gt;</span><span class="na">eq</span><span class="p">(</span><span class="s1">&#39;author_id&#39;</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
        <span class="p">});</span>
        <span class="k">return</span> <span class="nv">$exp</span>
            <span class="o">-&gt;</span><span class="na">not</span><span class="p">(</span><span class="nv">$orConditions</span><span class="p">)</span>
            <span class="o">-&gt;</span><span class="na">lte</span><span class="p">(</span><span class="s1">&#39;view_count&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
    <span class="p">});</span>
</pre></div>
</div>
<p>You can negate sub-expressions using <code class="docutils literal"><span class="pre">not()</span></code>:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="nv">$query</span> <span class="o">=</span> <span class="nv">$articles</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">()</span>
    <span class="o">-&gt;</span><span class="na">where</span><span class="p">(</span><span class="k">function</span> <span class="p">(</span><span class="nv">$exp</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$orConditions</span> <span class="o">=</span> <span class="nv">$exp</span><span class="o">-&gt;</span><span class="na">or_</span><span class="p">([</span><span class="s1">&#39;author_id&#39;</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">])</span>
            <span class="o">-&gt;</span><span class="na">eq</span><span class="p">(</span><span class="s1">&#39;author_id&#39;</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
        <span class="k">return</span> <span class="nv">$exp</span>
            <span class="o">-&gt;</span><span class="na">not</span><span class="p">(</span><span class="nv">$orConditions</span><span class="p">)</span>
            <span class="o">-&gt;</span><span class="na">lte</span><span class="p">(</span><span class="s1">&#39;view_count&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
    <span class="p">});</span>
</pre></div>
</div>
<p>Which will generate the following SQL looking like:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="nx">SELECT</span> <span class="o">*</span>
<span class="nx">FROM</span> <span class="nx">articles</span>
<span class="nx">WHERE</span> <span class="p">(</span>
<span class="k">NOT</span> <span class="p">(</span><span class="nx">author_id</span> <span class="o">=</span> <span class="mi">2</span> <span class="k">OR</span> <span class="nx">author_id</span> <span class="o">=</span> <span class="mi">5</span><span class="p">)</span>
<span class="k">AND</span> <span class="nx">view_count</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
<p>It is also possible to build expressions using SQL functions:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="nv">$query</span> <span class="o">=</span> <span class="nv">$articles</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">()</span>
    <span class="o">-&gt;</span><span class="na">where</span><span class="p">(</span><span class="k">function</span> <span class="p">(</span><span class="nv">$exp</span><span class="p">,</span> <span class="nv">$q</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$year</span> <span class="o">=</span> <span class="nv">$q</span><span class="o">-&gt;</span><span class="na">func</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">year</span><span class="p">([</span>
            <span class="s1">&#39;created&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;identifier&#39;</span>
        <span class="p">]);</span>
        <span class="k">return</span> <span class="nv">$exp</span>
            <span class="o">-&gt;</span><span class="na">gte</span><span class="p">(</span><span class="nv">$year</span><span class="p">,</span> <span class="mi">2014</span><span class="p">)</span>
            <span class="o">-&gt;</span><span class="na">eq</span><span class="p">(</span><span class="s1">&#39;published&#39;</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span>
    <span class="p">});</span>
</pre></div>
</div>
<p>Which will generate the following SQL looking like:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="nx">SELECT</span> <span class="o">*</span>
<span class="nx">FROM</span> <span class="nx">articles</span>
<span class="nx">WHERE</span> <span class="p">(</span>
<span class="nx">YEAR</span><span class="p">(</span><span class="nx">created</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2014</span>
<span class="k">AND</span> <span class="nx">published</span> <span class="o">=</span> <span class="mi">1</span>
<span class="p">)</span>
</pre></div>
</div>
<p>When using the expression objects you can use the following methods to create
conditions:</p>
<ul>
<li><p class="first"><code class="docutils literal"><span class="pre">eq()</span></code> Creates an equality condition:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="nv">$query</span> <span class="o">=</span> <span class="nv">$cities</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">()</span>
    <span class="o">-&gt;</span><span class="na">where</span><span class="p">(</span><span class="k">function</span> <span class="p">(</span><span class="nv">$exp</span><span class="p">,</span> <span class="nv">$q</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$exp</span><span class="o">-&gt;</span><span class="na">eq</span><span class="p">(</span><span class="s1">&#39;population&#39;</span><span class="p">,</span> <span class="s1">&#39;10000&#39;</span><span class="p">);</span>
    <span class="p">});</span>
<span class="c1"># WHERE population = 10000</span>
</pre></div>
</div>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">notEq()</span></code> Creates an inequality condition:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="nv">$query</span> <span class="o">=</span> <span class="nv">$cities</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">()</span>
    <span class="o">-&gt;</span><span class="na">where</span><span class="p">(</span><span class="k">function</span> <span class="p">(</span><span class="nv">$exp</span><span class="p">,</span> <span class="nv">$q</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$exp</span><span class="o">-&gt;</span><span class="na">notEq</span><span class="p">(</span><span class="s1">&#39;population&#39;</span><span class="p">,</span> <span class="s1">&#39;10000&#39;</span><span class="p">);</span>
    <span class="p">});</span>
<span class="c1"># WHERE population != 10000</span>
</pre></div>
</div>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">like()</span></code> Creates a condition using the <code class="docutils literal"><span class="pre">LIKE</span></code> operator:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="nv">$query</span> <span class="o">=</span> <span class="nv">$cities</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">()</span>
    <span class="o">-&gt;</span><span class="na">where</span><span class="p">(</span><span class="k">function</span> <span class="p">(</span><span class="nv">$exp</span><span class="p">,</span> <span class="nv">$q</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$exp</span><span class="o">-&gt;</span><span class="na">like</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;%A%&#39;</span><span class="p">);</span>
    <span class="p">});</span>
<span class="c1"># WHERE name LIKE &quot;%A%&quot;</span>
</pre></div>
</div>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">notLike()</span></code> Creates a negated <code class="docutils literal"><span class="pre">LIKE</span></code> condition:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="nv">$query</span> <span class="o">=</span> <span class="nv">$cities</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">()</span>
    <span class="o">-&gt;</span><span class="na">where</span><span class="p">(</span><span class="k">function</span> <span class="p">(</span><span class="nv">$exp</span><span class="p">,</span> <span class="nv">$q</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$exp</span><span class="o">-&gt;</span><span class="na">notLike</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;%A%&#39;</span><span class="p">);</span>
    <span class="p">});</span>
<span class="c1"># WHERE name NOT LIKE &quot;%A%&quot;</span>
</pre></div>
</div>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">in()</span></code> Create a condition using <code class="docutils literal"><span class="pre">IN</span></code>:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="nv">$query</span> <span class="o">=</span> <span class="nv">$cities</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">()</span>
    <span class="o">-&gt;</span><span class="na">where</span><span class="p">(</span><span class="k">function</span> <span class="p">(</span><span class="nv">$exp</span><span class="p">,</span> <span class="nv">$q</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$exp</span><span class="o">-&gt;</span><span class="na">in</span><span class="p">(</span><span class="s1">&#39;country_id&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;AFG&#39;</span><span class="p">,</span> <span class="s1">&#39;USA&#39;</span><span class="p">,</span> <span class="s1">&#39;EST&#39;</span><span class="p">]);</span>
    <span class="p">});</span>
<span class="c1"># WHERE country_id IN (&#39;AFG&#39;, &#39;USA&#39;, &#39;EST&#39;)</span>
</pre></div>
</div>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">notIn()</span></code> Create a negated condition using <code class="docutils literal"><span class="pre">IN</span></code>:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="nv">$query</span> <span class="o">=</span> <span class="nv">$cities</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">()</span>
    <span class="o">-&gt;</span><span class="na">where</span><span class="p">(</span><span class="k">function</span> <span class="p">(</span><span class="nv">$exp</span><span class="p">,</span> <span class="nv">$q</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$exp</span><span class="o">-&gt;</span><span class="na">notIn</span><span class="p">(</span><span class="s1">&#39;country_id&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;AFG&#39;</span><span class="p">,</span> <span class="s1">&#39;USA&#39;</span><span class="p">,</span> <span class="s1">&#39;EST&#39;</span><span class="p">]);</span>
    <span class="p">});</span>
<span class="c1"># WHERE country_id NOT IN (&#39;AFG&#39;, &#39;USA&#39;, &#39;EST&#39;)</span>
</pre></div>
</div>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">gt()</span></code> Create a <code class="docutils literal"><span class="pre">&gt;</span></code> condition:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="nv">$query</span> <span class="o">=</span> <span class="nv">$cities</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">()</span>
    <span class="o">-&gt;</span><span class="na">where</span><span class="p">(</span><span class="k">function</span> <span class="p">(</span><span class="nv">$exp</span><span class="p">,</span> <span class="nv">$q</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$exp</span><span class="o">-&gt;</span><span class="na">gt</span><span class="p">(</span><span class="s1">&#39;population&#39;</span><span class="p">,</span> <span class="s1">&#39;10000&#39;</span><span class="p">);</span>
    <span class="p">});</span>
<span class="c1"># WHERE population &gt; 10000</span>
</pre></div>
</div>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">gte()</span></code> Create a <code class="docutils literal"><span class="pre">&gt;=</span></code> condition:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="nv">$query</span> <span class="o">=</span> <span class="nv">$cities</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">()</span>
    <span class="o">-&gt;</span><span class="na">where</span><span class="p">(</span><span class="k">function</span> <span class="p">(</span><span class="nv">$exp</span><span class="p">,</span> <span class="nv">$q</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$exp</span><span class="o">-&gt;</span><span class="na">gte</span><span class="p">(</span><span class="s1">&#39;population&#39;</span><span class="p">,</span> <span class="s1">&#39;10000&#39;</span><span class="p">);</span>
    <span class="p">});</span>
<span class="c1"># WHERE population &gt;= 10000</span>
</pre></div>
</div>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">lt()</span></code> Create a <code class="docutils literal"><span class="pre">&lt;</span></code> condition:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="nv">$query</span> <span class="o">=</span> <span class="nv">$cities</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">()</span>
    <span class="o">-&gt;</span><span class="na">where</span><span class="p">(</span><span class="k">function</span> <span class="p">(</span><span class="nv">$exp</span><span class="p">,</span> <span class="nv">$q</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$exp</span><span class="o">-&gt;</span><span class="na">lt</span><span class="p">(</span><span class="s1">&#39;population&#39;</span><span class="p">,</span> <span class="s1">&#39;10000&#39;</span><span class="p">);</span>
    <span class="p">});</span>
<span class="c1"># WHERE population &lt; 10000</span>
</pre></div>
</div>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">lte()</span></code> Create a <code class="docutils literal"><span class="pre">&lt;=</span></code> condition:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="nv">$query</span> <span class="o">=</span> <span class="nv">$cities</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">()</span>
    <span class="o">-&gt;</span><span class="na">where</span><span class="p">(</span><span class="k">function</span> <span class="p">(</span><span class="nv">$exp</span><span class="p">,</span> <span class="nv">$q</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$exp</span><span class="o">-&gt;</span><span class="na">lte</span><span class="p">(</span><span class="s1">&#39;population&#39;</span><span class="p">,</span> <span class="s1">&#39;10000&#39;</span><span class="p">);</span>
    <span class="p">});</span>
<span class="c1"># WHERE population &lt;= 10000</span>
</pre></div>
</div>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">isNull()</span></code> Create an <code class="docutils literal"><span class="pre">IS</span> <span class="pre">NULL</span></code> condition:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="nv">$query</span> <span class="o">=</span> <span class="nv">$cities</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">()</span>
    <span class="o">-&gt;</span><span class="na">where</span><span class="p">(</span><span class="k">function</span> <span class="p">(</span><span class="nv">$exp</span><span class="p">,</span> <span class="nv">$q</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$exp</span><span class="o">-&gt;</span><span class="na">isNull</span><span class="p">(</span><span class="s1">&#39;population&#39;</span><span class="p">);</span>
    <span class="p">});</span>
<span class="c1"># WHERE (population) IS NULL</span>
</pre></div>
</div>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">isNotNull()</span></code> Create a negated <code class="docutils literal"><span class="pre">IS</span> <span class="pre">NULL</span></code> condition:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="nv">$query</span> <span class="o">=</span> <span class="nv">$cities</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">()</span>
    <span class="o">-&gt;</span><span class="na">where</span><span class="p">(</span><span class="k">function</span> <span class="p">(</span><span class="nv">$exp</span><span class="p">,</span> <span class="nv">$q</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$exp</span><span class="o">-&gt;</span><span class="na">isNotNull</span><span class="p">(</span><span class="s1">&#39;population&#39;</span><span class="p">);</span>
    <span class="p">});</span>
<span class="c1"># WHERE (population) IS NOT NULL</span>
</pre></div>
</div>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">between()</span></code> Create a <code class="docutils literal"><span class="pre">BETWEEN</span></code> condition:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="nv">$query</span> <span class="o">=</span> <span class="nv">$cities</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">()</span>
    <span class="o">-&gt;</span><span class="na">where</span><span class="p">(</span><span class="k">function</span> <span class="p">(</span><span class="nv">$exp</span><span class="p">,</span> <span class="nv">$q</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$exp</span><span class="o">-&gt;</span><span class="na">between</span><span class="p">(</span><span class="s1">&#39;population&#39;</span><span class="p">,</span> <span class="mi">999</span><span class="p">,</span> <span class="mi">5000000</span><span class="p">);</span>
    <span class="p">});</span>
<span class="c1"># WHERE population BETWEEN 999 AND 5000000,</span>
</pre></div>
</div>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">exists()</span></code> Create a condition using <code class="docutils literal"><span class="pre">EXISTS</span></code>:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="nv">$subquery</span> <span class="o">=</span> <span class="nv">$cities</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">()</span>
    <span class="o">-&gt;</span><span class="na">select</span><span class="p">([</span><span class="s1">&#39;id&#39;</span><span class="p">])</span>
    <span class="o">-&gt;</span><span class="na">where</span><span class="p">(</span><span class="k">function</span> <span class="p">(</span><span class="nv">$exp</span><span class="p">,</span> <span class="nv">$q</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$exp</span><span class="o">-&gt;</span><span class="na">equalFields</span><span class="p">(</span><span class="s1">&#39;countries.id&#39;</span><span class="p">,</span> <span class="s1">&#39;cities.country_id&#39;</span><span class="p">);</span>
    <span class="p">})</span>
    <span class="o">-&gt;</span><span class="na">andWhere</span><span class="p">([</span><span class="s1">&#39;population &gt;&#39;</span><span class="p">,</span> <span class="mi">5000000</span><span class="p">]);</span>

<span class="nv">$query</span> <span class="o">=</span> <span class="nv">$countries</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">()</span>
    <span class="o">-&gt;</span><span class="na">where</span><span class="p">(</span><span class="k">function</span> <span class="p">(</span><span class="nv">$exp</span><span class="p">,</span> <span class="nv">$q</span><span class="p">)</span> <span class="k">use</span> <span class="p">(</span><span class="nv">$subquery</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$exp</span><span class="o">-&gt;</span><span class="na">exists</span><span class="p">(</span><span class="nv">$subquery</span><span class="p">);</span>
    <span class="p">});</span>
<span class="c1"># WHERE EXISTS (SELECT id FROM cities WHERE countries.id = cities.country_id AND population &gt; 5000000)</span>
</pre></div>
</div>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">notExists()</span></code> Create a negated condition using <code class="docutils literal"><span class="pre">EXISTS</span></code>:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="nv">$subquery</span> <span class="o">=</span> <span class="nv">$cities</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">()</span>
    <span class="o">-&gt;</span><span class="na">select</span><span class="p">([</span><span class="s1">&#39;id&#39;</span><span class="p">])</span>
    <span class="o">-&gt;</span><span class="na">where</span><span class="p">(</span><span class="k">function</span> <span class="p">(</span><span class="nv">$exp</span><span class="p">,</span> <span class="nv">$q</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$exp</span><span class="o">-&gt;</span><span class="na">equalFields</span><span class="p">(</span><span class="s1">&#39;countries.id&#39;</span><span class="p">,</span> <span class="s1">&#39;cities.country_id&#39;</span><span class="p">);</span>
    <span class="p">})</span>
    <span class="o">-&gt;</span><span class="na">andWhere</span><span class="p">([</span><span class="s1">&#39;population &gt;&#39;</span><span class="p">,</span> <span class="mi">5000000</span><span class="p">]);</span>

<span class="nv">$query</span> <span class="o">=</span> <span class="nv">$countries</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">()</span>
    <span class="o">-&gt;</span><span class="na">where</span><span class="p">(</span><span class="k">function</span> <span class="p">(</span><span class="nv">$exp</span><span class="p">,</span> <span class="nv">$q</span><span class="p">)</span> <span class="k">use</span> <span class="p">(</span><span class="nv">$subquery</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$exp</span><span class="o">-&gt;</span><span class="na">notExists</span><span class="p">(</span><span class="nv">$subquery</span><span class="p">);</span>
    <span class="p">});</span>
<span class="c1"># WHERE NOT EXISTS (SELECT id FROM cities WHERE countries.id = cities.country_id AND population &gt; 5000000)</span>
</pre></div>
</div>
</li>
</ul>
<p>In situations when you can&#8217;t get, or don&#8217;t want to use the builder methods to
create the conditions you want you can also use snippets of SQL in where
clauses:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="c1">// Compare two fields to each other</span>
<span class="nv">$query</span><span class="o">-&gt;</span><span class="na">where</span><span class="p">([</span><span class="s1">&#39;Categories.parent_id != Parents.id&#39;</span><span class="p">]);</span>
</pre></div>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">The field names used in expressions, and SQL snippets should <strong>never</strong>
contain untrusted content.  See the <a class="reference internal" href="#using-sql-functions"><span class="std std-ref">Using SQL Functions</span></a> section for
how to safely include unsafe data into function calls.</p>
</div>
<div class="section" id="automatically-creating-in-clauses">
<h3>Automatically Creating IN Clauses<a class="headerlink" href="#automatically-creating-in-clauses" title="Permalink to this headline">¶</a></h3>
<p>When building queries using the ORM, you will generally not have to indicate the
data types of the columns you are interacting with, as CakePHP can infer the
types based on the schema data. If in your queries you&#8217;d like CakePHP to
automatically convert equality to <code class="docutils literal"><span class="pre">IN</span></code> comparisons, you&#8217;ll need to indicate
the column data type:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="nv">$query</span> <span class="o">=</span> <span class="nv">$articles</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">()</span>
    <span class="o">-&gt;</span><span class="na">where</span><span class="p">([</span><span class="s1">&#39;id&#39;</span> <span class="o">=&gt;</span> <span class="nv">$ids</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;id&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;integer[]&#39;</span><span class="p">]);</span>

<span class="c1">// Or include IN to automatically cast to an array.</span>
<span class="nv">$query</span> <span class="o">=</span> <span class="nv">$articles</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">()</span>
    <span class="o">-&gt;</span><span class="na">where</span><span class="p">([</span><span class="s1">&#39;id IN&#39;</span> <span class="o">=&gt;</span> <span class="nv">$ids</span><span class="p">]);</span>
</pre></div>
</div>
<p>The above will automatically create <code class="docutils literal"><span class="pre">id</span> <span class="pre">IN</span> <span class="pre">(...)</span></code> instead of <code class="docutils literal"><span class="pre">id</span> <span class="pre">=</span> <span class="pre">?</span></code>. This
can be useful when you do not know whether you will get a scalar or array of
parameters. The <code class="docutils literal"><span class="pre">[]</span></code> suffix on any data type name indicates to the query
builder that you want the data handled as an array. If the data is not an array,
it will first be cast to an array. After that, each value in the array will
be cast using the <a class="reference internal" href="database-basics.html#database-data-types"><span class="std std-ref">type system</span></a>. This works with
complex types as well. For example, you could take a list of DateTime objects
using:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="nv">$query</span> <span class="o">=</span> <span class="nv">$articles</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">()</span>
    <span class="o">-&gt;</span><span class="na">where</span><span class="p">([</span><span class="s1">&#39;post_date&#39;</span> <span class="o">=&gt;</span> <span class="nv">$dates</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;post_date&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;date[]&#39;</span><span class="p">]);</span>
</pre></div>
</div>
</div>
<div class="section" id="automatic-is-null-creation">
<h3>Automatic IS NULL Creation<a class="headerlink" href="#automatic-is-null-creation" title="Permalink to this headline">¶</a></h3>
<p>When a condition value is expected to be <code class="docutils literal"><span class="pre">null</span></code> or any other value, you can
use the <code class="docutils literal"><span class="pre">IS</span></code> operator to automatically create the correct expression:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="nv">$query</span> <span class="o">=</span> <span class="nv">$categories</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">()</span>
    <span class="o">-&gt;</span><span class="na">where</span><span class="p">([</span><span class="s1">&#39;parent_id IS&#39;</span> <span class="o">=&gt;</span> <span class="nv">$parentId</span><span class="p">]);</span>
</pre></div>
</div>
<p>The above will create <code class="docutils literal"><span class="pre">parent_id`</span> <span class="pre">=</span> <span class="pre">:c1</span></code> or <code class="docutils literal"><span class="pre">parent_id</span> <span class="pre">IS</span> <span class="pre">NULL</span></code> depending on
the type of <code class="docutils literal"><span class="pre">$parentId</span></code></p>
</div>
<div class="section" id="automatic-is-not-null-creation">
<h3>Automatic IS NOT NULL Creation<a class="headerlink" href="#automatic-is-not-null-creation" title="Permalink to this headline">¶</a></h3>
<p>When a condition value is expected not to be <code class="docutils literal"><span class="pre">null</span></code> or any other value, you
can use the <code class="docutils literal"><span class="pre">IS</span> <span class="pre">NOT</span></code> operator to automatically create the correct expression:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="nv">$query</span> <span class="o">=</span> <span class="nv">$categories</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">()</span>
    <span class="o">-&gt;</span><span class="na">where</span><span class="p">([</span><span class="s1">&#39;parent_id IS NOT&#39;</span> <span class="o">=&gt;</span> <span class="nv">$parentId</span><span class="p">]);</span>
</pre></div>
</div>
<p>The above will create <code class="docutils literal"><span class="pre">parent_id`</span> <span class="pre">!=</span> <span class="pre">:c1</span></code> or <code class="docutils literal"><span class="pre">parent_id</span> <span class="pre">IS</span> <span class="pre">NOT</span> <span class="pre">NULL</span></code>
depending on the type of <code class="docutils literal"><span class="pre">$parentId</span></code></p>
</div>
<div class="section" id="raw-expressions">
<h3>Raw Expressions<a class="headerlink" href="#raw-expressions" title="Permalink to this headline">¶</a></h3>
<p>When you cannot construct the SQL you need using the query builder, you can use
expression objects to add snippets of SQL to your queries:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="nv">$query</span> <span class="o">=</span> <span class="nv">$articles</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">();</span>
<span class="nv">$expr</span> <span class="o">=</span> <span class="nv">$query</span><span class="o">-&gt;</span><span class="na">newExpr</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">add</span><span class="p">(</span><span class="s1">&#39;1 + 1&#39;</span><span class="p">);</span>
<span class="nv">$query</span><span class="o">-&gt;</span><span class="na">select</span><span class="p">([</span><span class="s1">&#39;two&#39;</span> <span class="o">=&gt;</span> <span class="nv">$expr</span><span class="p">]);</span>
</pre></div>
</div>
<p><code class="docutils literal"><span class="pre">Expression</span></code> objects can be used with any query builder methods like
<code class="docutils literal"><span class="pre">where()</span></code>, <code class="docutils literal"><span class="pre">limit()</span></code>, <code class="docutils literal"><span class="pre">group()</span></code>, <code class="docutils literal"><span class="pre">select()</span></code> and many other methods.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">Using expression objects leaves you vulnerable to SQL injection. You should
avoid interpolating user data into expressions.</p>
</div>
</div>
</div>
<div class="section" id="getting-results">
<h2>Getting Results<a class="headerlink" href="#getting-results" title="Permalink to this headline">¶</a></h2>
<p>Once you&#8217;ve made your query, you&#8217;ll want to retrieve rows from it. There are
a few ways of doing this:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="c1">// Iterate the query</span>
<span class="k">foreach</span> <span class="p">(</span><span class="nv">$query</span> <span class="k">as</span> <span class="nv">$row</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Do stuff.</span>
<span class="p">}</span>

<span class="c1">// Get the results</span>
<span class="nv">$results</span> <span class="o">=</span> <span class="nv">$query</span><span class="o">-&gt;</span><span class="na">all</span><span class="p">();</span>
</pre></div>
</div>
<p>You can use <a class="reference internal" href="../core-libraries/collections.html"><span class="doc">any of the collection</span></a> methods
on your query objects to pre-process or transform the results:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="c1">// Use one of the collection methods.</span>
<span class="nv">$ids</span> <span class="o">=</span> <span class="nv">$query</span><span class="o">-&gt;</span><span class="na">map</span><span class="p">(</span><span class="k">function</span> <span class="p">(</span><span class="nv">$row</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nv">$row</span><span class="o">-&gt;</span><span class="na">id</span><span class="p">;</span>
<span class="p">});</span>

<span class="nv">$maxAge</span> <span class="o">=</span> <span class="nv">$query</span><span class="o">-&gt;</span><span class="na">max</span><span class="p">(</span><span class="k">function</span> <span class="p">(</span><span class="nv">$max</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nv">$max</span><span class="o">-&gt;</span><span class="na">age</span><span class="p">;</span>
<span class="p">});</span>
</pre></div>
</div>
<p>You can use <code class="docutils literal"><span class="pre">first</span></code> or <code class="docutils literal"><span class="pre">firstOrFail</span></code> to retrieve a single record. These
methods will alter the query adding a <code class="docutils literal"><span class="pre">LIMIT</span> <span class="pre">1</span></code> clause:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="c1">// Get just the first row</span>
<span class="nv">$row</span> <span class="o">=</span> <span class="nv">$query</span><span class="o">-&gt;</span><span class="na">first</span><span class="p">();</span>

<span class="c1">// Get the first row or an exception.</span>
<span class="nv">$row</span> <span class="o">=</span> <span class="nv">$query</span><span class="o">-&gt;</span><span class="na">firstOrFail</span><span class="p">();</span>
</pre></div>
</div>
<div class="section" id="returning-the-total-count-of-records">
<span id="query-count"></span><h3>Returning the Total Count of Records<a class="headerlink" href="#returning-the-total-count-of-records" title="Permalink to this headline">¶</a></h3>
<p>Using a single query object, it is possible to obtain the total number of rows
found for a set of conditions:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="nv">$total</span> <span class="o">=</span> <span class="nv">$articles</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">where</span><span class="p">([</span><span class="s1">&#39;is_active&#39;</span> <span class="o">=&gt;</span> <span class="k">true</span><span class="p">])</span><span class="o">-&gt;</span><span class="na">count</span><span class="p">();</span>
</pre></div>
</div>
<p>The <code class="docutils literal"><span class="pre">count()</span></code> method will ignore the <code class="docutils literal"><span class="pre">limit</span></code>, <code class="docutils literal"><span class="pre">offset</span></code> and <code class="docutils literal"><span class="pre">page</span></code>
clauses, thus the following will return the same result:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="nv">$total</span> <span class="o">=</span> <span class="nv">$articles</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">where</span><span class="p">([</span><span class="s1">&#39;is_active&#39;</span> <span class="o">=&gt;</span> <span class="k">true</span><span class="p">])</span><span class="o">-&gt;</span><span class="na">limit</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">count</span><span class="p">();</span>
</pre></div>
</div>
<p>This is useful when you need to know the total result set size in advance,
without having to construct another <code class="docutils literal"><span class="pre">Query</span></code> object. Likewise, all result
formatting and map-reduce routines are ignored when using the <code class="docutils literal"><span class="pre">count()</span></code>
method.</p>
<p>Moreover, it is possible to return the total count for a query containing group
by clauses without having to rewrite the query in any way. For example, consider
this query for retrieving article ids and their comments count:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="nv">$query</span> <span class="o">=</span> <span class="nv">$articles</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">();</span>
<span class="nv">$query</span><span class="o">-&gt;</span><span class="na">select</span><span class="p">([</span><span class="s1">&#39;Articles.id&#39;</span><span class="p">,</span> <span class="nv">$query</span><span class="o">-&gt;</span><span class="na">func</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">count</span><span class="p">(</span><span class="s1">&#39;Comments.id&#39;</span><span class="p">)])</span>
    <span class="o">-&gt;</span><span class="na">matching</span><span class="p">(</span><span class="s1">&#39;Comments&#39;</span><span class="p">)</span>
    <span class="o">-&gt;</span><span class="na">group</span><span class="p">([</span><span class="s1">&#39;Articles.id&#39;</span><span class="p">]);</span>
<span class="nv">$total</span> <span class="o">=</span> <span class="nv">$query</span><span class="o">-&gt;</span><span class="na">count</span><span class="p">();</span>
</pre></div>
</div>
<p>After counting, the query can still be used for fetching the associated
records:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="nv">$list</span> <span class="o">=</span> <span class="nv">$query</span><span class="o">-&gt;</span><span class="na">all</span><span class="p">();</span>
</pre></div>
</div>
<p>Sometimes, you may want to provide an alternate method for counting the total
records of a query. One common use case for this is providing
a cached value or an estimate of the total rows, or to alter the query to remove
expensive unneeded parts such as left joins. This becomes particularly handy
when using the CakePHP built-in pagination system which calls the <code class="docutils literal"><span class="pre">count()</span></code>
method:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="nv">$query</span> <span class="o">=</span> <span class="nv">$query</span><span class="o">-&gt;</span><span class="na">where</span><span class="p">([</span><span class="s1">&#39;is_active&#39;</span> <span class="o">=&gt;</span> <span class="k">true</span><span class="p">])</span><span class="o">-&gt;</span><span class="na">counter</span><span class="p">(</span><span class="k">function</span> <span class="p">(</span><span class="nv">$query</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="mi">100000</span><span class="p">;</span>
<span class="p">});</span>
<span class="nv">$query</span><span class="o">-&gt;</span><span class="na">count</span><span class="p">();</span> <span class="c1">// Returns 100000</span>
</pre></div>
</div>
<p>In the example above, when the pagination component calls the count method, it
will receive the estimated hard-coded number of rows.</p>
</div>
<div class="section" id="caching-loaded-results">
<span id="caching-query-results"></span><h3>Caching Loaded Results<a class="headerlink" href="#caching-loaded-results" title="Permalink to this headline">¶</a></h3>
<p>When fetching entities that don&#8217;t change often you may want to cache the
results. The <code class="docutils literal"><span class="pre">Query</span></code> class makes this simple:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="nv">$query</span><span class="o">-&gt;</span><span class="na">cache</span><span class="p">(</span><span class="s1">&#39;recent_articles&#39;</span><span class="p">);</span>
</pre></div>
</div>
<p>Will enable caching on the query&#8217;s result set. If only one argument is provided
to <code class="docutils literal"><span class="pre">cache()</span></code> then the &#8216;default&#8217; cache configuration will be used. You can
control which caching configuration is used with the second parameter:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="c1">// String config name.</span>
<span class="nv">$query</span><span class="o">-&gt;</span><span class="na">cache</span><span class="p">(</span><span class="s1">&#39;recent_articles&#39;</span><span class="p">,</span> <span class="s1">&#39;dbResults&#39;</span><span class="p">);</span>

<span class="c1">// Instance of CacheEngine</span>
<span class="nv">$query</span><span class="o">-&gt;</span><span class="na">cache</span><span class="p">(</span><span class="s1">&#39;recent_articles&#39;</span><span class="p">,</span> <span class="nv">$memcache</span><span class="p">);</span>
</pre></div>
</div>
<p>In addition to supporting static keys, the <code class="docutils literal"><span class="pre">cache()</span></code> method accepts a function
to generate the key. The function you give it will receive the query as an
argument. You can then read aspects of the query to dynamically generate the
cache key:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="c1">// Generate a key based on a simple checksum</span>
<span class="c1">// of the query&#39;s where clause</span>
<span class="nv">$query</span><span class="o">-&gt;</span><span class="na">cache</span><span class="p">(</span><span class="k">function</span> <span class="p">(</span><span class="nv">$q</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="s1">&#39;articles-&#39;</span> <span class="o">.</span> <span class="nb">md5</span><span class="p">(</span><span class="nb">serialize</span><span class="p">(</span><span class="nv">$q</span><span class="o">-&gt;</span><span class="na">clause</span><span class="p">(</span><span class="s1">&#39;where&#39;</span><span class="p">)));</span>
<span class="p">});</span>
</pre></div>
</div>
<p>The cache method makes it simple to add cached results to your custom finders or
through event listeners.</p>
<p>When the results for a cached query are fetched the following happens:</p>
<ol class="arabic simple">
<li>The <code class="docutils literal"><span class="pre">Model.beforeFind</span></code> event is triggered.</li>
<li>If the query has results set, those will be returned.</li>
<li>The cache key will be resolved and cache data will be read. If the cache data
is not empty, those results will be returned.</li>
<li>If the cache misses, the query will be executed and a new <code class="docutils literal"><span class="pre">ResultSet</span></code> will be
created. This <code class="docutils literal"><span class="pre">ResultSet</span></code> will be written to the cache and returned.</li>
</ol>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">You cannot cache a streaming query result.</p>
</div>
</div>
</div>
<div class="section" id="loading-associations">
<h2>Loading Associations<a class="headerlink" href="#loading-associations" title="Permalink to this headline">¶</a></h2>
<p>The builder can help you retrieve data from multiple tables at the same time
with the minimum amount of queries possible. To be able to fetch associated
data, you first need to setup associations between the tables as described in
the <a class="reference internal" href="associations.html"><span class="doc">Associations - Linking Tables Together</span></a> section. This technique of combining queries
to fetch associated data from other tables is called <strong>eager loading</strong>.</p>
<p>Eager loading helps avoid many of the potential performance problems
surrounding lazy-loading in an ORM. The queries generated by eager loading can
better leverage joins, allowing more efficient queries to be made. In CakePHP
you define eager loaded associations using the &#8216;contain&#8217; method:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="c1">// In a controller or table method.</span>

<span class="c1">// As an option to find()</span>
<span class="nv">$query</span> <span class="o">=</span> <span class="nv">$articles</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;contain&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">&#39;Authors&#39;</span><span class="p">,</span> <span class="s1">&#39;Comments&#39;</span><span class="p">]]);</span>

<span class="c1">// As a method on the query object</span>
<span class="nv">$query</span> <span class="o">=</span> <span class="nv">$articles</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">);</span>
<span class="nv">$query</span><span class="o">-&gt;</span><span class="na">contain</span><span class="p">([</span><span class="s1">&#39;Authors&#39;</span><span class="p">,</span> <span class="s1">&#39;Comments&#39;</span><span class="p">]);</span>
</pre></div>
</div>
<p>The above will load the related author and comments for each article in the
result set. You can load nested associations using nested arrays to define the
associations to be loaded:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="nv">$query</span> <span class="o">=</span> <span class="nv">$articles</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">contain</span><span class="p">([</span>
    <span class="s1">&#39;Authors&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">&#39;Addresses&#39;</span><span class="p">],</span> <span class="s1">&#39;Comments&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">&#39;Authors&#39;</span><span class="p">]</span>
<span class="p">]);</span>
</pre></div>
</div>
<p>Alternatively, you can express nested associations using the dot notation:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="nv">$query</span> <span class="o">=</span> <span class="nv">$articles</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">contain</span><span class="p">([</span>
    <span class="s1">&#39;Authors.Addresses&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Comments.Authors&#39;</span>
<span class="p">]);</span>
</pre></div>
</div>
<p>You can eager load associations as deep as you like:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="nv">$query</span> <span class="o">=</span> <span class="nv">$products</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">contain</span><span class="p">([</span>
    <span class="s1">&#39;Shops.Cities.Countries&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Shops.Managers&#39;</span>
<span class="p">]);</span>
</pre></div>
</div>
<p>You can select fields from all associations with multiple easy <code class="docutils literal"><span class="pre">contain()</span></code>
statements:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="nv">$query</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">select</span><span class="p">([</span>
    <span class="s1">&#39;Realestates.id&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Realestates.title&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Realestates.description&#39;</span>
<span class="p">])</span>
<span class="o">-&gt;</span><span class="na">contain</span><span class="p">([</span>
    <span class="s1">&#39;RealestateAttributes&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span>
        <span class="s1">&#39;Attributes&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span>
            <span class="s1">&#39;fields&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span>
                <span class="c1">// Aliased fields in contain() must include</span>
                <span class="c1">// the model prefix to be mapped correctly.</span>
                <span class="s1">&#39;Attributes__name&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;attr_name&#39;</span>
            <span class="p">]</span>
        <span class="p">]</span>
    <span class="p">]</span>
<span class="p">])</span>
<span class="o">-&gt;</span><span class="na">contain</span><span class="p">([</span>
    <span class="s1">&#39;RealestateAttributes&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span>
        <span class="s1">&#39;fields&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span>
            <span class="s1">&#39;RealestateAttributes.realestate_id&#39;</span><span class="p">,</span>
            <span class="s1">&#39;RealestateAttributes.value&#39;</span>
        <span class="p">]</span>
    <span class="p">]</span>
<span class="p">])</span>
<span class="o">-&gt;</span><span class="na">where</span><span class="p">(</span><span class="nv">$condition</span><span class="p">);</span>
</pre></div>
</div>
<p>If you need to reset the containments on a query you can set the second argument
to <code class="docutils literal"><span class="pre">true</span></code>:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="nv">$query</span> <span class="o">=</span> <span class="nv">$articles</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">();</span>
<span class="nv">$query</span><span class="o">-&gt;</span><span class="na">contain</span><span class="p">([</span><span class="s1">&#39;Authors&#39;</span><span class="p">,</span> <span class="s1">&#39;Comments&#39;</span><span class="p">],</span> <span class="k">true</span><span class="p">);</span>
</pre></div>
</div>
<div class="section" id="passing-conditions-to-contain">
<h3>Passing Conditions to Contain<a class="headerlink" href="#passing-conditions-to-contain" title="Permalink to this headline">¶</a></h3>
<p>When using <code class="docutils literal"><span class="pre">contain()</span></code> you are able to restrict the data returned by the
associations and filter them by conditions:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="c1">// In a controller or table method.</span>

<span class="nv">$query</span> <span class="o">=</span> <span class="nv">$articles</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">contain</span><span class="p">(</span><span class="s1">&#39;Comments&#39;</span><span class="p">,</span> <span class="k">function</span> <span class="p">(</span><span class="nv">$q</span><span class="p">)</span> <span class="p">{</span>
   <span class="k">return</span> <span class="nv">$q</span>
        <span class="o">-&gt;</span><span class="na">select</span><span class="p">([</span><span class="s1">&#39;body&#39;</span><span class="p">,</span> <span class="s1">&#39;author_id&#39;</span><span class="p">])</span>
        <span class="o">-&gt;</span><span class="na">where</span><span class="p">([</span><span class="s1">&#39;Comments.approved&#39;</span> <span class="o">=&gt;</span> <span class="k">true</span><span class="p">]);</span>
<span class="p">});</span>
</pre></div>
</div>
<p>This also works for pagination at the Controller level:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">paginate</span><span class="p">[</span><span class="s1">&#39;contain&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;Comments&#39;</span> <span class="o">=&gt;</span> <span class="k">function</span> <span class="p">(</span><span class="nx">\Cake\ORM\Query</span> <span class="nv">$query</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$query</span><span class="o">-&gt;</span><span class="na">select</span><span class="p">([</span><span class="s1">&#39;body&#39;</span><span class="p">,</span> <span class="s1">&#39;author_id&#39;</span><span class="p">])</span>
        <span class="o">-&gt;</span><span class="na">where</span><span class="p">([</span><span class="s1">&#39;Comments.approved&#39;</span> <span class="o">=&gt;</span> <span class="k">true</span><span class="p">]);</span>
    <span class="p">}</span>
<span class="p">];</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">When you limit the fields that are fetched from an association, you <strong>must</strong>
ensure that the foreign key columns are selected. Failing to select foreign
key fields will cause associated data to not be present in the final result.</p>
</div>
<p>It is also possible to restrict deeply-nested associations using the dot
notation:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="nv">$query</span> <span class="o">=</span> <span class="nv">$articles</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">contain</span><span class="p">([</span>
    <span class="s1">&#39;Comments&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Authors.Profiles&#39;</span> <span class="o">=&gt;</span> <span class="k">function</span> <span class="p">(</span><span class="nv">$q</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$q</span><span class="o">-&gt;</span><span class="na">where</span><span class="p">([</span><span class="s1">&#39;Profiles.is_published&#39;</span> <span class="o">=&gt;</span> <span class="k">true</span><span class="p">]);</span>
    <span class="p">}</span>
<span class="p">]);</span>
</pre></div>
</div>
<p>In the above example, you&#8217;ll still get authors even if they don&#8217;t have
a published profile. To only get authors with a published profile use
<a class="reference internal" href="retrieving-data-and-resultsets.html#filtering-by-associated-data"><span class="std std-ref">matching()</span></a>. If you have defined custom
finders in your associations, you can use them inside <code class="docutils literal"><span class="pre">contain()</span></code>:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="c1">// Bring all articles, but only bring the comments that are approved and</span>
<span class="c1">// popular.</span>
<span class="nv">$query</span> <span class="o">=</span> <span class="nv">$articles</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">contain</span><span class="p">(</span><span class="s1">&#39;Comments&#39;</span><span class="p">,</span> <span class="k">function</span> <span class="p">(</span><span class="nv">$q</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nv">$q</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">(</span><span class="s1">&#39;approved&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">(</span><span class="s1">&#39;popular&#39;</span><span class="p">);</span>
<span class="p">});</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">For <code class="docutils literal"><span class="pre">BelongsTo</span></code> and <code class="docutils literal"><span class="pre">HasOne</span></code> associations only the <code class="docutils literal"><span class="pre">where</span></code> and
<code class="docutils literal"><span class="pre">select</span></code> clauses are used when loading the associated records. For the
rest of the association types you can use every clause that the query object
provides.</p>
</div>
<p>If you need full control over the query that is generated, you can tell <code class="docutils literal"><span class="pre">contain()</span></code>
to not append the <code class="docutils literal"><span class="pre">foreignKey</span></code> constraints to the generated query. In that
case you should use an array passing <code class="docutils literal"><span class="pre">foreignKey</span></code> and <code class="docutils literal"><span class="pre">queryBuilder</span></code>:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="nv">$query</span> <span class="o">=</span> <span class="nv">$articles</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">contain</span><span class="p">([</span>
    <span class="s1">&#39;Authors&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span>
        <span class="s1">&#39;foreignKey&#39;</span> <span class="o">=&gt;</span> <span class="k">false</span><span class="p">,</span>
        <span class="s1">&#39;queryBuilder&#39;</span> <span class="o">=&gt;</span> <span class="k">function</span> <span class="p">(</span><span class="nv">$q</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nv">$q</span><span class="o">-&gt;</span><span class="na">where</span><span class="p">(</span><span class="o">...</span><span class="p">);</span> <span class="c1">// Full conditions for filtering</span>
        <span class="p">}</span>
    <span class="p">]</span>
<span class="p">]);</span>
</pre></div>
</div>
<p>If you have limited the fields you are loading with <code class="docutils literal"><span class="pre">select()</span></code> but also want to
load fields off of contained associations, you can pass the association object
to <code class="docutils literal"><span class="pre">select()</span></code>:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="c1">// Select id &amp; title from articles, but all fields off of Users.</span>
<span class="nv">$query</span> <span class="o">=</span> <span class="nv">$articles</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">()</span>
    <span class="o">-&gt;</span><span class="na">select</span><span class="p">([</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;title&#39;</span><span class="p">])</span>
    <span class="o">-&gt;</span><span class="na">select</span><span class="p">(</span><span class="nv">$articles</span><span class="o">-&gt;</span><span class="na">Users</span><span class="p">)</span>
    <span class="o">-&gt;</span><span class="na">contain</span><span class="p">([</span><span class="s1">&#39;Users&#39;</span><span class="p">]);</span>
</pre></div>
</div>
<p>Alternatively, if you have multiple associations, you can use <code class="docutils literal"><span class="pre">enableAutoFields()</span></code>:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="c1">// Select id &amp; title from articles, but all fields off of Users, Comments</span>
<span class="c1">// and Tags.</span>
<span class="nv">$query</span><span class="o">-&gt;</span><span class="na">select</span><span class="p">([</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;title&#39;</span><span class="p">])</span>
    <span class="o">-&gt;</span><span class="na">contain</span><span class="p">([</span><span class="s1">&#39;Comments&#39;</span><span class="p">,</span> <span class="s1">&#39;Tags&#39;</span><span class="p">])</span>
    <span class="o">-&gt;</span><span class="na">enableAutoFields</span><span class="p">(</span><span class="k">true</span><span class="p">)</span> <span class="c1">// Prior to 3.4.0 use autoFields(true)</span>
    <span class="o">-&gt;</span><span class="na">contain</span><span class="p">([</span><span class="s1">&#39;Users&#39;</span> <span class="o">=&gt;</span> <span class="k">function</span><span class="p">(</span><span class="nv">$q</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$q</span><span class="o">-&gt;</span><span class="na">autoFields</span><span class="p">(</span><span class="k">true</span><span class="p">);</span>
    <span class="p">}]);</span>
</pre></div>
</div>
<div class="versionadded">
<p><span class="versionmodified">New in version 3.1: </span>Selecting columns via an association object was added in 3.1</p>
</div>
</div>
<div class="section" id="sorting-contained-associations">
<h3>Sorting Contained Associations<a class="headerlink" href="#sorting-contained-associations" title="Permalink to this headline">¶</a></h3>
<p>When loading HasMany and BelongsToMany associations, you can use the <code class="docutils literal"><span class="pre">sort</span></code>
option to sort the data in those associations:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="nv">$query</span><span class="o">-&gt;</span><span class="na">contain</span><span class="p">([</span>
    <span class="s1">&#39;Comments&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span>
        <span class="s1">&#39;sort&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">&#39;Comments.created&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;DESC&#39;</span><span class="p">]</span>
    <span class="p">]</span>
<span class="p">]);</span>
</pre></div>
</div>
</div>
<div class="section" id="filtering-by-associated-data">
<h3>Filtering by Associated Data<a class="headerlink" href="#filtering-by-associated-data" title="Permalink to this headline">¶</a></h3>
<p>A fairly common query case with associations is finding records &#8216;matching&#8217;
specific associated data. For example if you have &#8216;Articles belongsToMany Tags&#8217;
you will probably want to find Articles that have the CakePHP tag. This is
extremely simple to do with the ORM in CakePHP:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="c1">// In a controller or table method.</span>

<span class="nv">$query</span> <span class="o">=</span> <span class="nv">$articles</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">();</span>
<span class="nv">$query</span><span class="o">-&gt;</span><span class="na">matching</span><span class="p">(</span><span class="s1">&#39;Tags&#39;</span><span class="p">,</span> <span class="k">function</span> <span class="p">(</span><span class="nv">$q</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nv">$q</span><span class="o">-&gt;</span><span class="na">where</span><span class="p">([</span><span class="s1">&#39;Tags.name&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;CakePHP&#39;</span><span class="p">]);</span>
<span class="p">});</span>
</pre></div>
</div>
<p>You can apply this strategy to HasMany associations as well. For example if
&#8216;Authors HasMany Articles&#8217;, you could find all the authors with recently
published articles using the following:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="nv">$query</span> <span class="o">=</span> <span class="nv">$authors</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">();</span>
<span class="nv">$query</span><span class="o">-&gt;</span><span class="na">matching</span><span class="p">(</span><span class="s1">&#39;Articles&#39;</span><span class="p">,</span> <span class="k">function</span> <span class="p">(</span><span class="nv">$q</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nv">$q</span><span class="o">-&gt;</span><span class="na">where</span><span class="p">([</span><span class="s1">&#39;Articles.created &gt;=&#39;</span> <span class="o">=&gt;</span> <span class="k">new</span> <span class="nx">DateTime</span><span class="p">(</span><span class="s1">&#39;-10 days&#39;</span><span class="p">)]);</span>
<span class="p">});</span>
</pre></div>
</div>
<p>Filtering by deep associations is surprisingly easy, and the syntax should be
already familiar to you:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="c1">// In a controller or table method.</span>
<span class="nv">$query</span> <span class="o">=</span> <span class="nv">$products</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">matching</span><span class="p">(</span>
    <span class="s1">&#39;Shops.Cities.Countries&#39;</span><span class="p">,</span> <span class="k">function</span> <span class="p">(</span><span class="nv">$q</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$q</span><span class="o">-&gt;</span><span class="na">where</span><span class="p">([</span><span class="s1">&#39;Countries.name&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Japan&#39;</span><span class="p">]);</span>
    <span class="p">}</span>
<span class="p">);</span>

<span class="c1">// Bring unique articles that were commented by &#39;markstory&#39; using passed variable</span>
<span class="c1">// Dotted matching paths should be used over nested matching() calls</span>
<span class="nv">$username</span> <span class="o">=</span> <span class="s1">&#39;markstory&#39;</span><span class="p">;</span>
<span class="nv">$query</span> <span class="o">=</span> <span class="nv">$articles</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">matching</span><span class="p">(</span><span class="s1">&#39;Comments.Users&#39;</span><span class="p">,</span> <span class="k">function</span> <span class="p">(</span><span class="nv">$q</span><span class="p">)</span> <span class="k">use</span> <span class="p">(</span><span class="nv">$username</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nv">$q</span><span class="o">-&gt;</span><span class="na">where</span><span class="p">([</span><span class="s1">&#39;username&#39;</span> <span class="o">=&gt;</span> <span class="nv">$username</span><span class="p">]);</span>
<span class="p">});</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">As this function will create an <code class="docutils literal"><span class="pre">INNER</span> <span class="pre">JOIN</span></code>, you might want to consider
calling <code class="docutils literal"><span class="pre">distinct</span></code> on the find query as you might get duplicate rows if
your conditions don&#8217;t exclude them already. This might be the case, for
example, when the same users comments more than once on a single article.</p>
</div>
<p>The data from the association that is &#8216;matched&#8217; will be available on the
<code class="docutils literal"><span class="pre">_matchingData</span></code> property of entities. If you both match and contain the same
association, you can expect to get both the <code class="docutils literal"><span class="pre">_matchingData</span></code> and standard
association properties in your results.</p>
</div>
<div class="section" id="using-innerjoinwith">
<h3>Using innerJoinWith<a class="headerlink" href="#using-innerjoinwith" title="Permalink to this headline">¶</a></h3>
<p>Using the <code class="docutils literal"><span class="pre">matching()</span></code> function, as we saw already, will create an <code class="docutils literal"><span class="pre">INNER</span>
<span class="pre">JOIN</span></code> with the specified association and will also load the fields into the
result set.</p>
<p>There may be cases where you want to use <code class="docutils literal"><span class="pre">matching()</span></code> but are not interested
in loading the fields into the result set. For this purpose, you can use
<code class="docutils literal"><span class="pre">innerJoinWith()</span></code>:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="nv">$query</span> <span class="o">=</span> <span class="nv">$articles</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">();</span>
<span class="nv">$query</span><span class="o">-&gt;</span><span class="na">innerJoinWith</span><span class="p">(</span><span class="s1">&#39;Tags&#39;</span><span class="p">,</span> <span class="k">function</span> <span class="p">(</span><span class="nv">$q</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nv">$q</span><span class="o">-&gt;</span><span class="na">where</span><span class="p">([</span><span class="s1">&#39;Tags.name&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;CakePHP&#39;</span><span class="p">]);</span>
<span class="p">});</span>
</pre></div>
</div>
<p>The <code class="docutils literal"><span class="pre">innerJoinWith()</span></code> method works the same as <code class="docutils literal"><span class="pre">matching()</span></code>, that
means that you can use dot notation to join deeply nested
associations:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="nv">$query</span> <span class="o">=</span> <span class="nv">$products</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">innerJoinWith</span><span class="p">(</span>
    <span class="s1">&#39;Shops.Cities.Countries&#39;</span><span class="p">,</span> <span class="k">function</span> <span class="p">(</span><span class="nv">$q</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$q</span><span class="o">-&gt;</span><span class="na">where</span><span class="p">([</span><span class="s1">&#39;Countries.name&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Japan&#39;</span><span class="p">]);</span>
    <span class="p">}</span>
<span class="p">);</span>
</pre></div>
</div>
<p>Again, the only difference is that no additional columns will be added to the
result set, and no <code class="docutils literal"><span class="pre">_matchingData</span></code> property will be set.</p>
<div class="versionadded">
<p><span class="versionmodified">New in version 3.1: </span>Query::innerJoinWith() was added in 3.1</p>
</div>
</div>
<div class="section" id="using-notmatching">
<h3>Using notMatching<a class="headerlink" href="#using-notmatching" title="Permalink to this headline">¶</a></h3>
<p>The opposite of <code class="docutils literal"><span class="pre">matching()</span></code> is <code class="docutils literal"><span class="pre">notMatching()</span></code>. This function will change
the query so that it filters results that have no relation to the specified
association:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="c1">// In a controller or table method.</span>

<span class="nv">$query</span> <span class="o">=</span> <span class="nv">$articlesTable</span>
    <span class="o">-&gt;</span><span class="na">find</span><span class="p">()</span>
    <span class="o">-&gt;</span><span class="na">notMatching</span><span class="p">(</span><span class="s1">&#39;Tags&#39;</span><span class="p">,</span> <span class="k">function</span> <span class="p">(</span><span class="nv">$q</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$q</span><span class="o">-&gt;</span><span class="na">where</span><span class="p">([</span><span class="s1">&#39;Tags.name&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;boring&#39;</span><span class="p">]);</span>
    <span class="p">});</span>
</pre></div>
</div>
<p>The above example will find all articles that were not tagged with the word
<code class="docutils literal"><span class="pre">boring</span></code>.  You can apply this method to HasMany associations as well. You could,
for example, find all the authors with no published articles in the last 10
days:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="nv">$query</span> <span class="o">=</span> <span class="nv">$authorsTable</span>
    <span class="o">-&gt;</span><span class="na">find</span><span class="p">()</span>
    <span class="o">-&gt;</span><span class="na">notMatching</span><span class="p">(</span><span class="s1">&#39;Articles&#39;</span><span class="p">,</span> <span class="k">function</span> <span class="p">(</span><span class="nv">$q</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$q</span><span class="o">-&gt;</span><span class="na">where</span><span class="p">([</span><span class="s1">&#39;Articles.created &gt;=&#39;</span> <span class="o">=&gt;</span> <span class="k">new</span> <span class="nx">\DateTime</span><span class="p">(</span><span class="s1">&#39;-10 days&#39;</span><span class="p">)]);</span>
    <span class="p">});</span>
</pre></div>
</div>
<p>It is also possible to use this method for filtering out records not matching
deep associations. For example, you could find articles that have not been
commented on by a certain user:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="nv">$query</span> <span class="o">=</span> <span class="nv">$articlesTable</span>
    <span class="o">-&gt;</span><span class="na">find</span><span class="p">()</span>
    <span class="o">-&gt;</span><span class="na">notMatching</span><span class="p">(</span><span class="s1">&#39;Comments.Users&#39;</span><span class="p">,</span> <span class="k">function</span> <span class="p">(</span><span class="nv">$q</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$q</span><span class="o">-&gt;</span><span class="na">where</span><span class="p">([</span><span class="s1">&#39;username&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;jose&#39;</span><span class="p">]);</span>
    <span class="p">});</span>
</pre></div>
</div>
<p>Since articles with no comments at all also satisfy the condition above, you may
want to combine <code class="docutils literal"><span class="pre">matching()</span></code> and <code class="docutils literal"><span class="pre">notMatching()</span></code> in the same query. The
following example will find articles having at least one comment, but not
commented by a certain user:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="nv">$query</span> <span class="o">=</span> <span class="nv">$articlesTable</span>
    <span class="o">-&gt;</span><span class="na">find</span><span class="p">()</span>
    <span class="o">-&gt;</span><span class="na">notMatching</span><span class="p">(</span><span class="s1">&#39;Comments.Users&#39;</span><span class="p">,</span> <span class="k">function</span> <span class="p">(</span><span class="nv">$q</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$q</span><span class="o">-&gt;</span><span class="na">where</span><span class="p">([</span><span class="s1">&#39;username&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;jose&#39;</span><span class="p">]);</span>
    <span class="p">})</span>
    <span class="o">-&gt;</span><span class="na">matching</span><span class="p">(</span><span class="s1">&#39;Comments&#39;</span><span class="p">);</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">As <code class="docutils literal"><span class="pre">notMatching()</span></code> will create a <code class="docutils literal"><span class="pre">LEFT</span> <span class="pre">JOIN</span></code>, you might want to consider
calling <code class="docutils literal"><span class="pre">distinct</span></code> on the find query as you can get duplicate rows
otherwise.</p>
</div>
<p>Keep in mind that contrary to the <code class="docutils literal"><span class="pre">matching()</span></code> function, <code class="docutils literal"><span class="pre">notMatching()</span></code>
will not add any data to the <code class="docutils literal"><span class="pre">_matchingData</span></code> property in the results.</p>
<div class="versionadded">
<p><span class="versionmodified">New in version 3.1: </span>Query::notMatching() was added in 3.1</p>
</div>
</div>
<div class="section" id="using-leftjoinwith">
<h3>Using leftJoinWith<a class="headerlink" href="#using-leftjoinwith" title="Permalink to this headline">¶</a></h3>
<p>On certain occasions you may want to calculate a result based on an association,
without having to load all the records for it. For example, if you wanted to
load the total number of comments an article has along with all the article
data, you can use the <code class="docutils literal"><span class="pre">leftJoinWith()</span></code> function:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="nv">$query</span> <span class="o">=</span> <span class="nv">$articlesTable</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">();</span>
<span class="nv">$query</span><span class="o">-&gt;</span><span class="na">select</span><span class="p">([</span><span class="s1">&#39;total_comments&#39;</span> <span class="o">=&gt;</span> <span class="nv">$query</span><span class="o">-&gt;</span><span class="na">func</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">count</span><span class="p">(</span><span class="s1">&#39;Comments.id&#39;</span><span class="p">)])</span>
    <span class="o">-&gt;</span><span class="na">leftJoinWith</span><span class="p">(</span><span class="s1">&#39;Comments&#39;</span><span class="p">)</span>
    <span class="o">-&gt;</span><span class="na">group</span><span class="p">([</span><span class="s1">&#39;Articles.id&#39;</span><span class="p">])</span>
    <span class="o">-&gt;</span><span class="na">enableAutoFields</span><span class="p">(</span><span class="k">true</span><span class="p">);</span> <span class="c1">// Prior to 3.4.0 use autoFields(true);</span>
</pre></div>
</div>
<p>The results for the above query will contain the article data and the
<code class="docutils literal"><span class="pre">total_comments</span></code> property for each of them.</p>
<p><code class="docutils literal"><span class="pre">leftJoinWith()</span></code> can also be used with deeply nested associations. This is
useful, for example, for bringing the count of articles tagged with a certain
word, per author:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="nv">$query</span> <span class="o">=</span> <span class="nv">$authorsTable</span>
    <span class="o">-&gt;</span><span class="na">find</span><span class="p">()</span>
    <span class="o">-&gt;</span><span class="na">select</span><span class="p">([</span><span class="s1">&#39;total_articles&#39;</span> <span class="o">=&gt;</span> <span class="nv">$query</span><span class="o">-&gt;</span><span class="na">func</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">count</span><span class="p">(</span><span class="s1">&#39;Articles.id&#39;</span><span class="p">)])</span>
    <span class="o">-&gt;</span><span class="na">leftJoinWith</span><span class="p">(</span><span class="s1">&#39;Articles.Tags&#39;</span><span class="p">,</span> <span class="k">function</span> <span class="p">(</span><span class="nv">$q</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$q</span><span class="o">-&gt;</span><span class="na">where</span><span class="p">([</span><span class="s1">&#39;Tags.name&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;awesome&#39;</span><span class="p">]);</span>
    <span class="p">})</span>
    <span class="o">-&gt;</span><span class="na">group</span><span class="p">([</span><span class="s1">&#39;Authors.id&#39;</span><span class="p">])</span>
    <span class="o">-&gt;</span><span class="na">enableAutoFields</span><span class="p">(</span><span class="k">true</span><span class="p">);</span> <span class="c1">// Prior to 3.4.0 use autoFields(true);</span>
</pre></div>
</div>
<p>This function will not load any columns from the specified associations into the
result set.</p>
<div class="versionadded">
<p><span class="versionmodified">New in version 3.1: </span>Query::leftJoinWith() was added in 3.1</p>
</div>
</div>
<div class="section" id="adding-joins">
<span id="id2"></span><h3>Adding Joins<a class="headerlink" href="#adding-joins" title="Permalink to this headline">¶</a></h3>
<p>In addition to loading related data with <code class="docutils literal"><span class="pre">contain()</span></code>, you can also add
additional joins with the query builder:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="nv">$query</span> <span class="o">=</span> <span class="nv">$articles</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">()</span>
    <span class="o">-&gt;</span><span class="na">hydrate</span><span class="p">(</span><span class="k">false</span><span class="p">)</span>
    <span class="o">-&gt;</span><span class="na">join</span><span class="p">([</span>
        <span class="s1">&#39;table&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;comments&#39;</span><span class="p">,</span>
        <span class="s1">&#39;alias&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;c&#39;</span><span class="p">,</span>
        <span class="s1">&#39;type&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;LEFT&#39;</span><span class="p">,</span>
        <span class="s1">&#39;conditions&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;c.article_id = articles.id&#39;</span><span class="p">,</span>
    <span class="p">]);</span>
</pre></div>
</div>
<p>You can append multiple joins at the same time by passing an associative array
with multiple joins:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="nv">$query</span> <span class="o">=</span> <span class="nv">$articles</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">()</span>
    <span class="o">-&gt;</span><span class="na">hydrate</span><span class="p">(</span><span class="k">false</span><span class="p">)</span>
    <span class="o">-&gt;</span><span class="na">join</span><span class="p">([</span>
        <span class="s1">&#39;c&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span>
            <span class="s1">&#39;table&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;comments&#39;</span><span class="p">,</span>
            <span class="s1">&#39;type&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;LEFT&#39;</span><span class="p">,</span>
            <span class="s1">&#39;conditions&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;c.article_id = articles.id&#39;</span><span class="p">,</span>
        <span class="p">],</span>
        <span class="s1">&#39;u&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span>
            <span class="s1">&#39;table&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;users&#39;</span><span class="p">,</span>
            <span class="s1">&#39;type&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;INNER&#39;</span><span class="p">,</span>
            <span class="s1">&#39;conditions&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;u.id = articles.user_id&#39;</span><span class="p">,</span>
        <span class="p">]</span>
    <span class="p">]);</span>
</pre></div>
</div>
<p>As seen above, when adding joins the alias can be the outer array key. Join
conditions can also be expressed as an array of conditions:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="nv">$query</span> <span class="o">=</span> <span class="nv">$articles</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">()</span>
    <span class="o">-&gt;</span><span class="na">hydrate</span><span class="p">(</span><span class="k">false</span><span class="p">)</span>
    <span class="o">-&gt;</span><span class="na">join</span><span class="p">([</span>
        <span class="s1">&#39;c&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span>
            <span class="s1">&#39;table&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;comments&#39;</span><span class="p">,</span>
            <span class="s1">&#39;type&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;LEFT&#39;</span><span class="p">,</span>
            <span class="s1">&#39;conditions&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span>
                <span class="s1">&#39;c.created &gt;&#39;</span> <span class="o">=&gt;</span> <span class="k">new</span> <span class="nx">DateTime</span><span class="p">(</span><span class="s1">&#39;-5 days&#39;</span><span class="p">),</span>
                <span class="s1">&#39;c.moderated&#39;</span> <span class="o">=&gt;</span> <span class="k">true</span><span class="p">,</span>
                <span class="s1">&#39;c.article_id = articles.id&#39;</span>
            <span class="p">]</span>
        <span class="p">],</span>
    <span class="p">],</span> <span class="p">[</span><span class="s1">&#39;c.created&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;datetime&#39;</span><span class="p">,</span> <span class="s1">&#39;c.moderated&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;boolean&#39;</span><span class="p">]);</span>
</pre></div>
</div>
<p>When creating joins by hand and using array based conditions, you need to
provide the datatypes for each column in the join conditions. By providing
datatypes for the join conditions, the ORM can correctly convert data types into
SQL. In addition to <code class="docutils literal"><span class="pre">join()</span></code> you can use <code class="docutils literal"><span class="pre">rightJoin()</span></code>, <code class="docutils literal"><span class="pre">leftJoin()</span></code> and
<code class="docutils literal"><span class="pre">innerJoin()</span></code> to create joins:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="c1">// Join with an alias and string conditions</span>
<span class="nv">$query</span> <span class="o">=</span> <span class="nv">$articles</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">();</span>
<span class="nv">$query</span><span class="o">-&gt;</span><span class="na">leftJoin</span><span class="p">(</span>
    <span class="p">[</span><span class="s1">&#39;Authors&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;authors&#39;</span><span class="p">],</span>
    <span class="p">[</span><span class="s1">&#39;Authors.id = Articles.author_id&#39;</span><span class="p">]);</span>

<span class="c1">// Join with an alias, array conditions, and types</span>
<span class="nv">$query</span> <span class="o">=</span> <span class="nv">$articles</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">();</span>
<span class="nv">$query</span><span class="o">-&gt;</span><span class="na">innerJoin</span><span class="p">(</span>
    <span class="p">[</span><span class="s1">&#39;Authors&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;authors&#39;</span><span class="p">],</span>
    <span class="p">[</span>
    <span class="s1">&#39;Authors.promoted&#39;</span> <span class="o">=&gt;</span> <span class="k">true</span><span class="p">,</span>
    <span class="s1">&#39;Authors.created&#39;</span> <span class="o">=&gt;</span> <span class="k">new</span> <span class="nx">DateTime</span><span class="p">(</span><span class="s1">&#39;-5 days&#39;</span><span class="p">),</span>
    <span class="s1">&#39;Authors.id = Articles.author_id&#39;</span>
    <span class="p">],</span>
    <span class="p">[</span><span class="s1">&#39;Authors.promoted&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;boolean&#39;</span><span class="p">,</span> <span class="s1">&#39;Authors.created&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;datetime&#39;</span><span class="p">]);</span>
</pre></div>
</div>
<p>It should be noted that if you set the <code class="docutils literal"><span class="pre">quoteIdentifiers</span></code> option to <code class="docutils literal"><span class="pre">true</span></code> when
defining your <code class="docutils literal"><span class="pre">Connection</span></code>, join conditions between table fields should be set as follow:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="nv">$query</span> <span class="o">=</span> <span class="nv">$articles</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">()</span>
    <span class="o">-&gt;</span><span class="na">join</span><span class="p">([</span>
        <span class="s1">&#39;c&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span>
            <span class="s1">&#39;table&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;comments&#39;</span><span class="p">,</span>
            <span class="s1">&#39;type&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;LEFT&#39;</span><span class="p">,</span>
            <span class="s1">&#39;conditions&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span>
                <span class="s1">&#39;c.article_id&#39;</span> <span class="o">=&gt;</span> <span class="k">new</span> <span class="nx">\Cake\Database\Expression\IdentifierExpression</span><span class="p">(</span><span class="s1">&#39;articles.id&#39;</span><span class="p">)</span>
            <span class="p">]</span>
        <span class="p">],</span>
    <span class="p">]);</span>
</pre></div>
</div>
<p>This ensures that all of your identifiers will be quoted across the Query, avoiding errors with
some database Drivers (PostgreSQL notably)</p>
</div>
</div>
<div class="section" id="inserting-data">
<h2>Inserting Data<a class="headerlink" href="#inserting-data" title="Permalink to this headline">¶</a></h2>
<p>Unlike earlier examples, you should not use <code class="docutils literal"><span class="pre">find()</span></code> to create insert queries.
Instead, create a new <code class="docutils literal"><span class="pre">Query</span></code> object using <code class="docutils literal"><span class="pre">query()</span></code>:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="nv">$query</span> <span class="o">=</span> <span class="nv">$articles</span><span class="o">-&gt;</span><span class="na">query</span><span class="p">();</span>
<span class="nv">$query</span><span class="o">-&gt;</span><span class="na">insert</span><span class="p">([</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="s1">&#39;body&#39;</span><span class="p">])</span>
    <span class="o">-&gt;</span><span class="na">values</span><span class="p">([</span>
        <span class="s1">&#39;title&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;First post&#39;</span><span class="p">,</span>
        <span class="s1">&#39;body&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Some body text&#39;</span>
    <span class="p">])</span>
    <span class="o">-&gt;</span><span class="na">execute</span><span class="p">();</span>
</pre></div>
</div>
<p>To insert multiple rows with only one query, you can chain the <code class="docutils literal"><span class="pre">values()</span></code>
method as many times as you need:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="nv">$query</span> <span class="o">=</span> <span class="nv">$articles</span><span class="o">-&gt;</span><span class="na">query</span><span class="p">();</span>
<span class="nv">$query</span><span class="o">-&gt;</span><span class="na">insert</span><span class="p">([</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="s1">&#39;body&#39;</span><span class="p">])</span>
    <span class="o">-&gt;</span><span class="na">values</span><span class="p">([</span>
        <span class="s1">&#39;title&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;First post&#39;</span><span class="p">,</span>
        <span class="s1">&#39;body&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Some body text&#39;</span>
    <span class="p">])</span>
    <span class="o">-&gt;</span><span class="na">values</span><span class="p">([</span>
        <span class="s1">&#39;title&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Second post&#39;</span><span class="p">,</span>
        <span class="s1">&#39;body&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Another body text&#39;</span>
    <span class="p">])</span>
    <span class="o">-&gt;</span><span class="na">execute</span><span class="p">();</span>
</pre></div>
</div>
<p>Generally, it is easier to insert data using entities and
<a class="reference internal" href="saving-data.html#Cake\ORM\Table::save" title="Cake\ORM\Table::save"><code class="xref php php-meth docutils literal"><span class="pre">ORM\Table::save()</span></code></a>. By composing a <code class="docutils literal"><span class="pre">SELECT</span></code> and
<code class="docutils literal"><span class="pre">INSERT</span></code> query together, you can create <code class="docutils literal"><span class="pre">INSERT</span> <span class="pre">INTO</span> <span class="pre">...</span> <span class="pre">SELECT</span></code> style
queries:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="nv">$select</span> <span class="o">=</span> <span class="nv">$articles</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">()</span>
    <span class="o">-&gt;</span><span class="na">select</span><span class="p">([</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="s1">&#39;body&#39;</span><span class="p">,</span> <span class="s1">&#39;published&#39;</span><span class="p">])</span>
    <span class="o">-&gt;</span><span class="na">where</span><span class="p">([</span><span class="s1">&#39;id&#39;</span> <span class="o">=&gt;</span> <span class="mi">3</span><span class="p">]);</span>

<span class="nv">$query</span> <span class="o">=</span> <span class="nv">$articles</span><span class="o">-&gt;</span><span class="na">query</span><span class="p">()</span>
    <span class="o">-&gt;</span><span class="na">insert</span><span class="p">([</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="s1">&#39;body&#39;</span><span class="p">,</span> <span class="s1">&#39;published&#39;</span><span class="p">])</span>
    <span class="o">-&gt;</span><span class="na">values</span><span class="p">(</span><span class="nv">$select</span><span class="p">)</span>
    <span class="o">-&gt;</span><span class="na">execute</span><span class="p">();</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Inserting records with the query builder will not trigger events such as
<code class="docutils literal"><span class="pre">Model.afterSave</span></code>. Instead you should use the <a class="reference internal" href="saving-data.html"><span class="doc">ORM to save
data</span></a>.</p>
</div>
</div>
<div class="section" id="updating-data">
<span id="query-builder-updating-data"></span><h2>Updating Data<a class="headerlink" href="#updating-data" title="Permalink to this headline">¶</a></h2>
<p>As with insert queries, you should not use <code class="docutils literal"><span class="pre">find()</span></code> to create update queries.
Instead, create new a <code class="docutils literal"><span class="pre">Query</span></code> object using <code class="docutils literal"><span class="pre">query()</span></code>:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="nv">$query</span> <span class="o">=</span> <span class="nv">$articles</span><span class="o">-&gt;</span><span class="na">query</span><span class="p">();</span>
<span class="nv">$query</span><span class="o">-&gt;</span><span class="na">update</span><span class="p">()</span>
    <span class="o">-&gt;</span><span class="na">set</span><span class="p">([</span><span class="s1">&#39;published&#39;</span> <span class="o">=&gt;</span> <span class="k">true</span><span class="p">])</span>
    <span class="o">-&gt;</span><span class="na">where</span><span class="p">([</span><span class="s1">&#39;id&#39;</span> <span class="o">=&gt;</span> <span class="nv">$id</span><span class="p">])</span>
    <span class="o">-&gt;</span><span class="na">execute</span><span class="p">();</span>
</pre></div>
</div>
<p>Generally, it is easier to update data using entities and
<code class="xref php php-meth docutils literal"><span class="pre">ORM\Table::patchEntity()</span></code>.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Updating records with the query builder will not trigger events such as
<code class="docutils literal"><span class="pre">Model.afterSave</span></code>. Instead you should use the <a class="reference internal" href="saving-data.html"><span class="doc">ORM to save
data</span></a>.</p>
</div>
</div>
<div class="section" id="deleting-data">
<h2>Deleting Data<a class="headerlink" href="#deleting-data" title="Permalink to this headline">¶</a></h2>
<p>As with insert queries, you should not use <code class="docutils literal"><span class="pre">find()</span></code> to create delete queries.
Instead, create new a query object using <code class="docutils literal"><span class="pre">query()</span></code>:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="nv">$query</span> <span class="o">=</span> <span class="nv">$articles</span><span class="o">-&gt;</span><span class="na">query</span><span class="p">();</span>
<span class="nv">$query</span><span class="o">-&gt;</span><span class="na">delete</span><span class="p">()</span>
    <span class="o">-&gt;</span><span class="na">where</span><span class="p">([</span><span class="s1">&#39;id&#39;</span> <span class="o">=&gt;</span> <span class="nv">$id</span><span class="p">])</span>
    <span class="o">-&gt;</span><span class="na">execute</span><span class="p">();</span>
</pre></div>
</div>
<p>Generally, it is easier to delete data using entities and
<a class="reference internal" href="deleting-data.html#Cake\ORM\Table::delete" title="Cake\ORM\Table::delete"><code class="xref php php-meth docutils literal"><span class="pre">ORM\Table::delete()</span></code></a>.</p>
</div>
<div class="section" id="sql-injection-prevention">
<h2>SQL Injection Prevention<a class="headerlink" href="#sql-injection-prevention" title="Permalink to this headline">¶</a></h2>
<p>While the ORM and database abstraction layers prevent most SQL injections
issues, it is still possible to leave yourself vulnerable through improper use.</p>
<p>When using condition arrays, the key/left-hand side as well as single value
entries must not contain user data:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="nv">$query</span><span class="o">-&gt;</span><span class="na">where</span><span class="p">([</span>
    <span class="c1">// Data on the key/left-hand side is unsafe, as it will be</span>
    <span class="c1">// inserted into the generated query as-is</span>
    <span class="nv">$userData</span> <span class="o">=&gt;</span> <span class="nv">$value</span><span class="p">,</span>

    <span class="c1">// The same applies to single value entries, they are not</span>
    <span class="c1">// safe to use with user data in any form</span>
    <span class="nv">$userData</span><span class="p">,</span>
    <span class="s2">&quot;MATCH (comment) AGAINST (</span><span class="si">$userData</span><span class="s2">)&quot;</span><span class="p">,</span>
    <span class="s1">&#39;created &lt; NOW() - &#39;</span> <span class="o">.</span> <span class="nv">$userData</span>
<span class="p">]);</span>
</pre></div>
</div>
<p>When using the expression builder, column names must not contain user data:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="nv">$query</span><span class="o">-&gt;</span><span class="na">where</span><span class="p">(</span><span class="k">function</span> <span class="p">(</span><span class="nv">$exp</span><span class="p">)</span> <span class="k">use</span> <span class="p">(</span><span class="nv">$userData</span><span class="p">,</span> <span class="nv">$values</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Column names in all expressions are not safe.</span>
    <span class="k">return</span> <span class="nv">$exp</span><span class="o">-&gt;</span><span class="na">in</span><span class="p">(</span><span class="nv">$userData</span><span class="p">,</span> <span class="nv">$values</span><span class="p">);</span>
<span class="p">});</span>
</pre></div>
</div>
<p>When building function expressions, function names should never contain user
data:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="c1">// Not safe.</span>
<span class="nv">$query</span><span class="o">-&gt;</span><span class="na">func</span><span class="p">()</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$userData</span><span class="p">}(</span><span class="nv">$arg1</span><span class="p">);</span>

<span class="c1">// Also not safe to use an array of</span>
<span class="c1">// user data in a function expression</span>
<span class="nv">$query</span><span class="o">-&gt;</span><span class="na">func</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">coalesce</span><span class="p">(</span><span class="nv">$userData</span><span class="p">);</span>
</pre></div>
</div>
<p>Raw expressions are never safe:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="nv">$expr</span> <span class="o">=</span> <span class="nv">$query</span><span class="o">-&gt;</span><span class="na">newExpr</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">add</span><span class="p">(</span><span class="nv">$userData</span><span class="p">);</span>
<span class="nv">$query</span><span class="o">-&gt;</span><span class="na">select</span><span class="p">([</span><span class="s1">&#39;two&#39;</span> <span class="o">=&gt;</span> <span class="nv">$expr</span><span class="p">]);</span>
</pre></div>
</div>
<div class="section" id="binding-values">
<h3>Binding values<a class="headerlink" href="#binding-values" title="Permalink to this headline">¶</a></h3>
<p>It is possible to protect against many unsafe situations by using bindings.
Similar to <a class="reference internal" href="database-basics.html#database-basics-binding-values"><span class="std std-ref">binding values to prepared statements</span></a>,
values can be bound to queries using the <code class="xref php php-meth docutils literal"><span class="pre">Cake\Database\Query::bind()</span></code>
method.</p>
<p>The following example would be a safe variant of the unsafe, SQL injection prone
example given above:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="nv">$query</span>
    <span class="o">-&gt;</span><span class="na">where</span><span class="p">([</span>
        <span class="s1">&#39;MATCH (comment) AGAINST (:userData)&#39;</span><span class="p">,</span>
        <span class="s1">&#39;created &lt; NOW() - :moreUserData&#39;</span>
    <span class="p">])</span>
    <span class="o">-&gt;</span><span class="na">bind</span><span class="p">(</span><span class="s1">&#39;:userData&#39;</span><span class="p">,</span> <span class="nv">$userData</span><span class="p">,</span> <span class="s1">&#39;string&#39;</span><span class="p">)</span>
    <span class="o">-&gt;</span><span class="na">bind</span><span class="p">(</span><span class="s1">&#39;:moreUserData&#39;</span><span class="p">,</span> <span class="nv">$moreUserData</span><span class="p">,</span> <span class="s1">&#39;datetime&#39;</span><span class="p">);</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Unlike <code class="xref php php-meth docutils literal"><span class="pre">Cake\Database\StatementInterface::bindValue()</span></code>,
<code class="docutils literal"><span class="pre">Query::bind()</span></code> requires to pass the named placeholders including the
colon!</p>
</div>
</div>
</div>
<div class="section" id="more-complex-queries">
<h2>More Complex Queries<a class="headerlink" href="#more-complex-queries" title="Permalink to this headline">¶</a></h2>
<p>The query builder is capable of building complex queries like <code class="docutils literal"><span class="pre">UNION</span></code> queries
and sub-queries.</p>
<div class="section" id="unions">
<h3>Unions<a class="headerlink" href="#unions" title="Permalink to this headline">¶</a></h3>
<p>Unions are created by composing one or more select queries together:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="nv">$inReview</span> <span class="o">=</span> <span class="nv">$articles</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">()</span>
    <span class="o">-&gt;</span><span class="na">where</span><span class="p">([</span><span class="s1">&#39;need_review&#39;</span> <span class="o">=&gt;</span> <span class="k">true</span><span class="p">]);</span>

<span class="nv">$unpublished</span> <span class="o">=</span> <span class="nv">$articles</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">()</span>
    <span class="o">-&gt;</span><span class="na">where</span><span class="p">([</span><span class="s1">&#39;published&#39;</span> <span class="o">=&gt;</span> <span class="k">false</span><span class="p">]);</span>

<span class="nv">$unpublished</span><span class="o">-&gt;</span><span class="na">union</span><span class="p">(</span><span class="nv">$inReview</span><span class="p">);</span>
</pre></div>
</div>
<p>You can create <code class="docutils literal"><span class="pre">UNION</span> <span class="pre">ALL</span></code> queries using the <code class="docutils literal"><span class="pre">unionAll()</span></code> method:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="nv">$inReview</span> <span class="o">=</span> <span class="nv">$articles</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">()</span>
    <span class="o">-&gt;</span><span class="na">where</span><span class="p">([</span><span class="s1">&#39;need_review&#39;</span> <span class="o">=&gt;</span> <span class="k">true</span><span class="p">]);</span>

<span class="nv">$unpublished</span> <span class="o">=</span> <span class="nv">$articles</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">()</span>
    <span class="o">-&gt;</span><span class="na">where</span><span class="p">([</span><span class="s1">&#39;published&#39;</span> <span class="o">=&gt;</span> <span class="k">false</span><span class="p">]);</span>

<span class="nv">$unpublished</span><span class="o">-&gt;</span><span class="na">unionAll</span><span class="p">(</span><span class="nv">$inReview</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="section" id="subqueries">
<h3>Subqueries<a class="headerlink" href="#subqueries" title="Permalink to this headline">¶</a></h3>
<p>Subqueries are a powerful feature in relational databases and building them in
CakePHP is fairly intuitive. By composing queries together, you can make
subqueries:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="nv">$matchingComment</span> <span class="o">=</span> <span class="nv">$articles</span><span class="o">-&gt;</span><span class="na">association</span><span class="p">(</span><span class="s1">&#39;Comments&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">()</span>
    <span class="o">-&gt;</span><span class="na">select</span><span class="p">([</span><span class="s1">&#39;article_id&#39;</span><span class="p">])</span>
    <span class="o">-&gt;</span><span class="na">distinct</span><span class="p">()</span>
    <span class="o">-&gt;</span><span class="na">where</span><span class="p">([</span><span class="s1">&#39;comment LIKE&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;%CakePHP%&#39;</span><span class="p">]);</span>

<span class="nv">$query</span> <span class="o">=</span> <span class="nv">$articles</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">()</span>
    <span class="o">-&gt;</span><span class="na">where</span><span class="p">([</span><span class="s1">&#39;id&#39;</span> <span class="o">=&gt;</span> <span class="nv">$matchingComment</span><span class="p">]);</span>
</pre></div>
</div>
<p>Subqueries are accepted anywhere a query expression can be used. For example, in
the <code class="docutils literal"><span class="pre">select()</span></code> and <code class="docutils literal"><span class="pre">join()</span></code> methods.</p>
</div>
<div class="section" id="adding-locking-statements">
<h3>Adding Locking Statements<a class="headerlink" href="#adding-locking-statements" title="Permalink to this headline">¶</a></h3>
<p>Most relational database vendors support taking out locks when doing select
operations. You can use the <code class="docutils literal"><span class="pre">epilog()</span></code> method for this:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="c1">// In MySQL</span>
<span class="nv">$query</span><span class="o">-&gt;</span><span class="na">epilog</span><span class="p">(</span><span class="s1">&#39;FOR UPDATE&#39;</span><span class="p">);</span>
</pre></div>
</div>
<p>The <code class="docutils literal"><span class="pre">epilog()</span></code> method allows you to append raw SQL to the end of queries. You
should never put raw user data into <code class="docutils literal"><span class="pre">epilog()</span></code>.</p>
</div>
<div class="section" id="executing-complex-queries">
<h3>Executing Complex Queries<a class="headerlink" href="#executing-complex-queries" title="Permalink to this headline">¶</a></h3>
<p>While the query builder makes it easy to build most queries, very complex
queries can be tedious and complicated to build. You may want to <a class="reference internal" href="database-basics.html#running-select-statements"><span class="std std-ref">execute
the desired SQL directly</span></a>.</p>
<p>Executing SQL directly allows you to fine tune the query that will be run.
However, doing so doesn&#8217;t let you use <code class="docutils literal"><span class="pre">contain</span></code> or other higher level ORM
features.</p>
</div>
</div>
</div>


            </div>
        </div>

        
        <div class="col-md-3 col-md-pull-9 hidden-xs hidden-sm" lang="en">
            <aside class="sidebar">
                <div class="mb30 row">
<div id="sidebar-navigation" class="hidden-xs">
	<p class="caption"><span class="caption-text">Preface</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../intro.html">CakePHP at a Glance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../quickstart.html">Quick Start Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../appendices/3-x-migration-guide.html">3.x Migration Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials-and-examples.html">Tutorials &amp; Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../contributing.html">Contributing</a></li>
</ul>
<p class="caption"><span class="caption-text">Getting Started</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../development/configuration.html">Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../development/routing.html">Routing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../controllers/request-response.html">Request &amp; Response Objects</a></li>
<li class="toctree-l1"><a class="reference internal" href="../controllers/middleware.html">Middleware</a></li>
<li class="toctree-l1"><a class="reference internal" href="../controllers.html">Controllers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../views.html">Views</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../orm.html">Database Access &amp; ORM</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="database-basics.html">Database Basics</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Query Builder</a></li>
<li class="toctree-l2"><a class="reference internal" href="table-objects.html">Table Objects</a></li>
<li class="toctree-l2"><a class="reference internal" href="entities.html">Entities</a></li>
<li class="toctree-l2"><a class="reference internal" href="retrieving-data-and-resultsets.html">Retrieving Data &amp; Results Sets</a></li>
<li class="toctree-l2"><a class="reference internal" href="validation.html">Validating Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="saving-data.html">Saving Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="deleting-data.html">Deleting Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="associations.html">Associations - Linking Tables Together</a></li>
<li class="toctree-l2"><a class="reference internal" href="behaviors.html">Behaviors</a></li>
<li class="toctree-l2"><a class="reference internal" href="schema-system.html">Schema System</a></li>
<li class="toctree-l2"><a class="reference internal" href="../console-and-shells/orm-cache.html">ORM Cache Shell</a></li>
</ul>
</li>
</ul>
<p class="caption"><span class="caption-text">Using CakePHP</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../controllers/components/authentication.html">Authentication</a></li>
<li class="toctree-l1"><a class="reference internal" href="../bake.html">Bake Console</a></li>
<li class="toctree-l1"><a class="reference internal" href="../core-libraries/caching.html">Caching</a></li>
<li class="toctree-l1"><a class="reference internal" href="../console-and-shells.html">Console Tools, Shells &amp; Tasks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../development/debugging.html">Debugging</a></li>
<li class="toctree-l1"><a class="reference internal" href="../deployment.html">Deployment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../core-libraries/email.html">Email</a></li>
<li class="toctree-l1"><a class="reference internal" href="../development/errors.html">Error &amp; Exception Handling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../core-libraries/events.html">Events System</a></li>
<li class="toctree-l1"><a class="reference internal" href="../core-libraries/internationalization-and-localization.html">Internationalization &amp; Localization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../core-libraries/logging.html">Logging</a></li>
<li class="toctree-l1"><a class="reference internal" href="../core-libraries/form.html">Modelless Forms</a></li>
<li class="toctree-l1"><a class="reference internal" href="../controllers/components/pagination.html">Pagination</a></li>
<li class="toctree-l1"><a class="reference internal" href="../plugins.html">Plugins</a></li>
<li class="toctree-l1"><a class="reference internal" href="../development/rest.html">REST</a></li>
<li class="toctree-l1"><a class="reference internal" href="../security.html">Security</a></li>
<li class="toctree-l1"><a class="reference internal" href="../development/sessions.html">Sessions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../development/testing.html">Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../core-libraries/validation.html">Validation</a></li>
</ul>
<p class="caption"><span class="caption-text">Utility Classes</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../core-libraries/app.html">App Class</a></li>
<li class="toctree-l1"><a class="reference internal" href="../core-libraries/collections.html">Collections</a></li>
<li class="toctree-l1"><a class="reference internal" href="../core-libraries/file-folder.html">Folder &amp; File</a></li>
<li class="toctree-l1"><a class="reference internal" href="../core-libraries/hash.html">Hash</a></li>
<li class="toctree-l1"><a class="reference internal" href="../core-libraries/httpclient.html">Http Client</a></li>
<li class="toctree-l1"><a class="reference internal" href="../core-libraries/inflector.html">Inflector</a></li>
<li class="toctree-l1"><a class="reference internal" href="../core-libraries/number.html">Number</a></li>
<li class="toctree-l1"><a class="reference internal" href="../core-libraries/registry-objects.html">Registry Objects</a></li>
<li class="toctree-l1"><a class="reference internal" href="../core-libraries/text.html">Text</a></li>
<li class="toctree-l1"><a class="reference internal" href="../core-libraries/time.html">Date &amp; Time</a></li>
<li class="toctree-l1"><a class="reference internal" href="../core-libraries/xml.html">Xml</a></li>
</ul>
<p class="caption"><span class="caption-text">Plugins</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../chronos.html">Chronos</a></li>
<li class="toctree-l1"><a class="reference internal" href="../debug-kit.html">Debug Kit</a></li>
<li class="toctree-l1"><a class="reference internal" href="../migrations.html">Migrations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../elasticsearch.html">ElasticSearch</a></li>
<li class="toctree-l1"><a class="reference internal" href="../upgrade-tool.html">Upgrade Tool</a></li>
</ul>
<p class="caption"><span class="caption-text">Other</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../core-libraries/global-constants-and-functions.html">Constants &amp; Functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../appendices.html">Appendices</a></li>
</ul>

</div>

                </div>
            </aside>
            <aside class="sidebar">
                <div class="mb30 row">
                </div>
            </aside>
        </div>
    </div>
</div>

<section id="socials" class="back-3">
    <div class="container-fluid">
        <div class="row">
            <div class="col-xs-12 col-sm-12 col-md-5  social text-center">
                <div class="col-sm-3 col-xs-3">
                    <div id="fb-root"></div>
                        <script>(function(d, s, id) {
                          var js, fjs = d.getElementsByTagName(s)[0];
                          if (d.getElementById(id)) return;
                          js = d.createElement(s); js.id = id;
                          js.src = "//connect.facebook.net/en_US/sdk.js#xfbml=1&version=v2.5";
                          fjs.parentNode.insertBefore(js, fjs);
                        }(document, 'script', 'facebook-jssdk'));
                        </script>
                        <div id="fb-root-face" class="fb-like" data-href="https://www.facebook.com/CakePHP/" data-layout="button_count" data-action="like" data-show-faces="true" data-share="false"></div>
                </div>

                <div class="col-sm-3 col-xs-3">
                    <iframe src="https://ghbtns.com/github-btn.html?user=cakephp&amp;repo=cakephp&amp;type=star&amp;count=true&amp;size=small" frameborder="0" scrolling="0" width="120px" height="30px"></iframe>
                </div>

                <div class="col-sm-3 col-xs-3">
                    <iframe src="https://ghbtns.com/github-btn.html?user=cakephp&amp;repo=cakephp&amp;type=fork&amp;count=true&amp;size=small" frameborder="0" scrolling="0" width="120px" height="30px"></iframe>
                </div>

                <div class="col-sm-3 col-xs-3">
                    <a href="https://twitter.com/CakePHP" class="twitter-follow-button" data-show-count="false" data-show-screen-name="false">Follow @CakePHP</a>
                    <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
                </div>
            </div>

            <div class="col-xs-12 col-sm-12 col-md-7 social-footer text-center ">
                <a href="https://twitter.com/cakephp" data-toggle="tooltip" title="Twitter"><i class="fa icon-social fa-twitter"></i>
                <a href="https://www.facebook.com/groups/cake.community" data-toggle="tooltip" title="Facebook"><i class="fa icon-social fa-facebook"></i></a>
                <a href="https://goo.gl/mSC0s" data-toggle="tooltip" title="Google Plus"><i class="fa icon-social  fa-google-plus"></i></a>
                <a href="https://www.youtube.com/user/CakePHP" data-toggle="tooltip" title="Youtube"><i class="fa icon-social fa-youtube-play"></i></a>
                <a href="https://github.com/cakephp" data-toggle="tooltip" title="Github"><i class="fa icon-social fa-git"></i></a>
                <a href="https://cakesf.herokuapp.com/" target="_blank" title="Slack" data-toggle="tooltip"><i class="fa fa-slack icon-social"></i></a>
                <a href="https://stackoverflow.com/tags/cakephp" data-toggle="tooltip" title="Stack Overflow"><i class="fa icon-social fa-stack-overflow"></i></a>
                <a href="https://webchat.freenode.net/?channels=cakephp" data-toggle="tooltip" title="IRC" class="icon-irc">#IRC</a>
            </div>
        </div>
    </div>
</section>

<footer id="footer" class="footer-wrapper">
    <div class="container">

        <div class="row col-p30">
            <div class="col-sm-12 col-md-3">
                <div class="footer-widget t-footer">
                    <div class="col-md-12">
                        <a href="https://www.openhub.net/p/cakephp">
                            <img src="../_static/open-hub.png">
                        </a>
                        <div class="mt10">
                            <a href="https://www.rackspace.com/">
                                <img src="../_static/rackspace.png">
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-sm-12 col-md-9">
                <div class="col-md-3 col-sm-6 business-solution">
                    <ul class="footer-menu">
                        <li class="menu-title">
    <a href="https://cakephp.org/business-solutions"><i class="fa fa-menu-title fa-briefcase"></i>Business Solutions</a>
</li>
<li class="menu-title mt30">
    <a href="https://cakephp.org/showcase"><i class="fa fa-menu-title fa-desktop"></i>Showcase</a>
</li>
                    </ul>
                </div>

                <div class="col-md-3 col-sm-6">
                    <ul class="footer-menu">
                        
<li class="menu-title">
	<i class="fa fa-menu-title fa-book"></i>Documentation
</li>

<li><a href="https://book.cakephp.org"><i class="fa fa-menu fa-chevron-right"></i>Book</a></li>
<li><a href="https://api.cakephp.org"><i class="fa fa-menu fa-chevron-right"></i>API</a></li>

<li><a href="https://cakephp.org/documentation/videos"><i class="fa fa-menu fa-chevron-right"></i>Videos</a></li>
<li><a href="https://cakephp.org/privacy"><i class="fa fa-menu fa-chevron-right"></i>Privacy Policy</a></li>
<li><a href="https://cakephp.org/pages/trademark"><i class="fa fa-menu fa-chevron-right"></i>Logos &amp; Trademarks</a></li>
                    </ul>
                </div>

                <div class="col-md-3 col-sm-6">
                    <ul class="footer-menu">
                        
<li class="menu-title"><i class="fa fa-menu-title fa-users"></i>Community</li>

<li><a href="https://cakephp.org/team"><i class="fa fa-menu fa-chevron-right"></i>Team</a></li>
<li><a href="https://github.com/cakephp/cakephp/issues"><i class="fa fa-menu fa-chevron-right"></i>Issues (Github)</a></li>
<li><a href="https://www.youtube.com/user/CakePHP"><i class="fa fa-menu fa-chevron-right"></i>YouTube Channel</a></li>
<li><a href="https://cakephp.org/get-involved"><i class="fa fa-menu fa-chevron-right"></i>Get Involved</a></li>

<li><a href="https://bakery.cakephp.org"><i class="fa fa-menu fa-chevron-right"></i>Bakery</a></li>
<li><a href="https://github.com/FriendsOfCake/awesome-cakephp"><i class="fa fa-menu fa-chevron-right"></i>Featured Resources</a></li>
<li><a href="https://cakephp.org/newsletter/signup"><i class="fa fa-menu fa-chevron-right"></i>Newsletter</a></li>
<li><a href="http://certification.cakephp.org"><i class="fa fa-menu fa-chevron-right"></i>Certification</a></li>
<li><a href="http://my.cakephp.org"><i class="fa fa-menu fa-chevron-right"></i>My CakePHP</a></li>
<li><a href="http://cakefest.org"><i class="fa fa-menu fa-chevron-right"></i>CakeFest</a></li>
<li><a href="https://www.facebook.com/groups/cake.community"><i class="fa fa-menu fa-chevron-right"></i>Facebook</a></li>
<li><a href="https://twitter.com/cakephp"><i class="fa fa-menu fa-chevron-right"></i>Twitter</a></li>
                    </ul>
                </div>

                <div class="col-md-3 col-sm-6">
                    <ul class="footer-menu">
                        
<li class="menu-title"><i class="fa fa-menu-title fa-comments-o"></i>Help &amp; Support</li>

<li><a href="http://discourse.cakephp.org"><i class="fa fa-menu fa-chevron-right"></i>Forum</a></li>
<li><a href="https://stackoverflow.com/tags/cakephp"><i class="fa fa-menu fa-chevron-right"></i>Stack Overflow</a></li>
<li><a href="https://webchat.freenode.net/?channels=cakephp"><i class="fa fa-menu fa-chevron-right"></i>IRC</a></li>
<li><a href="https://cakesf.herokuapp.com/"><i class="fa fa-menu fa-chevron-right"></i>Slack</a></li>
<li><a href="https://www.cakedc.com/"><i class="fa fa-menu fa-chevron-right"></i>Paid Support</a></li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-12 text-center mt30">
                <p class="copyright">
                            &copy; Copyright 2017, Cake Software Foundation, Inc.
                        Last updated on Aug 30, 2017.
                        Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.4.5.
                </p>
            </div>
        </div>
    </div>
</footer>

<div id="inline-search-results"></div>


</div>

<script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-743287-3']);
    _gaq.push(['_trackPageview']);
    (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
</script>
  </body>
</html>