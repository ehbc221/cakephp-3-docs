

<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>CMS Tutorial - Tags and Users - 3.x</title>
    <link href="../../_static/favicon.png" type="image/png" rel="icon" />

    
    <link rel="stylesheet" href="../../_static/css/app.css" type="text/css" />
    
    <script type="text/javascript" src="../../_static/app.js"></script>

    <link rel="alternate" hreflang="fr" href="../../../fr/tutorials-and-examples/cms/tags-and-users.html" />

    <link rel="search" type="application/opensearchdescription+xml" title="Search within CakePHP Cookbook 3.5 documentation" href="../../_static/opensearchdescription-book-3-x.xml">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="top" title="CakePHP Cookbook 3.5 documentation" href="../../index.html" />
    <link rel="up" title="Tutorials &amp; Examples" href="../../tutorials-and-examples.html" />
    <link rel="next" title="CMS Tutorial - Authentication" href="authentication.html" />
    <link rel="prev" title="CMS Tutorial - Creating the Articles Controller" href="articles-controller.html" />

    <script type="text/javascript">
    window.lang = "en";
    </script>
  </head>
  <body>

<div id="container">
    
    <header class="nav-down">
        <div class="container-fluid hidden-xs hidden-sm">
            <div class="row">
                <div class="col-sm-3 col-md-3">
                    <a class="logo-cake" href="https://cakephp.org">
                        <img src="../../_static/logo-cake.png" alt="CakePHP" />
                    </a>
                </div>

                <div class="col-sm-9 col-md-9">
                    <nav class="navbar-right">
                        <ul class="menu">
                            <li class="first">
                                <a href="#"><i class="fa fa-menu fa-chevron-down"></i>Documentation</a>
                                <ul class="submenu">
                                    
<li><a href="https://book.cakephp.org"><i class="fa fa-menu fa-chevron-right"></i>Book</a></li>
<li><a href="https://api.cakephp.org"><i class="fa fa-menu fa-chevron-right"></i>API</a></li>

<li><a href="https://cakephp.org/documentation/videos"><i class="fa fa-menu fa-chevron-right"></i>Videos</a></li>
<li><a href="https://cakephp.org/privacy"><i class="fa fa-menu fa-chevron-right"></i>Privacy Policy</a></li>
<li><a href="https://cakephp.org/pages/trademark"><i class="fa fa-menu fa-chevron-right"></i>Logos &amp; Trademarks</a></li>
                                </ul>
                            </li>

                            <li><a href="https://cakephp.org/business-solutions">Business Solutions</a></li>
                            <li><a href="https://cakephp.org/writers">Get Paid To Write</a></li>
                            <li><a href="https://cakephp.org/pages/team">Team</a></li>

                            <li>
                                <a href="#"><i class="fa fa-menu fa-chevron-down"></i>Community</a>
                                <div class="megamenu full">
                                    <div class="row">
                                        <div class="col-6 pl30">
                                            <ul class="megamenu-list">
                                                
<li class="menu-title"><i class="fa fa-menu-title fa-users"></i>Community</li>

<li><a href="https://cakephp.org/team"><i class="fa fa-menu fa-chevron-right"></i>Team</a></li>
<li><a href="https://github.com/cakephp/cakephp/issues"><i class="fa fa-menu fa-chevron-right"></i>Issues (Github)</a></li>
<li><a href="https://www.youtube.com/user/CakePHP"><i class="fa fa-menu fa-chevron-right"></i>YouTube Channel</a></li>
<li><a href="https://cakephp.org/get-involved"><i class="fa fa-menu fa-chevron-right"></i>Get Involved</a></li>

<li><a href="https://bakery.cakephp.org"><i class="fa fa-menu fa-chevron-right"></i>Bakery</a></li>
<li><a href="https://github.com/FriendsOfCake/awesome-cakephp"><i class="fa fa-menu fa-chevron-right"></i>Featured Resources</a></li>
<li><a href="https://cakephp.org/newsletter/signup"><i class="fa fa-menu fa-chevron-right"></i>Newsletter</a></li>
<li><a href="http://certification.cakephp.org"><i class="fa fa-menu fa-chevron-right"></i>Certification</a></li>
<li><a href="http://my.cakephp.org"><i class="fa fa-menu fa-chevron-right"></i>My CakePHP</a></li>
<li><a href="http://cakefest.org"><i class="fa fa-menu fa-chevron-right"></i>CakeFest</a></li>
<li><a href="https://www.facebook.com/groups/cake.community"><i class="fa fa-menu fa-chevron-right"></i>Facebook</a></li>
<li><a href="https://twitter.com/cakephp"><i class="fa fa-menu fa-chevron-right"></i>Twitter</a></li>
                                            </ul>
                                        </div>
                                        <div class="col-6 pl30">
                                            <ul class="megamenu-list">
                                                
<li class="menu-title"><i class="fa fa-menu-title fa-comments-o"></i>Help &amp; Support</li>

<li><a href="http://discourse.cakephp.org"><i class="fa fa-menu fa-chevron-right"></i>Forum</a></li>
<li><a href="https://stackoverflow.com/tags/cakephp"><i class="fa fa-menu fa-chevron-right"></i>Stack Overflow</a></li>
<li><a href="https://webchat.freenode.net/?channels=cakephp"><i class="fa fa-menu fa-chevron-right"></i>IRC</a></li>
<li><a href="https://cakesf.herokuapp.com/"><i class="fa fa-menu fa-chevron-right"></i>Slack</a></li>
<li><a href="https://www.cakedc.com/"><i class="fa fa-menu fa-chevron-right"></i>Paid Support</a></li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </li>
                        </ul>
                    </nav>
                </div>
            </div>
        </div>

        
        <div class="container-fluid hidden-md hidden-lg">
            <div class="row">
                <div class="col-sm-6 col-xs-6">
                    <a class="logo-cake" href="https://cakephp.org">
                        <img src="../../_static/logo-cake.png" alt="CakePHP" />
                    </a>
                </div>

                <div class="col-sm-6 col-xs-6">
                    <div class="navbar-right">
                        <button id="btn-menu" class="btn-menu" data-toggle="modal" data-target="#modal">
                            <i class="fa fa-bars toggle-modal"></i>
                        </button>
                    </div>
                    <div id="wrap">
                        <form class="search" action="../../search.html" method="get">
                            <input name="q" type="search" placeholder="What are you looking for?">
                            <input id="search_submit" value="Search" type="submit">
                        </form>
                    </div>
                </div>
            </div>
        </div>

        
        <section id="nav-cook" class="hidden-xs hidden-sm">
            <div class="container-fluid ">
                <div class="row ">
                    <div class="col-md-12 back-book">
                        <div class="col-md-5 text-center t-cook-nav p0 hidden-sm hidden-xs">
                            <h2>
                                <a href="../../contents.html">
                                    <span class="glyph_range icon-submenu icon-submenu-cook">B</span>
                                    CakePHP 3.5 Red Velvet <strong>Cookbook</strong>
                                </a>
                            </h2>
                        </div>

                        <div class="col-md-4 hidden-sm">
                            <form class="search" action="../../search.html" method="get">
                                <input type="hidden" name="check_keywords" value="yes" />
                                <input type="hidden" name="area" value="default" />

                                <div class="col-md-10 p0">
                                    <input class="form-control form-cook" autocomplete="off" type="search" name="q" size="18" placeholder='Cookbook Search' />
                                </div>
                                <div class="col-md-2 p0 search-cook">
                                    <button type="submit">
                                        <span class="glyph_range icon-submenu icon-submenu-cook">A</span>
                                    </button>
                                </div>
                            </form>
                        </div>

                        
                        <div class="col-md-3">
                            <div class="col-md-6 p0">
                                <div class="col-md-7 t-language p0">
                                    <h6>Language:</h6>
                                </div>
                                <div class="col-md-5 p0">
                                    <ul class="nav navbar-nav">
                                        <li class="dropdown">
                                            <a class="dropdown-toggle" data-hover="dropdown" data-toggle="dropdown"
                                                    role="button" aria-haspopup="true" aria-expanded="false" href="#">
                                                        en
                                                        <i class="fa fa-menu-en fa-chevron-down"></i>
                                                    </a>
                                            <ul class="dropdown-menu">
                                            
                                                <li></li>
                                            
                                                <li><span class="disabled">pt</span></li>
                                            
                                                <li><span class="disabled">es</span></li>
                                            
                                                <li><span class="disabled">ja</span></li>
                                            
                                                <li><a href="../../../fr/tutorials-and-examples/cms/tags-and-users.html">fr</a></li>
                                            
                                                <li><span class="disabled">zh</span></li>
                                            
                                                <li><span class="disabled">tr</span></li>
                                            
                                                <li><span class="disabled">ru</span></li>
                                            
                                            </ul>
                                        </li>
                                    </ul>
                                </div>
                            </div>

                            <div class="col-md-6 p0">
                                <div class="col-md-7 t-language p0">
                                    <h6>Version:</h6>
                                </div>
                                <div class="col-md-5 p0">
                                    <ul class="nav navbar-nav">
                                        <li class="dropdown">
                                            <a href="#" class="dropdown-toggle" data-hover="dropdown" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">3.x <i class="fa fa-menu-en fa-chevron-down"></i></a>
                                            <ul class="dropdown-menu">
                                                <li><a href="https://book.cakephp.org/3.0/en">3.x Book</a></li>
                                                <li><a href="https://book.cakephp.org/2.0/en">2.x Book</a></li>
                                                <li><a href="https://book.cakephp.org/1.3/en/">1.3 Book</a></li>
                                                <li><a href="https://book.cakephp.org/1.2/en/">1.2 Book</a></li>
                                                <li><a href="https://book.cakephp.org/1.1/en">1.1 Book</a></li>
                                            </ul>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
            
        </section>
    </header>

    
    <section class="nav-btn visible-sm visible-xs">
        <div class="container">
            <div class="row">
                <div class="col-sm-6 col-xs-6 text-center">
                    <button id="btn-nav" class="btn btn-b btn-nav" data-toggle="modal" data-target="#modal"><strong>Nav</strong></button>
                </div>

                <div class="col-sm-6 col-xs-6 text-center">
                    <button id="btn-toc" class="btn btn-b btn-nav" data-toggle="modal" data-target="#modal"><strong>Table of Contents</strong></button>
                </div>
            </div>
        </div>
    </section>

    
    <div id="modal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="modal-header">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                    <h4 class="modal-title-cookbook" id="modal-header"></h4>
                </div>
                <div class="modal-body"></div>
            </div>
        </div>
    </div>

<div class="container page-container "><div id="improve-slideout">
        <i class="fa fa-pencil icon-improve"></i>
        <a href="https://github.com/cakephp/docs/edit/3.0/en/tutorials-and-examples/cms/tags-and-users.rst" target="_blank">
            <div id="improve-slideout-inner"><h6>Improve This Doc <i class="fa fa-github git-improve"></i></h6></div>
        </a>
    </div><a id="back-to-contents" href="#page-contents"><i class="fa fa-arrow-circle-up icon-improve" title="Back to Contents"></i></a>

    
    <div class="row">
        <div class="col-sm-12 col-md-9 col-md-push-3"><div class="page-contents col-sm-5">
                <h3>Page Contents</h3>
                <ul>
<li><a class="reference internal" href="#">CMS Tutorial - Tags and Users</a><ul>
<li><a class="reference internal" href="#adding-password-hashing">Adding Password Hashing</a><ul>
<li><a class="reference internal" href="#adding-tagging-to-articles">Adding Tagging to Articles</a></li>
<li><a class="reference internal" href="#updating-articles-to-enable-tagging">Updating Articles to Enable Tagging</a></li>
<li><a class="reference internal" href="#finding-articles-by-tags">Finding Articles By Tags</a></li>
</ul>
</li>
<li><a class="reference internal" href="#creating-the-finder-method">Creating the Finder Method</a></li>
<li><a class="reference internal" href="#creating-the-view">Creating the View</a><ul>
<li><a class="reference internal" href="#improving-the-tagging-experience">Improving the Tagging Experience</a></li>
</ul>
</li>
<li><a class="reference internal" href="#adding-a-computed-field">Adding a Computed Field</a></li>
<li><a class="reference internal" href="#updating-the-views">Updating the Views</a></li>
<li><a class="reference internal" href="#persisting-the-tag-string">Persisting the Tag String</a></li>
</ul>
</li>
</ul>

            </div><div class="document-body">
            
  <div class="section" id="cms-tutorial-tags-and-users">
<h1>CMS Tutorial - Tags and Users<a class="headerlink" href="#cms-tutorial-tags-and-users" title="Permalink to this headline">¶</a></h1>
<p>With the basic article creation functionality built, we need to enable multiple
authors to work in our CMS. Previously, we built all the models, views and
controllers by hand. This time around we&#8217;re going to use
<a class="reference internal" href="../../bake.html"><span class="doc">Bake Console</span></a> to create our skeleton code. Bake is a powerful
code generation <abbr title="Command Line Interface">CLI</abbr> tool that leverages the
conventions CakePHP uses to create skeleton <abbr title="Create, Read, Update, Delete">CRUD</abbr> applications very efficiently. We&#8217;re going to use <code class="docutils literal"><span class="pre">bake</span></code> to build our
users code:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="nb">cd</span> /path/to/our/app

bin/cake bake model users
bin/cake bake controller users
bin/cake bake template users
</pre></div>
</div>
<p>These 3 commands will generate:</p>
<ul class="simple">
<li>The Table, Entity, Fixture files.</li>
<li>The Controller</li>
<li>The CRUD templates.</li>
<li>Test cases for each generated class.</li>
</ul>
<p>Bake will also use the CakePHP conventions to infer the associations, and
validation your models have.</p>
<div class="section" id="adding-password-hashing">
<h2>Adding Password Hashing<a class="headerlink" href="#adding-password-hashing" title="Permalink to this headline">¶</a></h2>
<p>If you were to create/update a user at this point in time, you might notice that
the passwords are stored in plain text. This is really bad from a security point
of view, so lets fix that.</p>
<p>This is also a good time to talk about the model layer in CakePHP. In CakePHP,
we separate the methods that operate on a collection of objects, and a single
object into different classes. Methods that operate on the collection of
entities are put in the <code class="docutils literal"><span class="pre">Table</span></code> class, while features belonging to a single
record are put on the <code class="docutils literal"><span class="pre">Entity</span></code> class.</p>
<p>For example, password hashing is done on the individual record, so we&#8217;ll
implement this behavior on the entity object. Because we want to hash the
password each time it is set, we&#8217;ll use a mutator/setter method. CakePHP will
call convention based setter methods any time a property is set in one of your
entities. Let&#8217;s add a setter for the password. In <strong>src/Model/Entity/User.php</strong>
add the following:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="nx">php</span>
<span class="k">namespace</span> <span class="nx">App\Model\Entity</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">Cake\Auth\DefaultPasswordHasher</span><span class="p">;</span> <span class="c1">// Add this line</span>
<span class="k">use</span> <span class="nx">Cake\ORM\Entity</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">User</span> <span class="k">extends</span> <span class="nx">Entity</span>
<span class="p">{</span>

    <span class="c1">// Code from bake.</span>

    <span class="c1">// Add this method</span>
    <span class="k">protected</span> <span class="k">function</span> <span class="nf">_setPassword</span><span class="p">(</span><span class="nv">$value</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">strlen</span><span class="p">(</span><span class="nv">$value</span><span class="p">))</span> <span class="p">{</span>
            <span class="nv">$hasher</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">DefaultPasswordHasher</span><span class="p">();</span>

            <span class="k">return</span> <span class="nv">$hasher</span><span class="o">-&gt;</span><span class="na">hash</span><span class="p">(</span><span class="nv">$value</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Now, point your browser to <strong>http://localhost:8765/users</strong> to see a list of users.
You can edit the default user that was created during
<a class="reference internal" href="installation.html"><span class="doc">Installation</span></a>. If you change that user&#8217;s password,
you should see a hashed password instead of the original value on the list or
view pages. CakePHP hashes passwords with <a class="reference external" href="http://codahale.com/how-to-safely-store-a-password/">bcrypt</a> by default. You can also
use SHA-1 or MD5 if you&#8217;re working with an existing database, but we recommend
bcrypt for all new applications.</p>
<div class="section" id="adding-tagging-to-articles">
<h3>Adding Tagging to Articles<a class="headerlink" href="#adding-tagging-to-articles" title="Permalink to this headline">¶</a></h3>
<p>With multiple users able to access our small <abbr>CMS</abbr> it would be nice to
have a way to categorize our content. We&#8217;ll use tags and tagging to allow users
to create free-form categories and labels for their content. Again, we&#8217;ll use
<code class="docutils literal"><span class="pre">bake</span></code> to quickly generate some skeleton code for our application:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="c1"># Generate all the code at once.</span>
bin/cake bake all tags
</pre></div>
</div>
<p>Once you have the scaffold code created, create a few sample tags by going to
<strong>http://localhost:8765/tags/add</strong>.</p>
<p>Now that we have a Tags table, we can create an association between Articles and
Tags. We can do so by adding the following to the <code class="docutils literal"><span class="pre">initialize</span></code> method on the
ArticlesTable:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="k">public</span> <span class="k">function</span> <span class="nf">initialize</span><span class="p">(</span><span class="k">array</span> <span class="nv">$config</span><span class="p">)</span>
<span class="p">{</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">addBehavior</span><span class="p">(</span><span class="s1">&#39;Timestamp&#39;</span><span class="p">);</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">belongsToMany</span><span class="p">(</span><span class="s1">&#39;Tags&#39;</span><span class="p">);</span> <span class="c1">// Add this line</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This association will work with this simple definition because we followed
CakePHP conventions when creating our tables. For more information, read
<a class="reference internal" href="../../orm/associations.html"><span class="doc">Associations - Linking Tables Together</span></a>.</p>
</div>
<div class="section" id="updating-articles-to-enable-tagging">
<h3>Updating Articles to Enable Tagging<a class="headerlink" href="#updating-articles-to-enable-tagging" title="Permalink to this headline">¶</a></h3>
<p>Now that our application has tags, we need to enable users to tag their
articles. First, update the <code class="docutils literal"><span class="pre">add</span></code> action to look like:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="nx">php</span>
<span class="c1">// in src/Controller/ArticlesController.php</span>

<span class="k">namespace</span> <span class="nx">App\Controller</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">App\Controller\AppController</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">ArticlesController</span> <span class="k">extends</span> <span class="nx">AppController</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">add</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$article</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">Articles</span><span class="o">-&gt;</span><span class="na">newEntity</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">request</span><span class="o">-&gt;</span><span class="na">is</span><span class="p">(</span><span class="s1">&#39;post&#39;</span><span class="p">))</span> <span class="p">{</span>
            <span class="nv">$article</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">Articles</span><span class="o">-&gt;</span><span class="na">patchEntity</span><span class="p">(</span><span class="nv">$article</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">request</span><span class="o">-&gt;</span><span class="na">getData</span><span class="p">());</span>
            <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">Articles</span><span class="o">-&gt;</span><span class="na">save</span><span class="p">(</span><span class="nv">$article</span><span class="p">))</span> <span class="p">{</span>
                <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">Flash</span><span class="o">-&gt;</span><span class="na">success</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">&#39;Your article has been saved.&#39;</span><span class="p">));</span>
                <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">redirect</span><span class="p">([</span><span class="s1">&#39;action&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;index&#39;</span><span class="p">]);</span>
            <span class="p">}</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">Flash</span><span class="o">-&gt;</span><span class="na">error</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">&#39;Unable to add your article.&#39;</span><span class="p">));</span>
        <span class="p">}</span>
        <span class="c1">// Get a list of tags.</span>
        <span class="nv">$tags</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">Articles</span><span class="o">-&gt;</span><span class="na">Tags</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">(</span><span class="s1">&#39;list&#39;</span><span class="p">);</span>

        <span class="c1">// Set tags to the view context</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">set</span><span class="p">(</span><span class="s1">&#39;tags&#39;</span><span class="p">,</span> <span class="nv">$tags</span><span class="p">);</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">set</span><span class="p">(</span><span class="s1">&#39;article&#39;</span><span class="p">,</span> <span class="nv">$article</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// Other actions</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The added lines load a list of tags as an associative array of <code class="docutils literal"><span class="pre">id</span> <span class="pre">=&gt;</span> <span class="pre">title</span></code>.
This format will let us create a new tag input in our template.
Add the following to the PHP block of controls in <strong>src/Template/Articles/add.ctp</strong>:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="k">echo</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">Form</span><span class="o">-&gt;</span><span class="na">control</span><span class="p">(</span><span class="s1">&#39;tags._ids&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;options&#39;</span> <span class="o">=&gt;</span> <span class="nv">$tags</span><span class="p">]);</span>
</pre></div>
</div>
<p>This will render a multiple select element that uses the <code class="docutils literal"><span class="pre">$tags</span></code> variable to
generate the select box options. You should now create a couple new articles
that have tags, as in the following section we&#8217;ll be adding the ability to find
articles by tags.</p>
<p>You should also update the <code class="docutils literal"><span class="pre">edit</span></code> method to allow adding or editing tags. The
edit method should now look like:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="k">public</span> <span class="k">function</span> <span class="nf">edit</span><span class="p">(</span><span class="nv">$slug</span><span class="p">)</span>
<span class="p">{</span>
    <span class="nv">$article</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">Articles</span>
        <span class="o">-&gt;</span><span class="na">findBySlug</span><span class="p">(</span><span class="nv">$slug</span><span class="p">)</span>
        <span class="o">-&gt;</span><span class="na">contain</span><span class="p">(</span><span class="s1">&#39;Tags&#39;</span><span class="p">)</span> <span class="c1">// load associated Tags</span>
        <span class="o">-&gt;</span><span class="na">firstOrFail</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">request</span><span class="o">-&gt;</span><span class="na">is</span><span class="p">([</span><span class="s1">&#39;post&#39;</span><span class="p">,</span> <span class="s1">&#39;put&#39;</span><span class="p">]))</span> <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">Articles</span><span class="o">-&gt;</span><span class="na">patchEntity</span><span class="p">(</span><span class="nv">$article</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">request</span><span class="o">-&gt;</span><span class="na">getData</span><span class="p">());</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">Articles</span><span class="o">-&gt;</span><span class="na">save</span><span class="p">(</span><span class="nv">$article</span><span class="p">))</span> <span class="p">{</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">Flash</span><span class="o">-&gt;</span><span class="na">success</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">&#39;Your article has been updated.&#39;</span><span class="p">));</span>
            <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">redirect</span><span class="p">([</span><span class="s1">&#39;action&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;index&#39;</span><span class="p">]);</span>
        <span class="p">}</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">Flash</span><span class="o">-&gt;</span><span class="na">error</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">&#39;Unable to update your article.&#39;</span><span class="p">));</span>
    <span class="p">}</span>

    <span class="c1">// Get a list of tags.</span>
    <span class="nv">$tags</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">Articles</span><span class="o">-&gt;</span><span class="na">Tags</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">(</span><span class="s1">&#39;list&#39;</span><span class="p">);</span>

    <span class="c1">// Set tags to the view context</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">set</span><span class="p">(</span><span class="s1">&#39;tags&#39;</span><span class="p">,</span> <span class="nv">$tags</span><span class="p">);</span>

    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">set</span><span class="p">(</span><span class="s1">&#39;article&#39;</span><span class="p">,</span> <span class="nv">$article</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Remember to add the new tags multiple select control we added to the <strong>add.ctp</strong>
template to the <strong>src/Template/Articles/edit.ctp</strong> template as well.</p>
</div>
<div class="section" id="finding-articles-by-tags">
<h3>Finding Articles By Tags<a class="headerlink" href="#finding-articles-by-tags" title="Permalink to this headline">¶</a></h3>
<p>Once users have categorized their content, they will want to find that content
by the tags they used. For this feature we&#8217;ll implement a route, controller
action, and finder method to search through articles by tag.</p>
<p>Ideally, we&#8217;d have a URL that looks like
<strong>http://localhost:8765/articles/tagged/funny/cat/gifs</strong>. This would let us
find all the articles that have the &#8216;funny&#8217;, &#8216;cat&#8217; or &#8216;gifs&#8217; tags. Before we
can implement this, we&#8217;ll add a new route. Your <strong>config/routes.php</strong> should
look like:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="nx">php</span>
<span class="k">use</span> <span class="nx">Cake\Routing\Route\DashedRoute</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Cake\Routing\Router</span><span class="p">;</span>

<span class="nx">Router</span><span class="o">::</span><span class="na">defaultRouteClass</span><span class="p">(</span><span class="nx">DashedRoute</span><span class="o">::</span><span class="na">class</span><span class="p">);</span>

<span class="c1">// New route we&#39;re adding for our tagged action.</span>
<span class="c1">// The trailing `*` tells CakePHP that this action has</span>
<span class="c1">// passed parameters.</span>
<span class="nx">Router</span><span class="o">::</span><span class="na">scope</span><span class="p">(</span>
    <span class="s1">&#39;/articles&#39;</span><span class="p">,</span>
    <span class="p">[</span><span class="s1">&#39;controller&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Articles&#39;</span><span class="p">],</span>
    <span class="k">function</span> <span class="p">(</span><span class="nv">$routes</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$routes</span><span class="o">-&gt;</span><span class="na">connect</span><span class="p">(</span><span class="s1">&#39;/tagged/*&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;action&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;tags&#39;</span><span class="p">]);</span>
    <span class="p">}</span>
<span class="p">);</span>

<span class="nx">Router</span><span class="o">::</span><span class="na">scope</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="k">function</span> <span class="p">(</span><span class="nv">$routes</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Connect the default home and /pages/* routes.</span>
    <span class="nv">$routes</span><span class="o">-&gt;</span><span class="na">connect</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="p">[</span>
        <span class="s1">&#39;controller&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Pages&#39;</span><span class="p">,</span>
        <span class="s1">&#39;action&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;display&#39;</span><span class="p">,</span> <span class="s1">&#39;home&#39;</span>
    <span class="p">]);</span>
    <span class="nv">$routes</span><span class="o">-&gt;</span><span class="na">connect</span><span class="p">(</span><span class="s1">&#39;/pages/*&#39;</span><span class="p">,</span> <span class="p">[</span>
        <span class="s1">&#39;controller&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Pages&#39;</span><span class="p">,</span>
        <span class="s1">&#39;action&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;display&#39;</span>
    <span class="p">]);</span>

    <span class="c1">// Connect the conventions based default routes.</span>
    <span class="nv">$routes</span><span class="o">-&gt;</span><span class="na">fallbacks</span><span class="p">();</span>
<span class="p">});</span>

<span class="nx">Plugin</span><span class="o">::</span><span class="na">routes</span><span class="p">();</span>
</pre></div>
</div>
<p>The above defines a new &#8216;route&#8217; which connects the <strong>/articles/tagged/</strong> path,
to <code class="docutils literal"><span class="pre">ArticlesController::tags()</span></code>. By defining routes, you can isolate how your
URLs look, from how they are implemented. If we were to visit
<strong>http://localhost:8765/articles/tagged</strong>, we would see a helpful error page
from CakePHP informing you that the controller action does not exist. Let&#8217;s
implement that missing method now. In <strong>src/Controller/ArticlesController.php</strong>
add the following:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="c1">// add this use statement right below the namespace declaration to import</span>
<span class="c1">// the Query class</span>
<span class="k">use</span> <span class="nx">Cake\ORM\Query</span><span class="p">;</span>

<span class="k">public</span> <span class="k">function</span> <span class="nf">tags</span><span class="p">()</span>
<span class="p">{</span>
    <span class="c1">// The &#39;pass&#39; key is provided by CakePHP and contains all</span>
    <span class="c1">// the passed URL path segments in the request.</span>
    <span class="nv">$tags</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">request</span><span class="o">-&gt;</span><span class="na">getParam</span><span class="p">(</span><span class="s1">&#39;pass&#39;</span><span class="p">);</span>

    <span class="c1">// Use the ArticlesTable to find tagged articles.</span>
    <span class="nv">$articles</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">Articles</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">(</span><span class="s1">&#39;tagged&#39;</span><span class="p">,</span> <span class="p">[</span>
        <span class="s1">&#39;tags&#39;</span> <span class="o">=&gt;</span> <span class="nv">$tags</span>
    <span class="p">]);</span>

    <span class="c1">// Pass variables into the view template context.</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">set</span><span class="p">([</span>
        <span class="s1">&#39;articles&#39;</span> <span class="o">=&gt;</span> <span class="nv">$articles</span><span class="p">,</span>
        <span class="s1">&#39;tags&#39;</span> <span class="o">=&gt;</span> <span class="nv">$tags</span>
    <span class="p">]);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>To access other parts of the request data, consult the <a class="reference internal" href="../../controllers/request-response.html#cake-request"><span class="std std-ref">Request</span></a>
section.</p>
<p>Since passed arguments are passed as method parameters, you could also write the
action using PHP&#8217;s variadic argument:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="k">public</span> <span class="k">function</span> <span class="nf">tags</span><span class="p">(</span><span class="o">...</span><span class="nv">$tags</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// Use the ArticlesTable to find tagged articles.</span>
    <span class="nv">$articles</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">Articles</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">(</span><span class="s1">&#39;tagged&#39;</span><span class="p">,</span> <span class="p">[</span>
        <span class="s1">&#39;tags&#39;</span> <span class="o">=&gt;</span> <span class="nv">$tags</span>
    <span class="p">]);</span>

    <span class="c1">// Pass variables into the view template context.</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">set</span><span class="p">([</span>
        <span class="s1">&#39;articles&#39;</span> <span class="o">=&gt;</span> <span class="nv">$articles</span><span class="p">,</span>
        <span class="s1">&#39;tags&#39;</span> <span class="o">=&gt;</span> <span class="nv">$tags</span>
    <span class="p">]);</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="creating-the-finder-method">
<h2>Creating the Finder Method<a class="headerlink" href="#creating-the-finder-method" title="Permalink to this headline">¶</a></h2>
<p>In CakePHP we like to keep our controller actions slim, and put most of our
application&#8217;s logic in the model layer. If you were to visit the
<strong>/articles/tagged</strong> URL now you would see an error that the <code class="docutils literal"><span class="pre">findTagged()</span></code>
method has not been implemented yet, so let&#8217;s do that. In
<strong>src/Model/Table/ArticlesTable.php</strong> add the following:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="c1">// The $query argument is a query builder instance.</span>
<span class="c1">// The $options array will contain the &#39;tags&#39; option we passed</span>
<span class="c1">// to find(&#39;tagged&#39;) in our controller action.</span>
<span class="k">public</span> <span class="k">function</span> <span class="nf">findTagged</span><span class="p">(</span><span class="nx">Query</span> <span class="nv">$query</span><span class="p">,</span> <span class="k">array</span> <span class="nv">$options</span><span class="p">)</span>
<span class="p">{</span>
    <span class="nv">$columns</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;Articles.id&#39;</span><span class="p">,</span> <span class="s1">&#39;Articles.user_id&#39;</span><span class="p">,</span> <span class="s1">&#39;Articles.title&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Articles.body&#39;</span><span class="p">,</span> <span class="s1">&#39;Articles.published&#39;</span><span class="p">,</span> <span class="s1">&#39;Articles.created&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Articles.slug&#39;</span><span class="p">,</span>
    <span class="p">];</span>

    <span class="nv">$query</span> <span class="o">=</span> <span class="nv">$query</span>
        <span class="o">-&gt;</span><span class="na">select</span><span class="p">(</span><span class="nv">$columns</span><span class="p">)</span>
        <span class="o">-&gt;</span><span class="na">distinct</span><span class="p">(</span><span class="nv">$columns</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$options</span><span class="p">[</span><span class="s1">&#39;tags&#39;</span><span class="p">]))</span> <span class="p">{</span>
        <span class="c1">// If there are no tags provided, find articles that have no tags.</span>
        <span class="nv">$query</span><span class="o">-&gt;</span><span class="na">leftJoinWith</span><span class="p">(</span><span class="s1">&#39;Tags&#39;</span><span class="p">)</span>
            <span class="o">-&gt;</span><span class="na">where</span><span class="p">([</span><span class="s1">&#39;Tags.title IS&#39;</span> <span class="o">=&gt;</span> <span class="k">null</span><span class="p">]);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="c1">// Find articles that have one or more of the provided tags.</span>
        <span class="nv">$query</span><span class="o">-&gt;</span><span class="na">innerJoinWith</span><span class="p">(</span><span class="s1">&#39;Tags&#39;</span><span class="p">)</span>
            <span class="o">-&gt;</span><span class="na">where</span><span class="p">([</span><span class="s1">&#39;Tags.title IN&#39;</span> <span class="o">=&gt;</span> <span class="nv">$options</span><span class="p">[</span><span class="s1">&#39;tags&#39;</span><span class="p">]]);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nv">$query</span><span class="o">-&gt;</span><span class="na">group</span><span class="p">([</span><span class="s1">&#39;Articles.id&#39;</span><span class="p">]);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>We just implemented a <a class="reference internal" href="../../orm/retrieving-data-and-resultsets.html#custom-find-methods"><span class="std std-ref">custom finder method</span></a>. This is
a very powerful concept in CakePHP that allows you to package up re-usable
queries. Finder methods always get a <a class="reference internal" href="../../orm/query-builder.html"><span class="doc">Query Builder</span></a> object and an
array of options as parameters. Finders can manipulate the query and add any
required conditions or criteria. When complete, finder methods must return
a modified query object. In our finder we&#8217;ve leveraged the <code class="docutils literal"><span class="pre">distinct()</span></code> and
<code class="docutils literal"><span class="pre">leftJoin()</span></code> methods which allow us to find distinct articles that have
a &#8216;matching&#8217; tag.</p>
</div>
<div class="section" id="creating-the-view">
<h2>Creating the View<a class="headerlink" href="#creating-the-view" title="Permalink to this headline">¶</a></h2>
<p>Now if you visit the <strong>/articles/tagged</strong> URL again, CakePHP will show a new error
letting you know that you have not made a view file. Next, let&#8217;s build the
view file for our <code class="docutils literal"><span class="pre">tags()</span></code> action. In <strong>src/Template/Articles/tags.ctp</strong>
put the following content:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="nx">h1</span><span class="o">&gt;</span>
    <span class="nx">Articles</span> <span class="nx">tagged</span> <span class="nx">with</span>
    <span class="o">&lt;?=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">Text</span><span class="o">-&gt;</span><span class="na">toList</span><span class="p">(</span><span class="nx">h</span><span class="p">(</span><span class="nv">$tags</span><span class="p">),</span> <span class="s1">&#39;or&#39;</span><span class="p">)</span> <span class="cp">?&gt;</span><span class="x"></span>
<span class="x">&lt;/h1&gt;</span>

<span class="x">&lt;section&gt;</span>
<span class="cp">&lt;?php</span> <span class="k">foreach</span> <span class="p">(</span><span class="nv">$articles</span> <span class="k">as</span> <span class="nv">$article</span><span class="p">)</span><span class="o">:</span> <span class="cp">?&gt;</span><span class="x"></span>
<span class="x">    &lt;article&gt;</span>
<span class="x">        &lt;!-- Use the HtmlHelper to create a link --&gt;</span>
<span class="x">        &lt;h4&gt;</span><span class="cp">&lt;?</span><span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">Html</span><span class="o">-&gt;</span><span class="na">link</span><span class="p">(</span>
            <span class="nv">$article</span><span class="o">-&gt;</span><span class="na">title</span><span class="p">,</span>
            <span class="p">[</span><span class="s1">&#39;controller&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Articles&#39;</span><span class="p">,</span> <span class="s1">&#39;action&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;view&#39;</span><span class="p">,</span> <span class="nv">$article</span><span class="o">-&gt;</span><span class="na">slug</span><span class="p">]</span>
        <span class="p">)</span> <span class="cp">?&gt;</span><span class="x">&lt;/h4&gt;</span>
<span class="x">        &lt;span&gt;</span><span class="cp">&lt;?</span><span class="o">=</span> <span class="nx">h</span><span class="p">(</span><span class="nv">$article</span><span class="o">-&gt;</span><span class="na">created</span><span class="p">)</span> <span class="cp">?&gt;</span><span class="x"></span>
<span class="x">    &lt;/article&gt;</span>
<span class="cp">&lt;?php</span> <span class="k">endforeach</span><span class="p">;</span> <span class="cp">?&gt;</span><span class="x"></span>
<span class="x">&lt;/section&gt;</span>
</pre></div>
</div>
<p>In the above code we use the <a class="reference internal" href="../../views/helpers/html.html"><span class="doc">Html</span></a> and
<a class="reference internal" href="../../views/helpers/text.html"><span class="doc">Text</span></a> helpers to assist in generating our view output. We
also use the <a class="reference internal" href="../../core-libraries/global-constants-and-functions.html#h" title="h"><code class="xref php php-func docutils literal"><span class="pre">h</span></code></a> shortcut function to HTML encode output. You should
remember to always use <code class="docutils literal"><span class="pre">h()</span></code> when outputting data to prevent HTML injection
issues.</p>
<p>The <strong>tags.ctp</strong> file we just created follows the CakePHP conventions for view
template files. The convention is to have the template use the lower case and
underscored version of the controller action name.</p>
<p>You may notice that we were able to use the <code class="docutils literal"><span class="pre">$tags</span></code> and <code class="docutils literal"><span class="pre">$articles</span></code>
variables in our view template. When we use the <code class="docutils literal"><span class="pre">set()</span></code> method in our
controller, we set specific variables to be sent to the view. The View will make
all passed variables available in the template scope as local variables.</p>
<p>You should now be able to visit the <strong>/articles/tagged/funny</strong> URL and see all
the articles tagged with &#8216;funny&#8217;.</p>
<div class="section" id="improving-the-tagging-experience">
<h3>Improving the Tagging Experience<a class="headerlink" href="#improving-the-tagging-experience" title="Permalink to this headline">¶</a></h3>
<p>Right now, adding new tags is a cumbersome process, as authors need to
pre-create all the tags they want to use. We can improve the tag selection UI by
using a comma separated text field. This will let us give a better experience to
our users, and use some more great features in the ORM.</p>
</div>
</div>
<div class="section" id="adding-a-computed-field">
<h2>Adding a Computed Field<a class="headerlink" href="#adding-a-computed-field" title="Permalink to this headline">¶</a></h2>
<p>Because we&#8217;ll want a simple way to access the formatted tags for an entity, we
can add a virtual/computed field to the entity. In
<strong>src/Model/Entity/Article.php</strong> add the following:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="c1">// add this use statement right below the namespace declaration to import</span>
<span class="c1">// the Collection class</span>
<span class="k">use</span> <span class="nx">Cake\Collection\Collection</span><span class="p">;</span>

<span class="k">protected</span> <span class="k">function</span> <span class="nf">_getTagString</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_properties</span><span class="p">[</span><span class="s1">&#39;tag_string&#39;</span><span class="p">]))</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_properties</span><span class="p">[</span><span class="s1">&#39;tag_string&#39;</span><span class="p">];</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">tags</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nv">$tags</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Collection</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">tags</span><span class="p">);</span>
    <span class="nv">$str</span> <span class="o">=</span> <span class="nv">$tags</span><span class="o">-&gt;</span><span class="na">reduce</span><span class="p">(</span><span class="k">function</span> <span class="p">(</span><span class="nv">$string</span><span class="p">,</span> <span class="nv">$tag</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$string</span> <span class="o">.</span> <span class="nv">$tag</span><span class="o">-&gt;</span><span class="na">title</span> <span class="o">.</span> <span class="s1">&#39;, &#39;</span><span class="p">;</span>
    <span class="p">},</span> <span class="s1">&#39;&#39;</span><span class="p">);</span>
    <span class="k">return</span> <span class="nb">trim</span><span class="p">(</span><span class="nv">$str</span><span class="p">,</span> <span class="s1">&#39;, &#39;</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This will let us access the <code class="docutils literal"><span class="pre">$article-&gt;tag_string</span></code> computed property. We&#8217;ll
use this property in controls later on.</p>
</div>
<div class="section" id="updating-the-views">
<h2>Updating the Views<a class="headerlink" href="#updating-the-views" title="Permalink to this headline">¶</a></h2>
<p>With the entity updated we can add a new control for our tags. In
<strong>src/Template/Articles/add.ctp</strong> and <strong>src/Template/Articles/edit.ctp</strong>,
replace the existing <code class="docutils literal"><span class="pre">tags._ids</span></code> control with the following:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="k">echo</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">Form</span><span class="o">-&gt;</span><span class="na">control</span><span class="p">(</span><span class="s1">&#39;tag_string&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;type&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;text&#39;</span><span class="p">]);</span>
</pre></div>
</div>
</div>
<div class="section" id="persisting-the-tag-string">
<h2>Persisting the Tag String<a class="headerlink" href="#persisting-the-tag-string" title="Permalink to this headline">¶</a></h2>
<p>Now that we can view existing tags as a string, we&#8217;ll want to save that data as
well. Because we marked the <code class="docutils literal"><span class="pre">tag_string</span></code> as accessible, the ORM will copy that
data from the request into our entity. We can use a <code class="docutils literal"><span class="pre">beforeSave()</span></code> hook method
to parse the tag string and find/build the related entities. Add the following
to <strong>src/Model/Table/ArticlesTable.php</strong>:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="k">public</span> <span class="k">function</span> <span class="nf">beforeSave</span><span class="p">(</span><span class="nv">$event</span><span class="p">,</span> <span class="nv">$entity</span><span class="p">,</span> <span class="nv">$options</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$entity</span><span class="o">-&gt;</span><span class="na">tag_string</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$entity</span><span class="o">-&gt;</span><span class="na">tags</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_buildTags</span><span class="p">(</span><span class="nv">$entity</span><span class="o">-&gt;</span><span class="na">tag_string</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// Other code</span>
<span class="p">}</span>

<span class="k">protected</span> <span class="k">function</span> <span class="nf">_buildTags</span><span class="p">(</span><span class="nv">$tagString</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// Trim tags</span>
    <span class="nv">$newTags</span> <span class="o">=</span> <span class="nb">array_map</span><span class="p">(</span><span class="s1">&#39;trim&#39;</span><span class="p">,</span> <span class="nb">explode</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="nv">$tagString</span><span class="p">));</span>
    <span class="c1">// Remove all empty tags</span>
    <span class="nv">$newTags</span> <span class="o">=</span> <span class="nb">array_filter</span><span class="p">(</span><span class="nv">$newTags</span><span class="p">);</span>
    <span class="c1">// Reduce duplicated tags</span>
    <span class="nv">$newTags</span> <span class="o">=</span> <span class="nb">array_unique</span><span class="p">(</span><span class="nv">$newTags</span><span class="p">);</span>

    <span class="nv">$out</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="nv">$query</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">Tags</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">()</span>
        <span class="o">-&gt;</span><span class="na">where</span><span class="p">([</span><span class="s1">&#39;Tags.title IN&#39;</span> <span class="o">=&gt;</span> <span class="nv">$newTags</span><span class="p">]);</span>

    <span class="c1">// Remove existing tags from the list of new tags.</span>
    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$query</span><span class="o">-&gt;</span><span class="na">extract</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="nv">$existing</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$index</span> <span class="o">=</span> <span class="nb">array_search</span><span class="p">(</span><span class="nv">$existing</span><span class="p">,</span> <span class="nv">$newTags</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$index</span> <span class="o">!==</span> <span class="k">false</span><span class="p">)</span> <span class="p">{</span>
            <span class="nb">unset</span><span class="p">(</span><span class="nv">$newTags</span><span class="p">[</span><span class="nv">$index</span><span class="p">]);</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="c1">// Add existing tags.</span>
    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$query</span> <span class="k">as</span> <span class="nv">$tag</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$out</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$tag</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="c1">// Add new tags.</span>
    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$newTags</span> <span class="k">as</span> <span class="nv">$tag</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$out</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">Tags</span><span class="o">-&gt;</span><span class="na">newEntity</span><span class="p">([</span><span class="s1">&#39;title&#39;</span> <span class="o">=&gt;</span> <span class="nv">$tag</span><span class="p">]);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nv">$out</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>While this code is a bit more complicated than what we&#8217;ve done so far, it helps
to showcase how powerful the ORM in CakePHP is. You can manipulate query
results using the <a class="reference internal" href="../../core-libraries/collections.html"><span class="doc">Collections</span></a> methods, and handle
scenarios where you are creating entities on the fly with ease.</p>
<p>Next we&#8217;ll be adding <a class="reference internal" href="authentication.html"><span class="doc">authentication</span></a>.</p>
</div>
</div>


            </div>
        </div>

        
        <div class="col-md-3 col-md-pull-9 hidden-xs hidden-sm" lang="en">
            <aside class="sidebar">
                <div class="mb30 row">
<div id="sidebar-navigation" class="hidden-xs">
	<p class="caption"><span class="caption-text">Preface</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../intro.html">CakePHP at a Glance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../quickstart.html">Quick Start Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../appendices/3-x-migration-guide.html">3.x Migration Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorials-and-examples.html">Tutorials &amp; Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contributing.html">Contributing</a></li>
</ul>
<p class="caption"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../development/configuration.html">Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../development/routing.html">Routing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../controllers/request-response.html">Request &amp; Response Objects</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../controllers/middleware.html">Middleware</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../controllers.html">Controllers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../views.html">Views</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../orm.html">Database Access &amp; ORM</a></li>
</ul>
<p class="caption"><span class="caption-text">Using CakePHP</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../controllers/components/authentication.html">Authentication</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../bake.html">Bake Console</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../core-libraries/caching.html">Caching</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../console-and-shells.html">Console Tools, Shells &amp; Tasks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../development/debugging.html">Debugging</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../deployment.html">Deployment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../core-libraries/email.html">Email</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../development/errors.html">Error &amp; Exception Handling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../core-libraries/events.html">Events System</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../core-libraries/internationalization-and-localization.html">Internationalization &amp; Localization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../core-libraries/logging.html">Logging</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../core-libraries/form.html">Modelless Forms</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../controllers/components/pagination.html">Pagination</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../plugins.html">Plugins</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../development/rest.html">REST</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../security.html">Security</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../development/sessions.html">Sessions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../development/testing.html">Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../core-libraries/validation.html">Validation</a></li>
</ul>
<p class="caption"><span class="caption-text">Utility Classes</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../core-libraries/app.html">App Class</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../core-libraries/collections.html">Collections</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../core-libraries/file-folder.html">Folder &amp; File</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../core-libraries/hash.html">Hash</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../core-libraries/httpclient.html">Http Client</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../core-libraries/inflector.html">Inflector</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../core-libraries/number.html">Number</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../core-libraries/registry-objects.html">Registry Objects</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../core-libraries/text.html">Text</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../core-libraries/time.html">Date &amp; Time</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../core-libraries/xml.html">Xml</a></li>
</ul>
<p class="caption"><span class="caption-text">Plugins</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../chronos.html">Chronos</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../debug-kit.html">Debug Kit</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../migrations.html">Migrations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../elasticsearch.html">ElasticSearch</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../upgrade-tool.html">Upgrade Tool</a></li>
</ul>
<p class="caption"><span class="caption-text">Other</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../core-libraries/global-constants-and-functions.html">Constants &amp; Functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../appendices.html">Appendices</a></li>
</ul>

</div>

                </div>
            </aside>
            <aside class="sidebar">
                <div class="mb30 row">
                </div>
            </aside>
        </div>
    </div>
</div>

<section id="socials" class="back-3">
    <div class="container-fluid">
        <div class="row">
            <div class="col-xs-12 col-sm-12 col-md-5  social text-center">
                <div class="col-sm-3 col-xs-3">
                    <div id="fb-root"></div>
                        <script>(function(d, s, id) {
                          var js, fjs = d.getElementsByTagName(s)[0];
                          if (d.getElementById(id)) return;
                          js = d.createElement(s); js.id = id;
                          js.src = "//connect.facebook.net/en_US/sdk.js#xfbml=1&version=v2.5";
                          fjs.parentNode.insertBefore(js, fjs);
                        }(document, 'script', 'facebook-jssdk'));
                        </script>
                        <div id="fb-root-face" class="fb-like" data-href="https://www.facebook.com/CakePHP/" data-layout="button_count" data-action="like" data-show-faces="true" data-share="false"></div>
                </div>

                <div class="col-sm-3 col-xs-3">
                    <iframe src="https://ghbtns.com/github-btn.html?user=cakephp&amp;repo=cakephp&amp;type=star&amp;count=true&amp;size=small" frameborder="0" scrolling="0" width="120px" height="30px"></iframe>
                </div>

                <div class="col-sm-3 col-xs-3">
                    <iframe src="https://ghbtns.com/github-btn.html?user=cakephp&amp;repo=cakephp&amp;type=fork&amp;count=true&amp;size=small" frameborder="0" scrolling="0" width="120px" height="30px"></iframe>
                </div>

                <div class="col-sm-3 col-xs-3">
                    <a href="https://twitter.com/CakePHP" class="twitter-follow-button" data-show-count="false" data-show-screen-name="false">Follow @CakePHP</a>
                    <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
                </div>
            </div>

            <div class="col-xs-12 col-sm-12 col-md-7 social-footer text-center ">
                <a href="https://twitter.com/cakephp" data-toggle="tooltip" title="Twitter"><i class="fa icon-social fa-twitter"></i>
                <a href="https://www.facebook.com/groups/cake.community" data-toggle="tooltip" title="Facebook"><i class="fa icon-social fa-facebook"></i></a>
                <a href="https://goo.gl/mSC0s" data-toggle="tooltip" title="Google Plus"><i class="fa icon-social  fa-google-plus"></i></a>
                <a href="https://www.youtube.com/user/CakePHP" data-toggle="tooltip" title="Youtube"><i class="fa icon-social fa-youtube-play"></i></a>
                <a href="https://github.com/cakephp" data-toggle="tooltip" title="Github"><i class="fa icon-social fa-git"></i></a>
                <a href="https://cakesf.herokuapp.com/" target="_blank" title="Slack" data-toggle="tooltip"><i class="fa fa-slack icon-social"></i></a>
                <a href="https://stackoverflow.com/tags/cakephp" data-toggle="tooltip" title="Stack Overflow"><i class="fa icon-social fa-stack-overflow"></i></a>
                <a href="https://webchat.freenode.net/?channels=cakephp" data-toggle="tooltip" title="IRC" class="icon-irc">#IRC</a>
            </div>
        </div>
    </div>
</section>

<footer id="footer" class="footer-wrapper">
    <div class="container">

        <div class="row col-p30">
            <div class="col-sm-12 col-md-3">
                <div class="footer-widget t-footer">
                    <div class="col-md-12">
                        <a href="https://www.openhub.net/p/cakephp">
                            <img src="../../_static/open-hub.png">
                        </a>
                        <div class="mt10">
                            <a href="https://www.rackspace.com/">
                                <img src="../../_static/rackspace.png">
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-sm-12 col-md-9">
                <div class="col-md-3 col-sm-6 business-solution">
                    <ul class="footer-menu">
                        <li class="menu-title">
    <a href="https://cakephp.org/business-solutions"><i class="fa fa-menu-title fa-briefcase"></i>Business Solutions</a>
</li>
<li class="menu-title mt30">
    <a href="https://cakephp.org/showcase"><i class="fa fa-menu-title fa-desktop"></i>Showcase</a>
</li>
                    </ul>
                </div>

                <div class="col-md-3 col-sm-6">
                    <ul class="footer-menu">
                        
<li class="menu-title">
	<i class="fa fa-menu-title fa-book"></i>Documentation
</li>

<li><a href="https://book.cakephp.org"><i class="fa fa-menu fa-chevron-right"></i>Book</a></li>
<li><a href="https://api.cakephp.org"><i class="fa fa-menu fa-chevron-right"></i>API</a></li>

<li><a href="https://cakephp.org/documentation/videos"><i class="fa fa-menu fa-chevron-right"></i>Videos</a></li>
<li><a href="https://cakephp.org/privacy"><i class="fa fa-menu fa-chevron-right"></i>Privacy Policy</a></li>
<li><a href="https://cakephp.org/pages/trademark"><i class="fa fa-menu fa-chevron-right"></i>Logos &amp; Trademarks</a></li>
                    </ul>
                </div>

                <div class="col-md-3 col-sm-6">
                    <ul class="footer-menu">
                        
<li class="menu-title"><i class="fa fa-menu-title fa-users"></i>Community</li>

<li><a href="https://cakephp.org/team"><i class="fa fa-menu fa-chevron-right"></i>Team</a></li>
<li><a href="https://github.com/cakephp/cakephp/issues"><i class="fa fa-menu fa-chevron-right"></i>Issues (Github)</a></li>
<li><a href="https://www.youtube.com/user/CakePHP"><i class="fa fa-menu fa-chevron-right"></i>YouTube Channel</a></li>
<li><a href="https://cakephp.org/get-involved"><i class="fa fa-menu fa-chevron-right"></i>Get Involved</a></li>

<li><a href="https://bakery.cakephp.org"><i class="fa fa-menu fa-chevron-right"></i>Bakery</a></li>
<li><a href="https://github.com/FriendsOfCake/awesome-cakephp"><i class="fa fa-menu fa-chevron-right"></i>Featured Resources</a></li>
<li><a href="https://cakephp.org/newsletter/signup"><i class="fa fa-menu fa-chevron-right"></i>Newsletter</a></li>
<li><a href="http://certification.cakephp.org"><i class="fa fa-menu fa-chevron-right"></i>Certification</a></li>
<li><a href="http://my.cakephp.org"><i class="fa fa-menu fa-chevron-right"></i>My CakePHP</a></li>
<li><a href="http://cakefest.org"><i class="fa fa-menu fa-chevron-right"></i>CakeFest</a></li>
<li><a href="https://www.facebook.com/groups/cake.community"><i class="fa fa-menu fa-chevron-right"></i>Facebook</a></li>
<li><a href="https://twitter.com/cakephp"><i class="fa fa-menu fa-chevron-right"></i>Twitter</a></li>
                    </ul>
                </div>

                <div class="col-md-3 col-sm-6">
                    <ul class="footer-menu">
                        
<li class="menu-title"><i class="fa fa-menu-title fa-comments-o"></i>Help &amp; Support</li>

<li><a href="http://discourse.cakephp.org"><i class="fa fa-menu fa-chevron-right"></i>Forum</a></li>
<li><a href="https://stackoverflow.com/tags/cakephp"><i class="fa fa-menu fa-chevron-right"></i>Stack Overflow</a></li>
<li><a href="https://webchat.freenode.net/?channels=cakephp"><i class="fa fa-menu fa-chevron-right"></i>IRC</a></li>
<li><a href="https://cakesf.herokuapp.com/"><i class="fa fa-menu fa-chevron-right"></i>Slack</a></li>
<li><a href="https://www.cakedc.com/"><i class="fa fa-menu fa-chevron-right"></i>Paid Support</a></li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-12 text-center mt30">
                <p class="copyright">
                            &copy; Copyright 2017, Cake Software Foundation, Inc.
                        Last updated on Aug 30, 2017.
                        Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.4.5.
                </p>
            </div>
        </div>
    </div>
</footer>

<div id="inline-search-results"></div>


</div>

<script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-743287-3']);
    _gaq.push(['_trackPageview']);
    (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
</script>
  </body>
</html>