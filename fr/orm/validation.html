

<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Valider des Données - 3.x</title>
    <link href="../_static/favicon.png" type="image/png" rel="icon" />

    
    <link rel="stylesheet" href="../_static/css/app.css" type="text/css" />
    
    <script type="text/javascript" src="../_static/app.js"></script>

    <link rel="alternate" hreflang="en" href="../../en/orm/validation.html" /><link rel="alternate" hreflang="pt_BR" href="../../pt/orm/validation.html" /><link rel="alternate" hreflang="es" href="../../es/orm/validation.html" /><link rel="alternate" hreflang="ja" href="../../ja/orm/validation.html" /><link rel="alternate" hreflang="zh" href="../../zh/orm/validation.html" /><link rel="alternate" hreflang="tr" href="../../tr/orm/validation.html" /><link rel="alternate" hreflang="ru" href="../../ru/orm/validation.html" />

    <link rel="search" type="application/opensearchdescription+xml" title="Search within documentation CakePHP Cookbook 3.5" href="../_static/opensearchdescription-book-3-x.xml">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="top" title="documentation CakePHP Cookbook 3.5" href="../index.html" />
    <link rel="up" title="Accès Base de Données &amp; ORM" href="../orm.html" />
    <link rel="next" title="Sauvegarder les Données" href="saving-data.html" />
    <link rel="prev" title="Récupérer les Données et les Ensembles de Résultats" href="retrieving-data-and-resultsets.html" />

    <script type="text/javascript">
    window.lang = "fr";
    </script>
  </head>
  <body>

<div id="container">
    
    <header class="nav-down">
        <div class="container-fluid hidden-xs hidden-sm">
            <div class="row">
                <div class="col-sm-3 col-md-3">
                    <a class="logo-cake" href="https://cakephp.org">
                        <img src="../_static/logo-cake.png" alt="CakePHP" />
                    </a>
                </div>

                <div class="col-sm-9 col-md-9">
                    <nav class="navbar-right">
                        <ul class="menu">
                            <li class="first">
                                <a href="#"><i class="fa fa-menu fa-chevron-down"></i>Documentation</a>
                                <ul class="submenu">
                                    
<li><a href="https://book.cakephp.org"><i class="fa fa-menu fa-chevron-right"></i>Book</a></li>
<li><a href="https://api.cakephp.org"><i class="fa fa-menu fa-chevron-right"></i>API</a></li>

<li><a href="https://cakephp.org/documentation/videos"><i class="fa fa-menu fa-chevron-right"></i>Videos</a></li>
<li><a href="https://cakephp.org/privacy"><i class="fa fa-menu fa-chevron-right"></i>Privacy Policy</a></li>
<li><a href="https://cakephp.org/pages/trademark"><i class="fa fa-menu fa-chevron-right"></i>Logos &amp; Trademarks</a></li>
                                </ul>
                            </li>

                            <li><a href="https://cakephp.org/business-solutions">Business Solutions</a></li>
                            <li><a href="https://cakephp.org/writers">Get Paid To Write</a></li>
                            <li><a href="https://cakephp.org/pages/team">Team</a></li>

                            <li>
                                <a href="#"><i class="fa fa-menu fa-chevron-down"></i>Community</a>
                                <div class="megamenu full">
                                    <div class="row">
                                        <div class="col-6 pl30">
                                            <ul class="megamenu-list">
                                                
<li class="menu-title"><i class="fa fa-menu-title fa-users"></i>Community</li>

<li><a href="https://cakephp.org/team"><i class="fa fa-menu fa-chevron-right"></i>Team</a></li>
<li><a href="https://github.com/cakephp/cakephp/issues"><i class="fa fa-menu fa-chevron-right"></i>Issues (Github)</a></li>
<li><a href="https://www.youtube.com/user/CakePHP"><i class="fa fa-menu fa-chevron-right"></i>YouTube Channel</a></li>
<li><a href="https://cakephp.org/get-involved"><i class="fa fa-menu fa-chevron-right"></i>Get Involved</a></li>

<li><a href="https://bakery.cakephp.org"><i class="fa fa-menu fa-chevron-right"></i>Bakery</a></li>
<li><a href="https://github.com/FriendsOfCake/awesome-cakephp"><i class="fa fa-menu fa-chevron-right"></i>Featured Resources</a></li>
<li><a href="https://cakephp.org/newsletter/signup"><i class="fa fa-menu fa-chevron-right"></i>Newsletter</a></li>
<li><a href="http://certification.cakephp.org"><i class="fa fa-menu fa-chevron-right"></i>Certification</a></li>
<li><a href="http://my.cakephp.org"><i class="fa fa-menu fa-chevron-right"></i>My CakePHP</a></li>
<li><a href="http://cakefest.org"><i class="fa fa-menu fa-chevron-right"></i>CakeFest</a></li>
<li><a href="https://www.facebook.com/groups/cake.community"><i class="fa fa-menu fa-chevron-right"></i>Facebook</a></li>
<li><a href="https://twitter.com/cakephp"><i class="fa fa-menu fa-chevron-right"></i>Twitter</a></li>
                                            </ul>
                                        </div>
                                        <div class="col-6 pl30">
                                            <ul class="megamenu-list">
                                                
<li class="menu-title"><i class="fa fa-menu-title fa-comments-o"></i>Help &amp; Support</li>

<li><a href="http://discourse.cakephp.org"><i class="fa fa-menu fa-chevron-right"></i>Forum</a></li>
<li><a href="https://stackoverflow.com/tags/cakephp"><i class="fa fa-menu fa-chevron-right"></i>Stack Overflow</a></li>
<li><a href="https://webchat.freenode.net/?channels=cakephp"><i class="fa fa-menu fa-chevron-right"></i>IRC</a></li>
<li><a href="https://cakesf.herokuapp.com/"><i class="fa fa-menu fa-chevron-right"></i>Slack</a></li>
<li><a href="https://www.cakedc.com/"><i class="fa fa-menu fa-chevron-right"></i>Paid Support</a></li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </li>
                        </ul>
                    </nav>
                </div>
            </div>
        </div>

        
        <div class="container-fluid hidden-md hidden-lg">
            <div class="row">
                <div class="col-sm-6 col-xs-6">
                    <a class="logo-cake" href="https://cakephp.org">
                        <img src="../_static/logo-cake.png" alt="CakePHP" />
                    </a>
                </div>

                <div class="col-sm-6 col-xs-6">
                    <div class="navbar-right">
                        <button id="btn-menu" class="btn-menu" data-toggle="modal" data-target="#modal">
                            <i class="fa fa-bars toggle-modal"></i>
                        </button>
                    </div>
                    <div id="wrap">
                        <form class="search" action="../search.html" method="get">
                            <input name="q" type="search" placeholder="What are you looking for?">
                            <input id="search_submit" value="Recherche" type="submit">
                        </form>
                    </div>
                </div>
            </div>
        </div>

        
        <section id="nav-cook" class="hidden-xs hidden-sm">
            <div class="container-fluid ">
                <div class="row ">
                    <div class="col-md-12 back-book">
                        <div class="col-md-5 text-center t-cook-nav p0 hidden-sm hidden-xs">
                            <h2>
                                <a href="../contents.html">
                                    <span class="glyph_range icon-submenu icon-submenu-cook">B</span>
                                    CakePHP 3.5 Red Velvet <strong>Cookbook</strong>
                                </a>
                            </h2>
                        </div>

                        <div class="col-md-4 hidden-sm">
                            <form class="search" action="../search.html" method="get">
                                <input type="hidden" name="check_keywords" value="yes" />
                                <input type="hidden" name="area" value="default" />

                                <div class="col-md-10 p0">
                                    <input class="form-control form-cook" autocomplete="off" type="search" name="q" size="18" placeholder='Cookbook Search' />
                                </div>
                                <div class="col-md-2 p0 search-cook">
                                    <button type="submit">
                                        <span class="glyph_range icon-submenu icon-submenu-cook">A</span>
                                    </button>
                                </div>
                            </form>
                        </div>

                        
                        <div class="col-md-3">
                            <div class="col-md-6 p0">
                                <div class="col-md-7 t-language p0">
                                    <h6>Language:</h6>
                                </div>
                                <div class="col-md-5 p0">
                                    <ul class="nav navbar-nav">
                                        <li class="dropdown">
                                            <a class="dropdown-toggle" data-hover="dropdown" data-toggle="dropdown"
                                                    role="button" aria-haspopup="true" aria-expanded="false" href="#">
                                                        fr
                                                        <i class="fa fa-menu-en fa-chevron-down"></i>
                                                    </a>
                                            <ul class="dropdown-menu">
                                            
                                                <li><a href="../../en/orm/validation.html">en</a></li>
                                            
                                                <li><a href="../../pt/orm/validation.html">pt</a></li>
                                            
                                                <li><a href="../../es/orm/validation.html">es</a></li>
                                            
                                                <li><a href="../../ja/orm/validation.html">ja</a></li>
                                            
                                                <li></li>
                                            
                                                <li><a href="../../zh/orm/validation.html">zh</a></li>
                                            
                                                <li><a href="../../tr/orm/validation.html">tr</a></li>
                                            
                                                <li><a href="../../ru/orm/validation.html">ru</a></li>
                                            
                                            </ul>
                                        </li>
                                    </ul>
                                </div>
                            </div>

                            <div class="col-md-6 p0">
                                <div class="col-md-7 t-language p0">
                                    <h6>Version:</h6>
                                </div>
                                <div class="col-md-5 p0">
                                    <ul class="nav navbar-nav">
                                        <li class="dropdown">
                                            <a href="#" class="dropdown-toggle" data-hover="dropdown" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">3.x <i class="fa fa-menu-en fa-chevron-down"></i></a>
                                            <ul class="dropdown-menu">
                                                <li><a href="https://book.cakephp.org/3.0/fr">3.x Book</a></li>
                                                <li><a href="https://book.cakephp.org/2.0/fr">2.x Book</a></li>
                                                <li><a href="https://book.cakephp.org/1.3/fr/">1.3 Book</a></li>
                                                <li><a href="https://book.cakephp.org/1.2/fr/">1.2 Book</a></li>
                                                <li><a href="https://book.cakephp.org/1.1/en">1.1 Book</a></li>
                                            </ul>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
            
        </section>
    </header>

    
    <section class="nav-btn visible-sm visible-xs">
        <div class="container">
            <div class="row">
                <div class="col-sm-6 col-xs-6 text-center">
                    <button id="btn-nav" class="btn btn-b btn-nav" data-toggle="modal" data-target="#modal"><strong>Nav</strong></button>
                </div>

                <div class="col-sm-6 col-xs-6 text-center">
                    <button id="btn-toc" class="btn btn-b btn-nav" data-toggle="modal" data-target="#modal"><strong>Table of Contents</strong></button>
                </div>
            </div>
        </div>
    </section>

    
    <div id="modal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="modal-header">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                    <h4 class="modal-title-cookbook" id="modal-header"></h4>
                </div>
                <div class="modal-body"></div>
            </div>
        </div>
    </div>

<div class="container page-container "><div id="improve-slideout">
        <i class="fa fa-pencil icon-improve"></i>
        <a href="https://github.com/cakephp/docs/edit/3.0/fr/orm/validation.rst" target="_blank">
            <div id="improve-slideout-inner"><h6>Improve This Doc <i class="fa fa-github git-improve"></i></h6></div>
        </a>
    </div><a id="back-to-contents" href="#page-contents"><i class="fa fa-arrow-circle-up icon-improve" title="Back to Contents"></i></a>

    
    <div class="row">
        <div class="col-sm-12 col-md-9 col-md-push-3"><div class="page-contents col-sm-5">
                <h3>Page Contents</h3>
                <ul>
<li><a class="reference internal" href="#">Valider des Données</a><ul>
<li><a class="reference internal" href="#valider-les-donnees-avant-de-construire-les-entities">Valider les Données Avant de Construire les Entities</a><ul>
<li><a class="reference internal" href="#creer-un-ensemble-de-validation-par-defaut">Créer un Ensemble de Validation par Défaut</a></li>
<li><a class="reference internal" href="#utiliser-un-ensemble-de-validation-different">Utiliser un Ensemble de Validation Différent</a></li>
</ul>
</li>
<li><a class="reference internal" href="#utiliser-un-ensemble-de-validation-different-pour-les-associations">Utiliser un Ensemble de Validation Différent pour les Associations</a><ul>
<li><a class="reference internal" href="#combiner-les-validators">Combiner les Validators</a></li>
<li><a class="reference internal" href="#validation-providers">Validation Providers</a></li>
<li><a class="reference internal" href="#recuperer-des-validators-depuis-les-tables">Récupérer des Validators depuis les Tables</a></li>
<li><a class="reference internal" href="#classe-validator-par-default">Classe Validator par Défault</a></li>
<li><a class="reference internal" href="#appliquer-des-regles-pour-l-application">Appliquer des Règles pour l&#8217;Application</a></li>
</ul>
</li>
<li><a class="reference internal" href="#creer-un-verificateur-de-regles">Créer un Vérificateur de Règles</a></li>
<li><a class="reference internal" href="#creer-des-regles-de-champ-unique">Créer des Règles de Champ Unique</a></li>
<li><a class="reference internal" href="#regles-des-cles-etrangeres">Règles des Clés Etrangères</a></li>
<li><a class="reference internal" href="#regles-sur-le-nombre-de-valeurs-d-une-association">Règles sur le Nombre de Valeurs d&#8217;une Association</a></li>
<li><a class="reference internal" href="#utiliser-les-methodes-entity-en-tant-que-regles">Utiliser les Méthodes Entity en tant que Règles</a></li>
<li><a class="reference internal" href="#creer-des-regles-personnalisees-reutilisables">Créer des Règles Personnalisées Réutilisables</a></li>
<li><a class="reference internal" href="#creer-des-objets-de-regles-personnalisees">Créer des Objets de Règles Personnalisées</a></li>
<li><a class="reference internal" href="#desactiver-les-regles">Désactiver les Règles</a><ul>
<li><a class="reference internal" href="#validation-vs-application-rules">Validation vs. Application Rules</a></li>
</ul>
</li>
<li><a class="reference internal" href="#utiliser-la-validation-en-tant-que-regle-d-application">Utiliser la Validation en tant que Règle d&#8217;Application</a></li>
</ul>
</li>
</ul>

            </div><div class="document-body">
            
  <div class="section" id="valider-des-donnees">
<h1>Valider des Données<a class="headerlink" href="#valider-des-donnees" title="Lien permanent vers ce titre">¶</a></h1>
<p>Avant que vous <a class="reference internal" href="saving-data.html"><span class="doc">sauvegardiez des données</span></a> vous voudrez
probablement vous assurer que les données sont correctes et cohérentes. Dans
CakePHP, nous avons deux étapes de validation:</p>
<ol class="arabic simple">
<li>Avant que les données de requête ne soit converties en entity, les règle de
validation concernant le type de données et leur format peuvent être appliquées.</li>
<li>Avant que les données ne soient sauvegardées, les règles du domaine ou de
l&#8217;application peuvent être appliquées. Ces règles aident à garantir que les
données de votre application restent cohérentes.</li>
</ol>
<div class="section" id="valider-les-donnees-avant-de-construire-les-entities">
<span id="validating-request-data"></span><h2>Valider les Données Avant de Construire les Entities<a class="headerlink" href="#valider-les-donnees-avant-de-construire-les-entities" title="Lien permanent vers ce titre">¶</a></h2>
<p>Durant la transformation des données en entities, vous pouvez valider les
données. La validation des données vous permet de vérifier le type, la forme et
la taille des données. Par défaut les données requêtées seront validées avant
qu&#8217;elles ne soient converties en entities.
Si aucune règle de validation n&#8217;échoue, l&#8217;entity retournée va contenir les
erreurs. Les champs avec des erreurs ne seront pas présents dans l&#8217;entity
retournée:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="nv">$article</span> <span class="o">=</span> <span class="nv">$articles</span><span class="o">-&gt;</span><span class="na">newEntity</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">request</span><span class="o">-&gt;</span><span class="na">getData</span><span class="p">());</span>
<span class="k">if</span> <span class="p">(</span><span class="nv">$article</span><span class="o">-&gt;</span><span class="na">errors</span><span class="p">())</span> <span class="p">{</span>
    <span class="c1">// validation de l&#39;entity a échouée.</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="versionadded">
<p><span class="versionmodified">Nouveau dans la version 3.4.0: </span>La méthode <code class="docutils literal"><span class="pre">getErrors()</span></code> a été ajoutée.</p>
</div>
<p>Quand vous construisez une entity avec la validation activée, les choses
suivantes vont se produire:</p>
<ol class="arabic simple">
<li>L&#8217;objet validator est créé.</li>
<li>Les providers de validation <code class="docutils literal"><span class="pre">table</span></code> et <code class="docutils literal"><span class="pre">default</span></code> sont attachés.</li>
<li>La méthode de validation nommée est appelée. Par exemple,
<code class="docutils literal"><span class="pre">validationDefault()</span></code>.</li>
<li>L&#8217;event <code class="docutils literal"><span class="pre">Model.buildValidator</span></code> va être déclenché.</li>
<li>Les données Requêtées vont être validées.</li>
<li>Les données Requêtées vont être castées en types qui correspondent
aux types de colonne.</li>
<li>Les erreurs vont être définies dans l&#8217;entity.</li>
<li>Les données valides vont être définies dans l&#8217;entity, alors que les champs
qui échouent la validation seront laissés de côté.</li>
</ol>
<p>Si vous voulez désactiver la validation lors de la conversion des données
requêtées, définissez l&#8217;option <code class="docutils literal"><span class="pre">validate</span></code> à false:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="nv">$article</span> <span class="o">=</span> <span class="nv">$articles</span><span class="o">-&gt;</span><span class="na">newEntity</span><span class="p">(</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">request</span><span class="o">-&gt;</span><span class="na">data</span><span class="p">,</span>
    <span class="p">[</span><span class="s1">&#39;validate&#39;</span> <span class="o">=&gt;</span> <span class="k">false</span><span class="p">]</span>
<span class="p">);</span>
</pre></div>
</div>
<p>La méthode <code class="docutils literal"><span class="pre">patchEntity()</span></code> fonctionne de façon identique:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="nv">$article</span> <span class="o">=</span> <span class="nv">$articles</span><span class="o">-&gt;</span><span class="na">patchEntity</span><span class="p">(</span><span class="nv">$article</span><span class="p">,</span> <span class="nv">$newData</span><span class="p">,</span> <span class="p">[</span>
    <span class="s1">&#39;validate&#39;</span> <span class="o">=&gt;</span> <span class="k">false</span>
<span class="p">]);</span>
</pre></div>
</div>
<div class="section" id="creer-un-ensemble-de-validation-par-defaut">
<h3>Créer un Ensemble de Validation par Défaut<a class="headerlink" href="#creer-un-ensemble-de-validation-par-defaut" title="Lien permanent vers ce titre">¶</a></h3>
<p>Les règles de validation sont définies dans la classe Table par commodité.
Cela aide à trouver les données qui doivent être validées en correspondance
avec l&#8217;endroit où elles seront sauvegardées.</p>
<p>Pour créer un objet validation dans votre table, créez la fonction
<code class="docutils literal"><span class="pre">validationDefault()</span></code>:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="k">use</span> <span class="nx">Cake\ORM\Table</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Cake\Validation\Validator</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">ArticlesTable</span> <span class="k">extends</span> <span class="nx">Table</span>
<span class="p">{</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">validationDefault</span><span class="p">(</span><span class="nx">Validator</span> <span class="nv">$validator</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$validator</span>
            <span class="o">-&gt;</span><span class="na">requirePresence</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="s1">&#39;create&#39;</span><span class="p">)</span>
            <span class="o">-&gt;</span><span class="na">notEmpty</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">);</span>

        <span class="nv">$validator</span>
            <span class="o">-&gt;</span><span class="na">allowEmpty</span><span class="p">(</span><span class="s1">&#39;link&#39;</span><span class="p">)</span>
            <span class="o">-&gt;</span><span class="na">add</span><span class="p">(</span><span class="s1">&#39;link&#39;</span><span class="p">,</span> <span class="s1">&#39;valid-url&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;rule&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;url&#39;</span><span class="p">]);</span>

        <span class="o">...</span>

        <span class="k">return</span> <span class="nv">$validator</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>les méthodes et règles de validation disponibles proviennent de la classe
<code class="docutils literal"><span class="pre">Validator</span></code> et sont documentées dans la section <a class="reference internal" href="../core-libraries/validation.html#creating-validators"><span class="std std-ref">Créer les Validators</span></a>.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Les objets validation sont principalement conçus pour être utilisés pour la
validation des données provenant d&#8217;utilisateurs, par exemple les formulaires
ou n&#8217;importe quelles données postées.</p>
</div>
</div>
<div class="section" id="utiliser-un-ensemble-de-validation-different">
<h3>Utiliser un Ensemble de Validation Différent<a class="headerlink" href="#utiliser-un-ensemble-de-validation-different" title="Lien permanent vers ce titre">¶</a></h3>
<p>En plus de désactiver la validation, vous pouvez choisir l&#8217;ensemble de règles de
validation que vous souhaitez appliquer:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="nv">$article</span> <span class="o">=</span> <span class="nv">$articles</span><span class="o">-&gt;</span><span class="na">newEntity</span><span class="p">(</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">request</span><span class="o">-&gt;</span><span class="na">data</span><span class="p">,</span>
    <span class="p">[</span><span class="s1">&#39;validate&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;update&#39;</span><span class="p">]</span>
<span class="p">);</span>
</pre></div>
</div>
<p>Ce qui est au-dessus va appeler la méthode <code class="docutils literal"><span class="pre">validationUpdate()</span></code> sur l&#8217;instance
table pour construire les règles requises. Par défaut la méthode
<code class="docutils literal"><span class="pre">validationDefault()</span></code> sera utilisée. Un exemple de méthode de validator pour
notre Table articles serait:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">ArticlesTable</span> <span class="k">extends</span> <span class="nx">Table</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">validationUpdate</span><span class="p">(</span><span class="nv">$validator</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$validator</span>
            <span class="o">-&gt;</span><span class="na">add</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="s1">&#39;notEmpty&#39;</span><span class="p">,</span> <span class="p">[</span>
                <span class="s1">&#39;rule&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;notEmpty&#39;</span><span class="p">,</span>
                <span class="s1">&#39;message&#39;</span> <span class="o">=&gt;</span> <span class="nx">__</span><span class="p">(</span><span class="s1">&#39;Vous devez fournir un titre&#39;</span><span class="p">),</span>
            <span class="p">])</span>
            <span class="o">-&gt;</span><span class="na">add</span><span class="p">(</span><span class="s1">&#39;body&#39;</span><span class="p">,</span> <span class="s1">&#39;notEmpty&#39;</span><span class="p">,</span> <span class="p">[</span>
                <span class="s1">&#39;rule&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;notEmpty&#39;</span><span class="p">,</span>
                <span class="s1">&#39;message&#39;</span> <span class="o">=&gt;</span> <span class="nx">__</span><span class="p">(</span><span class="s1">&#39;un corps est nécessaire&#39;</span><span class="p">)</span>
            <span class="p">]);</span>
        <span class="k">return</span> <span class="nv">$validator</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Vous pouvez avoir autant d&#8217;ensembles de validation que vous le souhaitez.
Consultez le <a class="reference internal" href="../core-libraries/validation.html"><span class="doc">chapitre sur la validation</span></a>
pour plus d&#8217;informations sur la construction des ensembles de règle de
validation.</p>
</div>
</div>
<div class="section" id="utiliser-un-ensemble-de-validation-different-pour-les-associations">
<span id="using-different-validators-per-association"></span><h2>Utiliser un Ensemble de Validation Différent pour les Associations<a class="headerlink" href="#utiliser-un-ensemble-de-validation-different-pour-les-associations" title="Lien permanent vers ce titre">¶</a></h2>
<p>Les ensembles de validation peuvent également être définis par association.
Lorsque vous utilisez les méthodes <code class="docutils literal"><span class="pre">newEntity()</span></code> ou <code class="docutils literal"><span class="pre">patchEntity()</span></code>, vous
pouvez passer des options supplémentaires à chaque association qui doit être
convertie:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="nv">$data</span> <span class="o">=</span> <span class="p">[</span>
     <span class="s1">&#39;title&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;My title&#39;</span><span class="p">,</span>
     <span class="s1">&#39;body&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;The text&#39;</span><span class="p">,</span>
     <span class="s1">&#39;user_id&#39;</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
     <span class="s1">&#39;user&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span>
         <span class="s1">&#39;username&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;mark&#39;</span>
     <span class="p">],</span>
     <span class="s1">&#39;comments&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span>
         <span class="p">[</span><span class="s1">&#39;body&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;First comment&#39;</span><span class="p">],</span>
         <span class="p">[</span><span class="s1">&#39;body&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Second comment&#39;</span><span class="p">],</span>
     <span class="p">]</span>
 <span class="p">];</span>

 <span class="nv">$article</span> <span class="o">=</span> <span class="nv">$articles</span><span class="o">-&gt;</span><span class="na">patchEntity</span><span class="p">(</span><span class="nv">$article</span><span class="p">,</span> <span class="nv">$data</span><span class="p">,</span> <span class="p">[</span>
     <span class="s1">&#39;validate&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;update&#39;</span><span class="p">,</span>
     <span class="s1">&#39;associated&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span>
         <span class="s1">&#39;Users&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">&#39;validate&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;signup&#39;</span><span class="p">],</span>
         <span class="s1">&#39;Comments&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">&#39;validate&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;custom&#39;</span><span class="p">]</span>
     <span class="p">]</span>
 <span class="p">]);</span>
</pre></div>
</div>
<div class="section" id="combiner-les-validators">
<h3>Combiner les Validators<a class="headerlink" href="#combiner-les-validators" title="Lien permanent vers ce titre">¶</a></h3>
<p>Grâce à la manière dont les objets validator sont construits, il est facile de
diviser leur process de construction en de petites étapes réutilisables:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="c1">// UsersTable.php</span>

<span class="k">public</span> <span class="k">function</span> <span class="nf">validationDefault</span><span class="p">(</span><span class="nx">Validator</span> <span class="nv">$validator</span><span class="p">)</span>
<span class="p">{</span>
    <span class="nv">$validator</span><span class="o">-&gt;</span><span class="na">notEmpty</span><span class="p">(</span><span class="s1">&#39;username&#39;</span><span class="p">);</span>
    <span class="nv">$validator</span><span class="o">-&gt;</span><span class="na">notEmpty</span><span class="p">(</span><span class="s1">&#39;password&#39;</span><span class="p">);</span>
    <span class="nv">$validator</span><span class="o">-&gt;</span><span class="na">add</span><span class="p">(</span><span class="s1">&#39;email&#39;</span><span class="p">,</span> <span class="s1">&#39;valid-email&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;rule&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;email&#39;</span><span class="p">]);</span>
    <span class="o">...</span>

    <span class="k">return</span> <span class="nv">$validator</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">function</span> <span class="nf">validationeHardened</span><span class="p">(</span><span class="nx">Validator</span> <span class="nv">$validator</span><span class="p">)</span>
<span class="p">{</span>
    <span class="nv">$validator</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">validationeDefault</span><span class="p">(</span><span class="nv">$validator</span><span class="p">);</span>

    <span class="nv">$validator</span><span class="o">-&gt;</span><span class="na">add</span><span class="p">(</span><span class="s1">&#39;password&#39;</span><span class="p">,</span> <span class="s1">&#39;length&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;rule&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">&#39;lengthBetween&#39;</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">100</span><span class="p">]]);</span>
    <span class="k">return</span> <span class="nv">$validator</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>En prenant en compte la configuration ci-dessus, lors de l&#8217;utilisation de
l&#8217;ensemble de validation <code class="docutils literal"><span class="pre">hardened</span></code>, il contiendra également les règles de
l&#8217;ensemble <code class="docutils literal"><span class="pre">default</span></code>.</p>
</div>
<div class="section" id="validation-providers">
<h3>Validation Providers<a class="headerlink" href="#validation-providers" title="Lien permanent vers ce titre">¶</a></h3>
<p>Les règles de validation peuvent utiliser les fonctions définies sur tout
provider connu. Par défaut, CakePHP définit quelques providers:</p>
<ol class="arabic simple">
<li>Les méthodes sur la classe table, ou ses behaviors sont disponible sur
le provider <code class="docutils literal"><span class="pre">table</span></code>.</li>
<li>La classe de <code class="xref php php-class docutils literal"><span class="pre">Validation\Validation</span></code> du coeur est
configurée avec le provider <code class="docutils literal"><span class="pre">default</span></code>.</li>
</ol>
<p>Quand une règle de validation est créée, vous pouvez nommer le provider de cette
règle. Par exemple, si votre table a une méthode <code class="docutils literal"><span class="pre">isValidRole</span></code>, vous pouvez
l&#8217;utiliser comme une règle de validation:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="k">use</span> <span class="nx">Cake\ORM\Table</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Cake\Validation\Validator</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">UsersTable</span> <span class="k">extends</span> <span class="nx">Table</span>
<span class="p">{</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">validationDefault</span><span class="p">(</span><span class="nx">Validator</span> <span class="nv">$validator</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$validator</span>
            <span class="o">-&gt;</span><span class="na">add</span><span class="p">(</span><span class="s1">&#39;role&#39;</span><span class="p">,</span> <span class="s1">&#39;validRole&#39;</span><span class="p">,</span> <span class="p">[</span>
                <span class="s1">&#39;rule&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;isValidRole&#39;</span><span class="p">,</span>
                <span class="s1">&#39;message&#39;</span> <span class="o">=&gt;</span> <span class="nx">__</span><span class="p">(</span><span class="s1">&#39;Vous devez fournir un rôle valide&#39;</span><span class="p">),</span>
                <span class="s1">&#39;provider&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;table&#39;</span><span class="p">,</span>
            <span class="p">]);</span>
        <span class="k">return</span> <span class="nv">$validator</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">isValidRole</span><span class="p">(</span><span class="nv">$value</span><span class="p">,</span> <span class="k">array</span> <span class="nv">$context</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nb">in_array</span><span class="p">(</span><span class="nv">$value</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;admin&#39;</span><span class="p">,</span> <span class="s1">&#39;editor&#39;</span><span class="p">,</span> <span class="s1">&#39;author&#39;</span><span class="p">],</span> <span class="k">true</span><span class="p">);</span>
    <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>
<p>Vous pouvez également utiliser des closures en tant que règle de validation:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="nv">$validator</span><span class="o">-&gt;</span><span class="na">add</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;myRule&#39;</span><span class="p">,</span> <span class="p">[</span>
    <span class="s1">&#39;rule&#39;</span> <span class="o">=&gt;</span> <span class="k">function</span> <span class="p">(</span><span class="nv">$data</span><span class="p">,</span> <span class="nv">$provider</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$data</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="s1">&#39;Valeur incorrecte.&#39;</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">]);</span>
</pre></div>
</div>
<p>Les méthodes de validation peuvent renvoyer des messages lorsqu&#8217;elles échouent.
C&#8217;est un moyen simple de créer des messages d&#8217;erreur dynamiques basés sur la
valeur fournie.</p>
</div>
<div class="section" id="recuperer-des-validators-depuis-les-tables">
<h3>Récupérer des Validators depuis les Tables<a class="headerlink" href="#recuperer-des-validators-depuis-les-tables" title="Lien permanent vers ce titre">¶</a></h3>
<p>Une fois que vous avez créé quelques ensembles de validation dans votre classe
table, vous pouvez récupérer l&#8217;objet résultant via son nom:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="nv">$defaultValidator</span> <span class="o">=</span> <span class="nv">$usersTable</span><span class="o">-&gt;</span><span class="na">validator</span><span class="p">(</span><span class="s1">&#39;default&#39;</span><span class="p">);</span>

<span class="nv">$hardenedValidator</span> <span class="o">=</span> <span class="nv">$usersTable</span><span class="o">-&gt;</span><span class="na">validator</span><span class="p">(</span><span class="s1">&#39;hardened&#39;</span><span class="p">);</span>
</pre></div>
</div>
<div class="deprecated">
<p><span class="versionmodified">Obsolète depuis la version 3.5.0: </span><code class="docutils literal"><span class="pre">validator()</span></code> est dépréciée. Utilisez <code class="docutils literal"><span class="pre">getValidator()</span></code> à la place.</p>
</div>
</div>
<div class="section" id="classe-validator-par-default">
<h3>Classe Validator par Défault<a class="headerlink" href="#classe-validator-par-default" title="Lien permanent vers ce titre">¶</a></h3>
<p>Comme mentionné ci-dessus, par défaut les méthodes de validation reçoivent
une instance de <code class="docutils literal"><span class="pre">Cake\Validation\Validator</span></code>. Si vous souhaitez utiliser
une instance d&#8217;un validator personnalisé, vous pouvez utiliser l&#8217;attribut
<code class="docutils literal"><span class="pre">$_validatorClass</span></code> de table:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="c1">// Dans votre class Table</span>
<span class="k">public</span> <span class="k">function</span> <span class="nf">initialize</span><span class="p">(</span><span class="k">array</span> <span class="nv">$config</span><span class="p">)</span>
<span class="p">{</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_validatorClass</span> <span class="o">=</span> <span class="s1">&#39;\FullyNamespaced\Custom\Validator&#39;</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="appliquer-des-regles-pour-l-application">
<span id="application-rules"></span><h3>Appliquer des Règles pour l&#8217;Application<a class="headerlink" href="#appliquer-des-regles-pour-l-application" title="Lien permanent vers ce titre">¶</a></h3>
<p>Alors qu&#8217;une validation basique des données est faite quand <a class="reference internal" href="#validating-request-data"><span class="std std-ref">les données
requêtées sont converties en entities</span></a>, de
nombreuses applications ont aussi d&#8217;autres validations plus complexes qui
doivent être appliquées seulement après qu&#8217;une validation basique a été
terminée.</p>
<p>Alors que la validation s&#8217;assure que le formulaire ou la syntaxe de vos données
sont corrects, les règles s&#8217;attellent à comparer les données avec un état
existant de votre application et/ou de votre réseau.</p>
<p>Ces types de règles sont souvent appelées &#8216;règles de domaine&#8217; ou
&#8216;règles de l&#8217;application&#8217;. CakePHP utilise ce concept avec les &#8216;RulesCheckers&#8217;
qui sont appliquées avant que les entities ne soient sauvegardées. Voici
quelques exemples de règles de domaine:</p>
<ul class="simple">
<li>S&#8217;assurer qu&#8217;un email est unique.</li>
<li>Etats de transition ou étapes de flux de travail, par exemple pour mettre à
jour un statut de facture.</li>
<li>Eviter la modification ou la suppression soft d&#8217;articles.</li>
<li>Enforcing usage/rate limit caps.</li>
</ul>
<p>Les règles de domaine sont vérifiées lors de l&#8217;appel au méthodes <code class="docutils literal"><span class="pre">save()</span></code> et
<code class="docutils literal"><span class="pre">delete()</span></code> de la Table.</p>
</div>
</div>
<div class="section" id="creer-un-verificateur-de-regles">
<h2>Créer un Vérificateur de Règles<a class="headerlink" href="#creer-un-verificateur-de-regles" title="Lien permanent vers ce titre">¶</a></h2>
<p>Les classes de vérificateur de Règles sont généralement définies par la
méthode <code class="docutils literal"><span class="pre">buildRules()</span></code> dans votre classe de table. Les behaviors et les autres
souscripteurs d&#8217;event peuvent utiliser l&#8217;event <code class="docutils literal"><span class="pre">Model.buildRules</span></code> pour
ajouter des règles au vérificateur pour une classe de Table donnée:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="k">use</span> <span class="nx">Cake\ORM\RulesChecker</span><span class="p">;</span>

<span class="c1">// Dans une classe de table</span>
<span class="k">public</span> <span class="k">function</span> <span class="nf">buildRules</span><span class="p">(</span><span class="nx">RulesChecker</span> <span class="nv">$rules</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// Ajoute une règle qui est appliquée pour la création et la mise à jour d&#39;opérations</span>
    <span class="nv">$rules</span><span class="o">-&gt;</span><span class="na">add</span><span class="p">(</span><span class="k">function</span> <span class="p">(</span><span class="nv">$entity</span><span class="p">,</span> <span class="nv">$options</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// Retourne un booléen pour indiquer si succès/échec</span>
    <span class="p">},</span> <span class="s1">&#39;ruleName&#39;</span><span class="p">);</span>

    <span class="c1">// Ajoute une règle pour la création.</span>
    <span class="nv">$rules</span><span class="o">-&gt;</span><span class="na">addCreate</span><span class="p">(</span><span class="k">function</span> <span class="p">(</span><span class="nv">$entity</span><span class="p">,</span> <span class="nv">$options</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// Retourne un booléen pour indiquer si succès/échec</span>
    <span class="p">},</span> <span class="s1">&#39;ruleName&#39;</span><span class="p">);</span>

    <span class="c1">// Ajoute une règle pour la mise à jour.</span>
    <span class="nv">$rules</span><span class="o">-&gt;</span><span class="na">addUpdate</span><span class="p">(</span><span class="k">function</span> <span class="p">(</span><span class="nv">$entity</span><span class="p">,</span> <span class="nv">$options</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// Retourne un booléen pour indiquer si succès/échec</span>
    <span class="p">},</span> <span class="s1">&#39;ruleName&#39;</span><span class="p">);</span>

    <span class="c1">// Ajoute une règle pour la suppression.</span>
    <span class="nv">$rules</span><span class="o">-&gt;</span><span class="na">addDelete</span><span class="p">(</span><span class="k">function</span> <span class="p">(</span><span class="nv">$entity</span><span class="p">,</span> <span class="nv">$options</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// Retourne un booléen pour indiquer si succès/échec</span>
    <span class="p">},</span> <span class="s1">&#39;ruleName&#39;</span><span class="p">);</span>

    <span class="k">return</span> <span class="nv">$rules</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Vos fonctions de règles ont pour paramètres l&#8217;Entity à vérifier et un tableau
d&#8217;options. Le tableau d&#8217;options va contenir <code class="docutils literal"><span class="pre">errorField</span></code>, <code class="docutils literal"><span class="pre">message</span></code> et
<code class="docutils literal"><span class="pre">repository</span></code>. L&#8217;option <code class="docutils literal"><span class="pre">repository</span></code> va contenir la classe de table sur
laquelle les règles sont attachées. Comme les règles acceptent tout
<code class="docutils literal"><span class="pre">callable</span></code>, vous pouvez aussi utiliser des fonctions d&#8217;instance:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="nv">$rules</span><span class="o">-&gt;</span><span class="na">addCreate</span><span class="p">([</span><span class="nv">$this</span><span class="p">,</span> <span class="s1">&#39;uniqueEmail&#39;</span><span class="p">],</span> <span class="s1">&#39;uniqueEmail&#39;</span><span class="p">);</span>
</pre></div>
</div>
<p>ou des classes callable:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="nv">$rules</span><span class="o">-&gt;</span><span class="na">addCreate</span><span class="p">(</span><span class="k">new</span> <span class="nx">IsUnique</span><span class="p">([</span><span class="s1">&#39;email&#39;</span><span class="p">]),</span> <span class="s1">&#39;uniqueEmail&#39;</span><span class="p">);</span>
</pre></div>
</div>
<p>Lors de l&#8217;ajout de règles, vous pouvez définir le champ pour lequel la règle
est faite, et le message d&#8217;erreur en options:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="nv">$rules</span><span class="o">-&gt;</span><span class="na">add</span><span class="p">([</span><span class="nv">$this</span><span class="p">,</span> <span class="s1">&#39;isValidState&#39;</span><span class="p">],</span> <span class="s1">&#39;validState&#39;</span><span class="p">,</span> <span class="p">[</span>
    <span class="s1">&#39;errorField&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;status&#39;</span><span class="p">,</span>
    <span class="s1">&#39;message&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Cette facture ne peut pas être déplacée pour ce statut.&#39;</span>
<span class="p">]);</span>
</pre></div>
</div>
<p>L&#8217;erreur sera visible lors de l&#8217;appel à la méthode <code class="docutils literal"><span class="pre">errors()</span></code> dans l&#8217;entity:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="nv">$entity</span><span class="o">-&gt;</span><span class="na">errors</span><span class="p">();</span> <span class="c1">// Contient les messages d&#39;erreur des règles du domaine</span>
</pre></div>
</div>
</div>
<div class="section" id="creer-des-regles-de-champ-unique">
<h2>Créer des Règles de Champ Unique<a class="headerlink" href="#creer-des-regles-de-champ-unique" title="Lien permanent vers ce titre">¶</a></h2>
<p>Comme les règles uniques sont couramment utilisées, CakePHP inclut une classe
de Règle simple qui vous permet de définir des ensembles de champ unique:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="k">use</span> <span class="nx">Cake\ORM\Rule\IsUnique</span><span class="p">;</span>

<span class="c1">// Un champ unique.</span>
<span class="nv">$rules</span><span class="o">-&gt;</span><span class="na">add</span><span class="p">(</span><span class="nv">$rules</span><span class="o">-&gt;</span><span class="na">isUnique</span><span class="p">([</span><span class="s1">&#39;email&#39;</span><span class="p">]));</span>

<span class="c1">// Une liste de champs</span>
<span class="nv">$rules</span><span class="o">-&gt;</span><span class="na">add</span><span class="p">(</span><span class="nv">$rules</span><span class="o">-&gt;</span><span class="na">isUnique</span><span class="p">(</span>
    <span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">,</span> <span class="s1">&#39;account_id&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Cette combinaison `username` &amp; `account_id` est déjà utilisée.&#39;</span>
<span class="p">));</span>
</pre></div>
</div>
<p>Quand vous définissez des règles sur des champs de clé étrangère, il est
important de se rappeler que seuls les champs listés sont utilisés dans la
règle. Cela signifie que définir <code class="docutils literal"><span class="pre">$user-&gt;account-&gt;id</span></code> ne va pas déclencher
la règle ci-dessus.</p>
</div>
<div class="section" id="regles-des-cles-etrangeres">
<h2>Règles des Clés Etrangères<a class="headerlink" href="#regles-des-cles-etrangeres" title="Lien permanent vers ce titre">¶</a></h2>
<p>Alors que vous pourriez compter sur les erreurs de la base de données pour
imposer des contraintes, utiliser des règles peut vous aider à fournir une
expérience utilisateur plus sympathique. C&#8217;est pour cela que CakePHP inclut
une classe de règle <code class="docutils literal"><span class="pre">ExistsIn</span></code>:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="c1">// Un champ unique.</span>
<span class="nv">$rules</span><span class="o">-&gt;</span><span class="na">add</span><span class="p">(</span><span class="nv">$rules</span><span class="o">-&gt;</span><span class="na">existsIn</span><span class="p">(</span><span class="s1">&#39;article_id&#39;</span><span class="p">,</span> <span class="s1">&#39;articles&#39;</span><span class="p">));</span>

<span class="c1">// Plusieurs clés, utile pour des clés primaires composites.</span>
<span class="nv">$rules</span><span class="o">-&gt;</span><span class="na">add</span><span class="p">(</span><span class="nv">$rules</span><span class="o">-&gt;</span><span class="na">existsIn</span><span class="p">([</span><span class="s1">&#39;site_id&#39;</span><span class="p">,</span> <span class="s1">&#39;article_id&#39;</span><span class="p">],</span> <span class="s1">&#39;articles&#39;</span><span class="p">));</span>
</pre></div>
</div>
<p>Les champs dont il faut vérifier l&#8217;existence dans la table liée doivent faire
parti de la clé primaire.</p>
<p>Vous pouvez forcer <code class="docutils literal"><span class="pre">existsIn</span></code> à passer quand des parties qui peuvent être
nulles de votre clé étrangère composite sont nulles:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="c1">// Example: Une clé primaire composée dans NodesTable est (id, site_id).</span>
<span class="c1">// Un &quot;Node&quot; peut faire référence à un parent Node mais ce n&#39;est pas obligatoire.</span>
<span class="c1">// Dans un cas d&#39;utilisation, parent_id est null.</span>
<span class="c1">// Nous permettons à cette règle de passer, même si les champs qui sont nullable, comme</span>
<span class="c1">// parent_id, sont null :</span>
<span class="nv">$rules</span><span class="o">-&gt;</span><span class="na">add</span><span class="p">(</span><span class="nv">$rules</span><span class="o">-&gt;</span><span class="na">existsIn</span><span class="p">(</span>
    <span class="p">[</span><span class="s1">&#39;parent_id&#39;</span><span class="p">,</span> <span class="s1">&#39;site_id&#39;</span><span class="p">],</span> <span class="c1">// Schema: parent_id NULL, site_id NOT NULL</span>
    <span class="s1">&#39;ParentNodes&#39;</span><span class="p">,</span>
    <span class="p">[</span><span class="s1">&#39;allowNullableNulls&#39;</span> <span class="o">=&gt;</span> <span class="k">true</span><span class="p">]</span>
<span class="p">));</span>

<span class="c1">// Un Node doit cependant toujours avoir une référence à un Site.</span>
<span class="nv">$rules</span><span class="o">-&gt;</span><span class="na">add</span><span class="p">(</span><span class="nv">$rules</span><span class="o">-&gt;</span><span class="na">existsIn</span><span class="p">([</span><span class="s1">&#39;site_id&#39;</span><span class="p">],</span> <span class="s1">&#39;Sites&#39;</span><span class="p">));</span>
</pre></div>
</div>
<p>Dans la majorité des bases de données SQL, les index <code class="docutils literal"><span class="pre">UNIQUE</span></code> sur plusieurs
colonnes permettent à plusieurs valeurs null d&#8217;exister car <code class="docutils literal"><span class="pre">NULL</span></code> n&#8217;est
pas égale à lui même. Même si autoriser plusieurs valeurs null est le comportement
par défaut de CakePHP, vous pouvez inclure des valeurs null dans vos validations
en utilisant <code class="docutils literal"><span class="pre">allowMultipleNulls</span></code>:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="c1">// Seulement une valeur null peut exister dans `parent_id` et `site_id`</span>
<span class="nv">$rules</span><span class="o">-&gt;</span><span class="na">add</span><span class="p">(</span><span class="nv">$rules</span><span class="o">-&gt;</span><span class="na">existsIn</span><span class="p">(</span>
    <span class="p">[</span><span class="s1">&#39;parent_id&#39;</span><span class="p">,</span> <span class="s1">&#39;site_id&#39;</span><span class="p">],</span>
    <span class="s1">&#39;ParentNodes&#39;</span><span class="p">,</span>
    <span class="p">[</span><span class="s1">&#39;allowMultipleNulls&#39;</span> <span class="o">=&gt;</span> <span class="k">false</span><span class="p">]</span>
<span class="p">));</span>
</pre></div>
</div>
<div class="versionadded">
<p><span class="versionmodified">Nouveau dans la version 3.3.0: </span>Les options <code class="docutils literal"><span class="pre">allowNullableNulls</span></code> et <code class="docutils literal"><span class="pre">allowMultipleNulls</span></code> ont été ajoutées.</p>
</div>
</div>
<div class="section" id="regles-sur-le-nombre-de-valeurs-d-une-association">
<h2>Règles sur le Nombre de Valeurs d&#8217;une Association<a class="headerlink" href="#regles-sur-le-nombre-de-valeurs-d-une-association" title="Lien permanent vers ce titre">¶</a></h2>
<p>Si vous devez valider qu&#8217;une propriété ou une association contient un bon nombre
de valeurs, vous pouvez utiliser la règle <code class="docutils literal"><span class="pre">validCount()</span></code>:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="c1">// Dans le fichier ArticlesTable.php</span>
<span class="c1">// Pas plus de 5 tags sur un article.</span>
<span class="nv">$rules</span><span class="o">-&gt;</span><span class="na">add</span><span class="p">(</span><span class="nv">$rules</span><span class="o">-&gt;</span><span class="na">validCount</span><span class="p">(</span><span class="s1">&#39;tags&#39;</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;&lt;=&#39;</span><span class="p">,</span> <span class="s1">&#39;Vous pouvez avoir seulement 5 tags&#39;</span><span class="p">));</span>
</pre></div>
</div>
<p>Quand vous définissez des règles qui concernent le nombre, le troisième
paramètre vous permet de définir l&#8217;opérateur de comparaison à utiliser. <code class="docutils literal"><span class="pre">==</span></code>,
<code class="docutils literal"><span class="pre">&gt;=</span></code>, <code class="docutils literal"><span class="pre">&lt;=</span></code>, <code class="docutils literal"><span class="pre">&gt;</span></code>, <code class="docutils literal"><span class="pre">&lt;</span></code>, and <code class="docutils literal"><span class="pre">!=</span></code> sont les opérateurs acceptés. Pour vous
assurer qu&#8217;un nombre d&#8217;une propriété est entre certaines valeurs, utilisez deux
règles:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="c1">// Dans le fichier ArticlesTable.php</span>
<span class="c1">// Entre 3 et 5 tags</span>
<span class="nv">$rules</span><span class="o">-&gt;</span><span class="na">add</span><span class="p">(</span><span class="nv">$rules</span><span class="o">-&gt;</span><span class="na">validCount</span><span class="p">(</span><span class="s1">&#39;tags&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;&gt;=&#39;</span><span class="p">,</span> <span class="s1">&#39;Vous devez avoir au moins 3 tags&#39;</span><span class="p">));</span>
<span class="nv">$rules</span><span class="o">-&gt;</span><span class="na">add</span><span class="p">(</span><span class="nv">$rules</span><span class="o">-&gt;</span><span class="na">validCount</span><span class="p">(</span><span class="s1">&#39;tags&#39;</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;&lt;=&#39;</span><span class="p">,</span> <span class="s1">&#39;Vous devez avoir au moins 5 tags&#39;</span><span class="p">));</span>
</pre></div>
</div>
<p>Notez que <code class="docutils literal"><span class="pre">validCount</span></code> retourne <code class="docutils literal"><span class="pre">false</span></code> si la propriété ne peut pas être comptée
ou n&#8217;existe pas:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="c1">// La sauvegarde échouera si tags est null</span>
<span class="nv">$rules</span><span class="o">-&gt;</span><span class="na">add</span><span class="p">(</span><span class="nv">$rules</span><span class="o">-&gt;</span><span class="na">validCount</span><span class="p">(</span><span class="s1">&#39;tags&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;&lt;=&#39;</span><span class="p">,</span> <span class="s1">&#39;Vous ne devez pas avoir de tags&#39;</span><span class="p">));</span>
</pre></div>
</div>
<div class="versionadded">
<p><span class="versionmodified">Nouveau dans la version 3.3.0: </span>La méthode <code class="docutils literal"><span class="pre">validCount()</span></code> a été ajoutée dans la version 3.3.0.</p>
</div>
</div>
<div class="section" id="utiliser-les-methodes-entity-en-tant-que-regles">
<h2>Utiliser les Méthodes Entity en tant que Règles<a class="headerlink" href="#utiliser-les-methodes-entity-en-tant-que-regles" title="Lien permanent vers ce titre">¶</a></h2>
<p>Vous pouvez utiliser les méthodes entity en tant que règles de domaine:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="nv">$rules</span><span class="o">-&gt;</span><span class="na">add</span><span class="p">(</span><span class="k">function</span> <span class="p">(</span><span class="nv">$entity</span><span class="p">,</span> <span class="nv">$options</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nv">$entity</span><span class="o">-&gt;</span><span class="na">isOkLooking</span><span class="p">();</span>
<span class="p">},</span> <span class="s1">&#39;ruleName&#39;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="section" id="creer-des-regles-personnalisees-reutilisables">
<h2>Créer des Règles Personnalisées Réutilisables<a class="headerlink" href="#creer-des-regles-personnalisees-reutilisables" title="Lien permanent vers ce titre">¶</a></h2>
<p>Vous pouvez vouloir réutiliser des règles de domaine personnalisées. Vous pouvez
le faire en créant votre propre règle invokable:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="k">use</span> <span class="nx">App\ORM\Rule\IsUniqueWithNulls</span><span class="p">;</span>
<span class="c1">// ...</span>
<span class="k">public</span> <span class="k">function</span> <span class="nf">buildRules</span><span class="p">(</span><span class="nx">RulesChecker</span> <span class="nv">$rules</span><span class="p">)</span>
<span class="p">{</span>
    <span class="nv">$rules</span><span class="o">-&gt;</span><span class="na">add</span><span class="p">(</span><span class="k">new</span> <span class="nx">IsUniqueWithNulls</span><span class="p">([</span><span class="s1">&#39;parent_id&#39;</span><span class="p">,</span> <span class="s1">&#39;instance_id&#39;</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">]),</span> <span class="s1">&#39;uniqueNamePerParent&#39;</span><span class="p">,</span> <span class="p">[</span>
        <span class="s1">&#39;errorField&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;name&#39;</span><span class="p">,</span>
        <span class="s1">&#39;message&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Name must be unique per parent.&#39;</span>
    <span class="p">]);</span>
    <span class="k">return</span> <span class="nv">$rules</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Regardez les règles du coeur pour plus d&#8217;informations sur la façon de créer de
telles règles.</p>
</div>
<div class="section" id="creer-des-objets-de-regles-personnalisees">
<h2>Créer des Objets de Règles Personnalisées<a class="headerlink" href="#creer-des-objets-de-regles-personnalisees" title="Lien permanent vers ce titre">¶</a></h2>
<p>Si votre application a des règles qui sont souvent réutilisées, il peut être
utile de packager ces règles dans des classes réutilisables:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="c1">// Dans src/Model/Rule/CustomRule.php</span>
<span class="k">namespace</span> <span class="nx">App\Model\Rule</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">Cake\Datasource\EntityInterface</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">CustomRule</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="fm">__invoke</span><span class="p">(</span><span class="nx">EntityInterface</span> <span class="nv">$entity</span><span class="p">,</span> <span class="k">array</span> <span class="nv">$options</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// Do work</span>
        <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Ajoute la règle personnalisée</span>
<span class="k">use</span> <span class="nx">App\Model\Rule\CustomRule</span><span class="p">;</span>

<span class="nv">$rules</span><span class="o">-&gt;</span><span class="na">add</span><span class="p">(</span><span class="k">new</span> <span class="nx">CustomRule</span><span class="p">(</span><span class="o">...</span><span class="p">),</span> <span class="s1">&#39;ruleName&#39;</span><span class="p">);</span>
</pre></div>
</div>
<p>En ajoutant des classes de règle personnalisée, vous pouvez garder votre code
DRY et faciliter le test des règles de votre domaine.</p>
</div>
<div class="section" id="desactiver-les-regles">
<h2>Désactiver les Règles<a class="headerlink" href="#desactiver-les-regles" title="Lien permanent vers ce titre">¶</a></h2>
<p>Quand vous sauvegardez une entity, vous pouvez désactiver les règles si cela
est nécessaire:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="nv">$articles</span><span class="o">-&gt;</span><span class="na">save</span><span class="p">(</span><span class="nv">$article</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;checkRules&#39;</span> <span class="o">=&gt;</span> <span class="k">false</span><span class="p">]);</span>
</pre></div>
</div>
<div class="section" id="validation-vs-application-rules">
<h3>Validation vs. Application Rules<a class="headerlink" href="#validation-vs-application-rules" title="Lien permanent vers ce titre">¶</a></h3>
<p>L&#8217;ORM de CakePHP est unique dans le sens où il utilise une approche à deux
couches pour la validation.</p>
<p>La première couche est la validation. Les règles de validation ont pour objectif
d&#8217;opérer d&#8217;une façon stateless. Elles permettent de s&#8217;assurer que la forme, les
types de données et le format des données sont corrects.</p>
<p>La seconde couche sont les règles d&#8217;application. Les règles d&#8217;application
permettent de vérifier les propriétés stateful de vos entities. Par exemple,
les règles de validation peuvent permettre de s&#8217;assurer qu&#8217;une adresse email est
valide, alors qu&#8217;une règle d&#8217;application permet de s&#8217;assurer que l&#8217;adresse
email est unique.</p>
<p>Comme vous avez pu le voir, la première couche est réalisée via l&#8217;objet
<code class="docutils literal"><span class="pre">Validator</span></code> lors de l&#8217;appel à <code class="docutils literal"><span class="pre">newEntity()</span></code> ou <code class="docutils literal"><span class="pre">patchEntity()</span></code>:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="nv">$validatedEntity</span> <span class="o">=</span> <span class="nv">$articlesTable</span><span class="o">-&gt;</span><span class="na">newEntity</span><span class="p">(</span>
    <span class="nv">$unsafeData</span><span class="p">,</span>
    <span class="p">[</span><span class="s1">&#39;validate&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;customName&#39;</span><span class="p">]</span>
<span class="p">);</span>
<span class="nv">$validatedEntity</span> <span class="o">=</span> <span class="nv">$articlesTable</span><span class="o">-&gt;</span><span class="na">patchEntity</span><span class="p">(</span>
    <span class="nv">$entity</span><span class="p">,</span>
    <span class="nv">$unsafeData</span><span class="p">,</span>
    <span class="p">[</span><span class="s1">&#39;validate&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;customName&#39;</span><span class="p">]</span>
<span class="p">);</span>
</pre></div>
</div>
<p>Dans l&#8217;exemple ci-dessus, nous allons utiliser un validateur &#8216;custom&#8217;, qui est
défini en utilisant la méthode <code class="docutils literal"><span class="pre">validationCustomName()</span></code>:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="k">public</span> <span class="k">function</span> <span class="nf">validationCustomName</span><span class="p">(</span><span class="nv">$validator</span><span class="p">)</span>
<span class="p">{</span>
    <span class="nv">$validator</span><span class="o">-&gt;</span><span class="na">add</span><span class="p">(</span><span class="o">...</span><span class="p">);</span>
    <span class="k">return</span> <span class="nv">$validator</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>La validation fait l&#8217;hypothèse que les chaînes de caractères et les tableaux
sont passés puisque c&#8217;est ce qui est reçu par n&#8217;importe quelle requête:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="c1">// Dans src/Model/Table/UsersTable.php</span>
<span class="k">public</span> <span class="k">function</span> <span class="nf">validatePasswords</span><span class="p">(</span><span class="nv">$validator</span><span class="p">)</span>
<span class="p">{</span>
    <span class="nv">$validator</span><span class="o">-&gt;</span><span class="na">add</span><span class="p">(</span><span class="s1">&#39;confirm_password&#39;</span><span class="p">,</span> <span class="s1">&#39;no-misspelling&#39;</span><span class="p">,</span> <span class="p">[</span>
        <span class="s1">&#39;rule&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">&#39;compareWith&#39;</span><span class="p">,</span> <span class="s1">&#39;password&#39;</span><span class="p">],</span>
        <span class="s1">&#39;message&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Les mot de passe ne sont pas égaux&#39;</span><span class="p">,</span>
    <span class="p">]);</span>

    <span class="o">...</span>
    <span class="k">return</span> <span class="nv">$validator</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>La validation <strong>n&#8217;est pas</strong> déclenchée lorsqu&#8217;une propriété est définie
directement dans vos entities:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="nv">$userEntity</span><span class="o">-&gt;</span><span class="na">email</span> <span class="o">=</span> <span class="s1">&#39;pas un email!!&#39;</span><span class="p">;</span>
<span class="nv">$usersTable</span><span class="o">-&gt;</span><span class="na">save</span><span class="p">(</span><span class="nv">$userEntity</span><span class="p">);</span>
</pre></div>
</div>
<p>Dans l&#8217;exemple ci-dessus, l&#8217;entity sera sauvegardée car la validation n&#8217;est
déclenchée que par les méthodes <code class="docutils literal"><span class="pre">newEntity()</span></code> et <code class="docutils literal"><span class="pre">patchEntity()</span></code>. Le second
niveau de validation est conçu pour gérer cette situation.</p>
<p>Les règles d&#8217;application, comme expliqué précédement, seront vérifiées à chaque
fois que <code class="docutils literal"><span class="pre">save()</span></code> ou <code class="docutils literal"><span class="pre">delete()</span></code> sont appelées:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="c1">// Dans src/Model/Table/UsersTable.php</span>
<span class="k">public</span> <span class="k">function</span> <span class="nf">buildRules</span><span class="p">(</span><span class="nx">RulesChecker</span> <span class="nv">$rules</span><span class="p">)</span>
<span class="p">{</span>
    <span class="nv">$rules</span><span class="o">-&gt;</span><span class="na">add</span><span class="p">(</span><span class="nv">$rules</span><span class="o">-&gt;</span><span class="na">isUnique</span><span class="p">(</span><span class="s1">&#39;email&#39;</span><span class="p">));</span>
    <span class="k">return</span> <span class="nv">$rules</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// Autre part dans le code de votre application</span>
<span class="nv">$userEntity</span><span class="o">-&gt;</span><span class="na">email</span> <span class="o">=</span> <span class="s1">&#39;a@duplicated.email&#39;</span><span class="p">;</span>
<span class="nv">$usersTable</span><span class="o">-&gt;</span><span class="na">save</span><span class="p">(</span><span class="nv">$userEntity</span><span class="p">);</span> <span class="c1">// Retourne false</span>
</pre></div>
</div>
<p>Alors que la validation est conçue pour les données provenant directement
d&#8217;utilisateurs, les règles d&#8217;application sont spécifiques aux transitions de
données générées à l&#8217;intérieur de l&#8217;application:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="c1">// Dans src/Model/Table/OrdersTable.php</span>
<span class="k">public</span> <span class="k">function</span> <span class="nf">buildRules</span><span class="p">(</span><span class="nx">RulesChecker</span> <span class="nv">$rules</span><span class="p">)</span>
<span class="p">{</span>
    <span class="nv">$check</span> <span class="o">=</span> <span class="k">function</span> <span class="p">(</span><span class="nv">$order</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$order</span><span class="o">-&gt;</span><span class="na">price</span> <span class="o">&lt;</span> <span class="mi">100</span> <span class="o">&amp;&amp;</span> <span class="nv">$order</span><span class="o">-&gt;</span><span class="na">shipping_mode</span> <span class="o">===</span> <span class="s1">&#39;free&#39;</span><span class="p">;</span>
    <span class="p">};</span>
    <span class="nv">$rules</span><span class="o">-&gt;</span><span class="na">add</span><span class="p">(</span><span class="nv">$check</span><span class="p">,</span> <span class="p">[</span>
        <span class="s1">&#39;errorField&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;shipping_mode&#39;</span><span class="p">,</span>
        <span class="s1">&#39;message&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Pas de frais de port gratuit pour une commande de moins de 100!&#39;</span>
    <span class="p">]);</span>
    <span class="k">return</span> <span class="nv">$rules</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// Autre part dans le code de l&#39;application</span>
<span class="nv">$order</span><span class="o">-&gt;</span><span class="na">price</span> <span class="o">=</span> <span class="mi">50</span><span class="p">;</span>
<span class="nv">$order</span><span class="o">-&gt;</span><span class="na">shipping_mode</span> <span class="o">=</span> <span class="s1">&#39;free&#39;</span><span class="p">;</span>
<span class="nv">$ordersTable</span><span class="o">-&gt;</span><span class="na">save</span><span class="p">(</span><span class="nv">$order</span><span class="p">);</span> <span class="c1">// Retourne false</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="utiliser-la-validation-en-tant-que-regle-d-application">
<h2>Utiliser la Validation en tant que Règle d&#8217;Application<a class="headerlink" href="#utiliser-la-validation-en-tant-que-regle-d-application" title="Lien permanent vers ce titre">¶</a></h2>
<p>Dans certaines situations, vous voudrez peut-être lancer les mêmes routines
pour des données générées à la fois par un utilisateur et à l&#8217;intérieur de
votre application. Cela peut se produire lorsque vous exécutez un script CLI
qui définit des propriétés directement dans des entities:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="c1">// Dans src/Model/Table/UsersTable.php</span>
<span class="k">public</span> <span class="k">function</span> <span class="nf">validationDefault</span><span class="p">(</span><span class="nx">Validator</span> <span class="nv">$validator</span><span class="p">)</span>
<span class="p">{</span>
    <span class="nv">$validator</span><span class="o">-&gt;</span><span class="na">add</span><span class="p">(</span><span class="s1">&#39;email&#39;</span><span class="p">,</span> <span class="s1">&#39;valid&#39;</span><span class="p">,</span> <span class="p">[</span>
        <span class="s1">&#39;rule&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;email&#39;</span><span class="p">,</span>
        <span class="s1">&#39;message&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Email invalide&#39;</span>
    <span class="p">]);</span>
    <span class="o">...</span>
    <span class="k">return</span> <span class="nv">$validator</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">function</span> <span class="nf">buildRules</span><span class="p">(</span><span class="nx">RulesChecker</span> <span class="nv">$rules</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// Ajoute des règles de  validation</span>
    <span class="nv">$rules</span><span class="o">-&gt;</span><span class="na">add</span><span class="p">(</span><span class="k">function</span> <span class="p">(</span><span class="nv">$entity</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$data</span> <span class="o">=</span> <span class="nv">$entity</span><span class="o">-&gt;</span><span class="na">extract</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">schema</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">columns</span><span class="p">(),</span> <span class="k">true</span><span class="p">);</span>
        <span class="nv">$validator</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">validator</span><span class="p">(</span><span class="s1">&#39;default&#39;</span><span class="p">);</span>
        <span class="nv">$errors</span> <span class="o">=</span> <span class="nv">$validator</span><span class="o">-&gt;</span><span class="na">errors</span><span class="p">(</span><span class="nv">$data</span><span class="p">,</span> <span class="nv">$entity</span><span class="o">-&gt;</span><span class="na">isNew</span><span class="p">());</span>
        <span class="nv">$entity</span><span class="o">-&gt;</span><span class="na">errors</span><span class="p">(</span><span class="nv">$errors</span><span class="p">);</span>

        <span class="k">return</span> <span class="k">empty</span><span class="p">(</span><span class="nv">$errors</span><span class="p">);</span>
    <span class="p">});</span>

    <span class="o">...</span>

    <span class="k">return</span> <span class="nv">$rules</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Lors de l&#8217;exécution du code suivant, la sauvegarde échouera grâce à la nouvelle
règle d&#8217;application qui a été ajoutée:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="nv">$userEntity</span><span class="o">-&gt;</span><span class="na">email</span> <span class="o">=</span> <span class="s1">&#39;Pas un email!!!&#39;</span><span class="p">;</span>
<span class="nv">$usersTable</span><span class="o">-&gt;</span><span class="na">save</span><span class="p">(</span><span class="nv">$userEntity</span><span class="p">);</span>
<span class="nv">$userEntity</span><span class="o">-&gt;</span><span class="na">errors</span><span class="p">(</span><span class="s1">&#39;email&#39;</span><span class="p">);</span> <span class="c1">// Email invalide</span>
</pre></div>
</div>
<p>le même résultat est attendu lors de l&#8217;utilisation de <code class="docutils literal"><span class="pre">newEntity()</span></code> ou
<code class="docutils literal"><span class="pre">patchEntity()</span></code>:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="nv">$userEntity</span> <span class="o">=</span> <span class="nv">$usersTable</span><span class="o">-&gt;</span><span class="na">newEntity</span><span class="p">([</span><span class="s1">&#39;email&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Pas un email!!&#39;</span><span class="p">]);</span>
<span class="nv">$userEntity</span><span class="o">-&gt;</span><span class="na">errors</span><span class="p">(</span><span class="s1">&#39;email&#39;</span><span class="p">);</span> <span class="c1">// Email invalide</span>
</pre></div>
</div>
</div>
</div>


            </div>
        </div>

        
        <div class="col-md-3 col-md-pull-9 hidden-xs hidden-sm" lang="fr">
            <aside class="sidebar">
                <div class="mb30 row">
<div id="sidebar-navigation" class="hidden-xs">
	<p class="caption"><span class="caption-text">Préface</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../intro.html">CakePHP en un Coup d&#8217;Oeil</a></li>
<li class="toctree-l1"><a class="reference internal" href="../quickstart.html">Guide de Démarrage Rapide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../appendices/3-x-migration-guide.html">3.x Guide de Migration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials-and-examples.html">Tutoriels et exemples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../contributing.html">Contribuer</a></li>
</ul>
<p class="caption"><span class="caption-text">Pour Commencer</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../development/configuration.html">Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../development/routing.html">Routing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../controllers/request-response.html">Les Objets Request &amp; Response</a></li>
<li class="toctree-l1"><a class="reference internal" href="../controllers/middleware.html">Middleware</a></li>
<li class="toctree-l1"><a class="reference internal" href="../controllers.html">Controllers (Contrôleurs)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../views.html">Views (Vues)</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../orm.html">Accès Base de Données &amp; ORM</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="database-basics.html">Notions de Base de Base de Données</a></li>
<li class="toctree-l2"><a class="reference internal" href="query-builder.html">Query Builder</a></li>
<li class="toctree-l2"><a class="reference internal" href="table-objects.html">Les Objets Table</a></li>
<li class="toctree-l2"><a class="reference internal" href="entities.html">Entities</a></li>
<li class="toctree-l2"><a class="reference internal" href="retrieving-data-and-resultsets.html">Récupérer les Données et les Ensembles de Résultats</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Valider des Données</a></li>
<li class="toctree-l2"><a class="reference internal" href="saving-data.html">Sauvegarder les Données</a></li>
<li class="toctree-l2"><a class="reference internal" href="deleting-data.html">Supprimer des Données</a></li>
<li class="toctree-l2"><a class="reference internal" href="associations.html">Associations - Lier les Tables Ensemble</a></li>
<li class="toctree-l2"><a class="reference internal" href="behaviors.html">Behaviors (Comportements)</a></li>
<li class="toctree-l2"><a class="reference internal" href="schema-system.html">Système de Schéma</a></li>
<li class="toctree-l2"><a class="reference internal" href="../console-and-shells/orm-cache.html">Shell du Cache de l&#8217;ORM</a></li>
</ul>
</li>
</ul>
<p class="caption"><span class="caption-text">Généralités</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../controllers/components/authentication.html">Authentification</a></li>
<li class="toctree-l1"><a class="reference internal" href="../bake.html">Console Bake</a></li>
<li class="toctree-l1"><a class="reference internal" href="../core-libraries/caching.html">La mise en cache</a></li>
<li class="toctree-l1"><a class="reference internal" href="../console-and-shells.html">Outils de Console, Shells, &amp; Tasks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../development/debugging.html">Debugger</a></li>
<li class="toctree-l1"><a class="reference internal" href="../deployment.html">Déploiement</a></li>
<li class="toctree-l1"><a class="reference internal" href="../core-libraries/email.html">Email</a></li>
<li class="toctree-l1"><a class="reference internal" href="../development/errors.html">Gestion des Erreurs &amp; Exceptions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../core-libraries/events.html">Événements système</a></li>
<li class="toctree-l1"><a class="reference internal" href="../core-libraries/internationalization-and-localization.html">Internationalisation &amp; Localisation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../core-libraries/logging.html">Journalisation (logging)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../core-libraries/form.html">Formulaires Sans Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../controllers/components/pagination.html">Pagination</a></li>
<li class="toctree-l1"><a class="reference internal" href="../plugins.html">Plugins</a></li>
<li class="toctree-l1"><a class="reference internal" href="../development/rest.html">REST</a></li>
<li class="toctree-l1"><a class="reference internal" href="../security.html">Sécurité</a></li>
<li class="toctree-l1"><a class="reference internal" href="../development/sessions.html">Sessions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../development/testing.html">Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../core-libraries/validation.html">Validation</a></li>
</ul>
<p class="caption"><span class="caption-text">Utilitaires</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../core-libraries/app.html">Classe App</a></li>
<li class="toctree-l1"><a class="reference internal" href="../core-libraries/collections.html">Collections</a></li>
<li class="toctree-l1"><a class="reference internal" href="../core-libraries/file-folder.html">Folder &amp; File</a></li>
<li class="toctree-l1"><a class="reference internal" href="../core-libraries/hash.html">Hash</a></li>
<li class="toctree-l1"><a class="reference internal" href="../core-libraries/httpclient.html">Client Http</a></li>
<li class="toctree-l1"><a class="reference internal" href="../core-libraries/inflector.html">Inflector</a></li>
<li class="toctree-l1"><a class="reference internal" href="../core-libraries/number.html">Number</a></li>
<li class="toctree-l1"><a class="reference internal" href="../core-libraries/registry-objects.html">Objets Registry</a></li>
<li class="toctree-l1"><a class="reference internal" href="../core-libraries/text.html">Text</a></li>
<li class="toctree-l1"><a class="reference internal" href="../core-libraries/time.html">Date &amp; Time</a></li>
<li class="toctree-l1"><a class="reference internal" href="../core-libraries/xml.html">Xml</a></li>
</ul>
<p class="caption"><span class="caption-text">Divers</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../core-libraries/global-constants-and-functions.html">Globales &amp; Fonctions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../chronos.html">Chronos</a></li>
<li class="toctree-l1"><a class="reference internal" href="../debug-kit.html">Debug Kit</a></li>
<li class="toctree-l1"><a class="reference internal" href="../migrations.html">Migrations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../elasticsearch.html">ElasticSearch</a></li>
<li class="toctree-l1"><a class="reference internal" href="../upgrade-tool.html">Outil d&#8217;Upgrade</a></li>
<li class="toctree-l1"><a class="reference internal" href="../appendices.html">Annexes</a></li>
</ul>

</div>

                </div>
            </aside>
            <aside class="sidebar">
                <div class="mb30 row">
                </div>
            </aside>
        </div>
    </div>
</div>

<section id="socials" class="back-3">
    <div class="container-fluid">
        <div class="row">
            <div class="col-xs-12 col-sm-12 col-md-5  social text-center">
                <div class="col-sm-3 col-xs-3">
                    <div id="fb-root"></div>
                        <script>(function(d, s, id) {
                          var js, fjs = d.getElementsByTagName(s)[0];
                          if (d.getElementById(id)) return;
                          js = d.createElement(s); js.id = id;
                          js.src = "//connect.facebook.net/en_US/sdk.js#xfbml=1&version=v2.5";
                          fjs.parentNode.insertBefore(js, fjs);
                        }(document, 'script', 'facebook-jssdk'));
                        </script>
                        <div id="fb-root-face" class="fb-like" data-href="https://www.facebook.com/CakePHP/" data-layout="button_count" data-action="like" data-show-faces="true" data-share="false"></div>
                </div>

                <div class="col-sm-3 col-xs-3">
                    <iframe src="https://ghbtns.com/github-btn.html?user=cakephp&amp;repo=cakephp&amp;type=star&amp;count=true&amp;size=small" frameborder="0" scrolling="0" width="120px" height="30px"></iframe>
                </div>

                <div class="col-sm-3 col-xs-3">
                    <iframe src="https://ghbtns.com/github-btn.html?user=cakephp&amp;repo=cakephp&amp;type=fork&amp;count=true&amp;size=small" frameborder="0" scrolling="0" width="120px" height="30px"></iframe>
                </div>

                <div class="col-sm-3 col-xs-3">
                    <a href="https://twitter.com/CakePHP" class="twitter-follow-button" data-show-count="false" data-show-screen-name="false">Follow @CakePHP</a>
                    <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
                </div>
            </div>

            <div class="col-xs-12 col-sm-12 col-md-7 social-footer text-center ">
                <a href="https://twitter.com/cakephp" data-toggle="tooltip" title="Twitter"><i class="fa icon-social fa-twitter"></i>
                <a href="https://www.facebook.com/groups/cake.community" data-toggle="tooltip" title="Facebook"><i class="fa icon-social fa-facebook"></i></a>
                <a href="https://goo.gl/mSC0s" data-toggle="tooltip" title="Google Plus"><i class="fa icon-social  fa-google-plus"></i></a>
                <a href="https://www.youtube.com/user/CakePHP" data-toggle="tooltip" title="Youtube"><i class="fa icon-social fa-youtube-play"></i></a>
                <a href="https://github.com/cakephp" data-toggle="tooltip" title="Github"><i class="fa icon-social fa-git"></i></a>
                <a href="https://cakesf.herokuapp.com/" target="_blank" title="Slack" data-toggle="tooltip"><i class="fa fa-slack icon-social"></i></a>
                <a href="https://stackoverflow.com/tags/cakephp" data-toggle="tooltip" title="Stack Overflow"><i class="fa icon-social fa-stack-overflow"></i></a>
                <a href="https://webchat.freenode.net/?channels=cakephp" data-toggle="tooltip" title="IRC" class="icon-irc">#IRC</a>
            </div>
        </div>
    </div>
</section>

<footer id="footer" class="footer-wrapper">
    <div class="container">

        <div class="row col-p30">
            <div class="col-sm-12 col-md-3">
                <div class="footer-widget t-footer">
                    <div class="col-md-12">
                        <a href="https://www.openhub.net/p/cakephp">
                            <img src="../_static/open-hub.png">
                        </a>
                        <div class="mt10">
                            <a href="https://www.rackspace.com/">
                                <img src="../_static/rackspace.png">
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-sm-12 col-md-9">
                <div class="col-md-3 col-sm-6 business-solution">
                    <ul class="footer-menu">
                        <li class="menu-title">
    <a href="https://cakephp.org/business-solutions"><i class="fa fa-menu-title fa-briefcase"></i>Business Solutions</a>
</li>
<li class="menu-title mt30">
    <a href="https://cakephp.org/showcase"><i class="fa fa-menu-title fa-desktop"></i>Showcase</a>
</li>
                    </ul>
                </div>

                <div class="col-md-3 col-sm-6">
                    <ul class="footer-menu">
                        
<li class="menu-title">
	<i class="fa fa-menu-title fa-book"></i>Documentation
</li>

<li><a href="https://book.cakephp.org"><i class="fa fa-menu fa-chevron-right"></i>Book</a></li>
<li><a href="https://api.cakephp.org"><i class="fa fa-menu fa-chevron-right"></i>API</a></li>

<li><a href="https://cakephp.org/documentation/videos"><i class="fa fa-menu fa-chevron-right"></i>Videos</a></li>
<li><a href="https://cakephp.org/privacy"><i class="fa fa-menu fa-chevron-right"></i>Privacy Policy</a></li>
<li><a href="https://cakephp.org/pages/trademark"><i class="fa fa-menu fa-chevron-right"></i>Logos &amp; Trademarks</a></li>
                    </ul>
                </div>

                <div class="col-md-3 col-sm-6">
                    <ul class="footer-menu">
                        
<li class="menu-title"><i class="fa fa-menu-title fa-users"></i>Community</li>

<li><a href="https://cakephp.org/team"><i class="fa fa-menu fa-chevron-right"></i>Team</a></li>
<li><a href="https://github.com/cakephp/cakephp/issues"><i class="fa fa-menu fa-chevron-right"></i>Issues (Github)</a></li>
<li><a href="https://www.youtube.com/user/CakePHP"><i class="fa fa-menu fa-chevron-right"></i>YouTube Channel</a></li>
<li><a href="https://cakephp.org/get-involved"><i class="fa fa-menu fa-chevron-right"></i>Get Involved</a></li>

<li><a href="https://bakery.cakephp.org"><i class="fa fa-menu fa-chevron-right"></i>Bakery</a></li>
<li><a href="https://github.com/FriendsOfCake/awesome-cakephp"><i class="fa fa-menu fa-chevron-right"></i>Featured Resources</a></li>
<li><a href="https://cakephp.org/newsletter/signup"><i class="fa fa-menu fa-chevron-right"></i>Newsletter</a></li>
<li><a href="http://certification.cakephp.org"><i class="fa fa-menu fa-chevron-right"></i>Certification</a></li>
<li><a href="http://my.cakephp.org"><i class="fa fa-menu fa-chevron-right"></i>My CakePHP</a></li>
<li><a href="http://cakefest.org"><i class="fa fa-menu fa-chevron-right"></i>CakeFest</a></li>
<li><a href="https://www.facebook.com/groups/cake.community"><i class="fa fa-menu fa-chevron-right"></i>Facebook</a></li>
<li><a href="https://twitter.com/cakephp"><i class="fa fa-menu fa-chevron-right"></i>Twitter</a></li>
                    </ul>
                </div>

                <div class="col-md-3 col-sm-6">
                    <ul class="footer-menu">
                        
<li class="menu-title"><i class="fa fa-menu-title fa-comments-o"></i>Help &amp; Support</li>

<li><a href="http://discourse.cakephp.org"><i class="fa fa-menu fa-chevron-right"></i>Forum</a></li>
<li><a href="https://stackoverflow.com/tags/cakephp"><i class="fa fa-menu fa-chevron-right"></i>Stack Overflow</a></li>
<li><a href="https://webchat.freenode.net/?channels=cakephp"><i class="fa fa-menu fa-chevron-right"></i>IRC</a></li>
<li><a href="https://cakesf.herokuapp.com/"><i class="fa fa-menu fa-chevron-right"></i>Slack</a></li>
<li><a href="https://www.cakedc.com/"><i class="fa fa-menu fa-chevron-right"></i>Paid Support</a></li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-12 text-center mt30">
                <p class="copyright">
                            &copy; Copyright 2017, Cake Software Foundation, Inc.
                        Mis à jour le août 30, 2017.
                        Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.4.5.
                </p>
            </div>
        </div>
    </div>
</footer>

<div id="inline-search-results"></div>


</div>

<script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-743287-3']);
    _gaq.push(['_trackPageview']);
    (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
</script>
  </body>
</html>